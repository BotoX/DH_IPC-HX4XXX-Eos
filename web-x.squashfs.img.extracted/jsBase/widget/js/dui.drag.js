!function(a){a.widget("dui.drag",{version:"1.0.1",widgetName:"drag",widgetEventPrefix:"drag",options:{dragElements:null,grid:!1,modifiers:{x:"left",y:"top"},size:!1,position:!1,distance:!1,autoReset:!1,overlay:!0,showSelect:!1,resize:!1,resizeDirections:["resize-left","resize-left-top","resize-top","resize-top-right","resize-right","resize-right-bottom","resize-bottom","resize-bottom-left"],limit:!1,unit:"px"},_create:function(){var b=this,c=this.options.dragElements;this.dragElements=null===c?this.element.children():this.element.children(c),this.doc=a(this.element[0].ownerDocument),this.mouse={now:{},pos:{}},this.value={now:{}},this.firstPosition=[],this.element.css("position","relative"),this.dragElements.css("position","absolute").each(function(c,d){b._setPostion.call(b,a(d),c),b._setSize.call(b,a(d),c)}),this._setupEvents(),this.selection=a.browser.Engine.trident?"selectstart":"mousedown",this.options.showSelect&&this.options.resize&&this.dragElements.delegate(".resize-left,.resize-left-top,.resize-top,.resize-top-right,.resize-right,.resize-right-bottom,.resize-bottom,.resize-bottom-left","mousedown",function(c){var d=a(this);b.target=d.parent();var e={left:c.pageX,top:c.pageY};b._on(b.doc,{mousemove:function(a){for(var c={left:a.pageX,top:a.pageY},f=d.attr("value").split("-"),g=1;g<f.length;g++)b._setResize(e,c,f[g]);e.left=a.pageX,e.top=a.pageY,a.stopPropagation()}}),b._on(b.doc,{mouseup:function(a){b.dragElements.find(".resize-left,.resize-left-top,.resize-top,.resize-top-right,.resize-right,.resize-right-bottom,.resize-bottom,.resize-bottom-left").off("mousemove"),b._off(b.doc,"mousemove"),b._off(b.doc,"mouseup"),a.stopPropagation()}}),c.stopPropagation()})},_setPostion:function(b,c){var d=this.options.position,e=a.type(d);if("object"==e)position={left:parseInt(d.left),top:parseInt(d.top)};else if("array"==e)if("center"==d[c]){var f=(this.element.width()-b.outerWidth(!0))/2,g=(this.element.height()-b.outerHeight(!0))/2;position={left:parseInt(f),top:parseInt(g)}}else position={left:parseInt(d[c].left),top:parseInt(d[c].top)};else if("string"==e){if("center"==d){var f=(this.element.width()-b.outerWidth(!0))/2,g=(this.element.height()-b.outerHeight(!0))/2;position={left:parseInt(f),top:parseInt(g)}}}else position=b.position();this.firstPosition[b.index()]=position,b.css(position)},_setSize:function(a,b){var c=this.options.size;c!==!1&&a.css(c[b])},_setupEvents:function(){this._on(this.dragElements,{mousedown:this._start})},_start:function(b){this._trigger("beforeStart",b,{ui:this});var c,d=this.options.modifiers,e={x:b.pageX,y:b.pageY};this.mouse.start=e,this.target=a(b.currentTarget),this.options.showSelect&&this._showCurrentSelect();for(c in d)this.value.now[c]=parseInt(this.target.css(d[c])),this.mouse.pos[c]=e[c]-this.value.now[c];"number"==a.type(this.options.grid)&&(this.options.grid={x:this.options.grid,y:this.options.grid});var f={mousemove:this._drag,mouseup:this._stop};f[this.selection]=function(){return!1},this._on(this.doc,f),this._addDrapLimit(),this._trigger("start",b,{ui:this})},_addDrapLimit:function(){var b=this.target,c=this.element,d={};a.each(["left","top"],function(a,b){d[b]=parseInt(c.css("padding-"+b))});var e=c.width(),f=c.height(),g=b.outerWidth(!0),h=b.outerHeight(!0),i=d.left,j=d.top,k=[i,i+e-g],l=[j,j+f-h],m=this.options.limit;m&&(-1!==a.inArray("x",m)&&(k=[this.firstPosition[b.index()].left,this.firstPosition[b.index()].left]),-1!==a.inArray("y",m)&&(l=[this.firstPosition[b.index()].top,this.firstPosition[b.index()].top])),this.limit={x:k,y:l}},_getMouseMove:function(){var a=this.mouse;this.move=Math.round(Math.sqrt(Math.pow(a.now.x-a.start.x,2)+Math.pow(a.now.y-a.start.y,2)))},_checkDistance:function(){var a=(this.mouse,this.move);return this.options.distance?a<=this.options.distance:!0},_fixValue:function(){var a=this.options.distance,b=this.mouse;if(a){var c=this.move,d=(b.now.x-b.start.x)*a/c,e=(b.now.y-b.start.y)*a/c,f=this.firstPosition[this.target.index()].left,g=this.firstPosition[this.target.index()].top;this.value.now={x:d+f,y:e+g}}},_showCurrentSelect:function(){var b=this;this.dragElements.find(".resize-left,.resize-left-top,.resize-top,.resize-top-right,.resize-right,.resize-right-bottom,.resize-bottom,.resize-bottom-left").remove(),a.each(this.options.resizeDirections,function(c,d){var e=a('<div value="'+d+'" class="'+d+'"></div>');b.options.resize||e.css("cursor","default"),b.target.append(e)})},_setResize:function(a,b,c){var d=this;switch(c){case"left":if(b.left-a.left<0){if(!d.options.overlay&&d._checkOverlay("left",d.target.position().left+b.left-a.left))break;b.left-a.left+d.target.position().left<0?(d.target.width(d.target.width()+d.target.position().left),d.target.css("left",0)):b.left-a.left+d.target.position().left>0&&(d.target.css("left",b.left-a.left+d.target.position().left),d.target.width(d.target.width()+Math.abs(b.left-a.left)))}else b.left-a.left>0&&a.left-b.left+d.target.width()>0&&(d.target.css("left",b.left-a.left+d.target.position().left),d.target.width(d.target.width()-Math.abs(b.left-a.left)));break;case"top":if(b.top-a.top<0){if(!d.options.overlay&&d._checkOverlay("top",d.target.position().top+b.top-a.top))break;b.top-a.top+d.target.position().top<0?(d.target.height(d.target.height()+d.target.position().top),d.target.css("top",0)):b.top-a.top+d.target.position().top>0&&(d.target.css("top",b.top-a.top+d.target.position().top),d.target.height(d.target.height()+Math.abs(b.top-a.top)))}else b.top-a.top>0&&a.top-b.top+d.target.height()>0&&(d.target.css("top",b.top-a.top+d.target.position().top),d.target.height(d.target.height()-Math.abs(b.top-a.top)));break;case"right":if(b.left-a.left<0)b.left-a.left+d.target.width()>0&&d.target.width(d.target.width()+b.left-a.left);else if(b.left-a.left>0){if(!d.options.overlay&&d._checkOverlay("left",d.target.position().left+b.left-a.left))break;d.target.width(b.left-a.left+d.target.width()+d.target.position().left<d.target.parent().width()?d.target.width()+b.left-a.left:d.target.parent().width()-d.target.position().left)}break;case"bottom":if(b.top-a.top<0)b.top-a.top+d.target.height()>0&&d.target.height(d.target.height()+b.top-a.top);else if(b.top-a.top>0){if(!d.options.overlay&&d._checkOverlay("top",d.target.position().top+b.top-a.top))break;d.target.height(b.top-a.top+d.target.height()+d.target.position().top<d.target.parent().height()?d.target.height()+b.top-a.top:d.target.parent().height()-d.target.position().top)}}},_isRectangleIntersect:function(a,b){var c=[(a[0]+a[0]+a[2])/2,(a[1]+a[1]+a[3])/2],d=[(b[0]+b[0]+b[2])/2,(b[1]+b[1]+b[3])/2];return 2*Math.abs(c[0]-d[0])<a[2]+b[2]&&2*Math.abs(c[1]-d[1])<a[3]+b[3]},_checkOverlay:function(a,b){var c=(this.target,this.target.siblings()),d=[this.target.position().left,this.target.position().top,this.target.width(),this.target.height()];"left"==a&&(d[0]=b),"top"==a&&(d[1]=b);for(var e=c.length-1;e>=0;e--){var f=c.eq(e),g=[f.position().left,f.position().top,f.width(),f.height()];if(this._isRectangleIntersect(d,g))return f}return!1},_drag:function(a){var b,c=this.options.modifiers,d={x:a.pageX,y:a.pageY};this.mouse.now=d,this._getMouseMove();for(b in c)if(this.value.now[b]=this._checkRange(this.mouse.now[b]-this.mouse.pos[b],b),this.options.grid&&this.options.grid[b]&&(this.value.now[b]-=this.value.now[b]%this.options.grid[b]),this._checkDistance()||this._fixValue(),this.options.overlay)this.target.css(c[b],this.value.now[b]+this.options.unit);else{var e=this._checkOverlay(c[b],this.value.now[b]);if(e){var f=this.value.now[b]-this.target.position()[c[b]],g="left"==c[b]?this.target.width():this.target.height(),h="left"==c[b]?e.width():e.height(),i=f>0?e.position()[c[b]]-g:e.position()[c[b]]+h;i=this._checkRange(i,b),!this._checkOverlay(c[b],i)&&this.target.css(c[b],i)}else this.target.css(c[b],this.value.now[b]+this.options.unit)}this._trigger("drag",a,{ui:this,position:this.value.now,firstPosition:{x:this.firstPosition[this.target.index()].left,y:this.firstPosition[this.target.index()].top}})},_checkRange:function(a,b){var c=this.limit[b];return c&&(a>c[1]?a=c[1]:a<c[0]&&(a=c[0])),a},_stop:function(a){this._off(this.doc,"mousemove"),this._off(this.doc,"mouseup"),this._off(this.doc,this.selection),this._trigger("stop",a,{ui:this}),this.options.autoReset&&this.target.css(this.firstPosition[this.target.index()])},getCurrent:function(){return this.target||a()}})}(jQuery);