!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab"),b.exports.prototype.iss_ipc=-1===webApp.DeviceType.indexOf("SD"),b.exports.prototype.iss_sd=-1!==webApp.DeviceType.indexOf("SD")}),define("iss_ipc",function(require,b,c){var d=require("jsCore/pageBase"),e=require("jsCore/rpc");require("widget/js/dui.iconlist"),require("widget/js/dui.iconSelect");var f,g,h,i,j,k=0;c.exports=d.extend({init:function(){h=this,webApp.CHANNEL_NUMBER>1&&(a("#iExc_channel").parent().removeClass("fn-hide"),a("#iExc_channel").parent().next("div").removeClass("fn-hide"),$channel=a("#iExc_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){k=b.ch,h.renderElement(),-1!==webApp.DeviceType.indexOf("TPC")&&1===k?h.$('[data-sch="FaceDetection"]').parent().hide():h.$('[data-sch="FaceDetection"]').parent().is(":hidden")&&h.$('[data-sch="FaceDetection"]').parent().show()}}),$channel.iconSelect("index",k)),f=[],ability.get("IVSCaps").done(function(a){for(var b in a.SupportedScenes)f.push(b);h.initTemplate(f),g=a.SupportedComp||[]}),e.VideoInAnalyse.getTemplateGlobal().done(function(a){j=a,-1!==webApp.DeviceType.indexOf("TPC")&&(j.Scene.Type=null)}),h.render()},render:function(){g_videoInConflict.DSP.hasConflict().then(function(){h.tip("warning","dspTvoutConflict")}),h.onRefresh(!1)},initTemplate:function(b){var c=h.$(".ivsSche"),d={Normal:"w_IVS_Analyse",FaceDetection:"w_faceDetection",NumberStat:"w_flowrate",NumberStatPlan:"w_flowrate",HeatMap:"HeatMap",Track:"Track",Traffic:"Traffic",VideoDiagnosis:"VideoDiagnosis",WideView:"WideView",Gate:"Gate",SCR:"ShootingScoreRecognition"};c.empty();for(var e=0;e<b.length;e++)c.append('<li><div class="img '+b[e]+'" data-sch="'+b[e]+'"></div><span class="tip" t="'+d[b[e]]+";title::"+d[b[e]]+'"></span></li>');c.translation(),c.on("click",function(b){h.onChooseIvs(a(b.target))})},onChooseIvs:function(a){return a.hasClass("disable")||!a.attr("data-sch")?!1:(a.toggleClass("select"),void h._checkDisable())},_checkDisable:function(){var b=[],c=h.$(".ivsSche .select");a.each(c,function(c,d){b.push(a(d).attr("data-sch"))});for(var d=[],e=0;e<g.length;e++)h.arrInclude(g[e],b)&&(d=d.concat(g[e]));a.each(f,function(b,c){-1===a.inArray(c,d)?h.$('[data-sch="'+c+'"]').addClass("disable"):h.$('[data-sch="'+c+'"]').removeClass("disable")})},arrInclude:function(b,c){var d=!0;return a.each(c,function(c,e){-1===a.inArray(e,b)&&(d=!1)}),d},renderElement:function(){i[k]&&i[k].Scene||(i[k]=jQuery.extend(!0,{},j)),i[k].Scene.TypeList||(i[k].Scene.TypeList=[]);var b=i[k].Scene.TypeList;b.push(i[k].Scene.Type),h.$(".ivsSche [data-sch]").removeClass("select").removeClass("disable"),a.each(b,function(a,b){h.$('.ivsSche [data-sch="'+b+'"]').addClass("select")}),h._checkDisable()},saveElement:function(){i[k].Scene.TypeList||(i[k].Scene.TypeList=[]);var b=[],c=h.$(".ivsSche .select");return 0==c.length?(i[k].Scene.Type=null,void(i[k].Scene.TypeList=null)):(a.each(c,function(c,d){b.push(a(d).attr("data-sch"))}),i[k].Scene.Type=b.shift(),i[k].Scene.TypeList=0!==b.length?b:null,void(i[k].Scene.PtzPresetId=0))},onDefault:function(){e.ConfigManager.getDefault("VideoAnalyseGlobal").done(function(a){i=a,h.renderElement(),h.tip("success","Defaultsuccess")}).fail(function(){h.tip("error","Defaultfailure")})},onRefresh:function(a){e.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(b){i=b,h.renderElement(),a!==!1&&h.tip("success","Operateingsuccess")}).fail(function(){h.tip("error","Operateingfailure")})},onSave:function(){h.saveElement(),e.ConfigManager.setConfig("VideoAnalyseGlobal",i).done(function(){h.tip("success","Succeed in saving configure")}).fail(function(){h.tip("error","Saving failure")})},leave:function(){}})}),define("iss_sd",function(require,b,c){var d=require("jsCore/pageBase"),e=require("jsCore/rpc");require("widget/js/dui.iconlist"),require("widget/js/dui.iconSelect");var f,g,h,i,j,k,l,m=0,n=null;c.exports=d.extend({init:function(){i=this,webApp.CHANNEL_NUMBER>1&&(a("#iExc_channel").parent().removeClass("fn-hide"),a("#iExc_channel").parent().next("div").removeClass("fn-hide"),n=a("#iExc_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){m=b.ch,i.renderElement()}}),n.iconSelect("index",m)),j=i.$('[data-list="scheme"]'),f=[],l=[],ability.get("IVSCaps").done(function(b){for(var c in b.SupportedScenes)f.push(c),"SDFaceDetect"!=c&&l.push(c);g=b.SupportedComp||[],a.each(g,function(a,b){g[a]=i.protocolChange(b)}),-1!==f.indexOf("HeatMapPlan")&&-1!==f.indexOf("NumberStatPlan")&&(a('div[data-cap="HeatMap"]').addClass("fn-hide"),a('div[data-cap="HeatNumber"]').removeClass("fn-hide"),f.splice(f.indexOf("NumberStatPlan"),1)),-1===f.indexOf("HeatMapPlan")?i.$('[data-cap="HeatMap"]').remove():f.splice(f.indexOf("HeatMapPlan"),1)}),e.VideoInAnalyse.getTemplateGlobal().done(function(a){k=a,k.Scene.Detail.Lanes=[],-1!==webApp.DeviceType.indexOf("TPC")&&(k.Scene.Type=null)}),i.bind(),i.render()},render:function(){g_videoInConflict.DSP.hasConflict().then(function(){i.tip("warning","dspTvoutConflict")}),e.PTZ.getPresets().done(function(b){var c=i.$('[data-list="presets"]').empty();b&&a.each(b,function(a,b){c.append('<li title="'+b.Name+'" value="'+b.Index+'">'+b.Name+"</li>")}),i.presets=b||[],i.onRefresh(!1)})},protocolChange:function(a,b){return b?(-1!==a.indexOf("FaceDetection")&&a.splice(a.indexOf("FaceDetection"),1,"SDFaceDetect"),-1!==a.indexOf("HeatMap")&&a.splice(a.indexOf("HeatMap"),1,"HeatMapPlan"),-1!==a.indexOf("NumberStat")&&a.splice(a.indexOf("NumberStat"),1,"NumberStatPlan")):(-1!==a.indexOf("SDFaceDetect")&&a.splice(a.indexOf("SDFaceDetect"),1,"FaceDetection"),-1!==a.indexOf("HeatMapPlan")&&a.splice(a.indexOf("HeatMapPlan"),1,"HeatMap"),-1!==a.indexOf("NumberStatPlan")&&a.splice(a.indexOf("NumberStatPlan"),1,"NumberStat")),a},bind:function(){i.$('ul[data-list="presets"]').on("click",function(b){if(j.data("heatmapPlan")!==!0){var c=a(b.target).val();if(void 0==i.$('[data-presetId="'+c+'"]').attr("data-global")){var d="";for(var e in h[m])-1!==e.indexOf("Scene")&&(d+=e);for(var f,g=0;255>g&&(f="Scene"+(0==g?"":g),-1!==d.indexOf(f));g++);var l=f.replace("Scene","CalibrateArea");h[m][f]=jQuery.extend(!0,{},k.Scene),h[m][l]=null!==k.CalibrateArea?jQuery.extend(!0,{},k.CalibrateArea):null,h[m][f].PtzPresetId=c,i.addShe(f)}i.$('div[data-list="preset"]').removeClass("select")}}),j.on("click",function(b){if(j.data("heatmapPlan")!==!0){var c=a(b.target);switch(c.attr("data-for")){case"choose":i.onChooseIvs(c),i.checkDisable(c.parents("[data-global]"));break;case"del":i.delShe(c.parents("[data-global]").attr("data-global"))}}}),i.element.on("click",function(){i.$('div[data-list="preset"]').removeClass("select")}),i.$("a[data-css]").on("click",function(b){var c=a(b.target).attr("data-css"),d=a(b.target).parent().hasClass("alarmconfig-flashbtn-on");"on"==c&&d||"off"==c&&!d||("on"==c?(a(b.target).parent().addClass("alarmconfig-flashbtn-on"),j.addClass("heatmapPlan").data("heatmapPlan",!0),i.$('a[btn-for="selectPreset"]').addClass("ui-button-disabled"),i.$('div[data-cap="HeatNumber"]').removeClass("heatmapPlan"),i.$("#heatNumberWrap div[data-sch]").removeClass("disable").removeClass("select"),i.$('div[data-for="choose"]').addClass("disable"),i.addHeatmapGlobal()):(a(b.target).parent().removeClass("alarmconfig-flashbtn-on"),j.removeClass("heatmapPlan").data("heatmapPlan",!1),i.$('a[btn-for="selectPreset"]').removeClass("ui-button-disabled"),i.$('div[data-cap="HeatNumber"]').addClass("heatmapPlan"),i.delHeatmapGlobal(),i.$("#heatNumberWrap").find("div.select").removeClass("select"),i.$('div[data-for="choose"]').hasClass("select")?i.$("div[data-global]").find("div.select").removeClass("disable"):i.$('div[data-for="choose"]').removeClass("disable")))}),i.$("div[data-sch]").on("click",function(){i.$("div[data-cap]").hasClass("heatmapPlan")||(i.$("#heatNumberWrap div[data-sch]").hasClass("select")?(i.$("div[data-sch]:not(.select)").addClass("disable"),a(this).hasClass("select")&&(a(this).removeClass("select"),i.$("div[data-sch]:not(.select)").removeClass("disable")),i.delHeatmapGlobal()):(a(this).addClass("select"),i.$("div[data-sch]:not(.select)").addClass("disable")))})},addHeatmapGlobal:function(){type=i.$('div[data-cap="HeatNumber"] .select').attr("data-sch")||"HeatMap",type="HeatMap"==type?"HeatMapPlan":type;var a=["","HeatMapPlan","NumberStatPlan",null],b="Scene";for(var c in h[m])if(-1!==c.indexOf("Scene")&&0==h[m][c].PtzPresetId){b=c;break}var d=h[m][b];d.TypeList=d.TypeList||[],d.Type=d.Type||"",-1!==a.indexOf(d.Type)&&d&&d.TypeList.push(d.Type),d.Type=type},delHeatmapGlobal:function(){for(var a in h[m])-1!==a.indexOf("Scene")&&"HeatMapPlan"==h[m][a].Type&&(h[m][a].TypeList=h[m][a].TypeList||[],h[m][a].Type=h[m][a].TypeList.length>0?h[m][a].TypeList.shift():"")},onChooseIvs:function(a){return!a.attr("data-sch")||a.hasClass("disable")?!1:void a.toggleClass("select")},initSheTemplate:function(a,b){a=i.protocolChange(a);var c=h[m][b],d=i.$('[data-template="scheme"]').clone();d.removeClass("fn-hide").removeAttr("data-template"),d.attr("data-global",b).attr("data-presetId",c.PtzPresetId),0==c.PtzPresetId&&d.addClass("fn-hide");for(var e=0;e<i.presets.length;e++)if(i.presets[e].Index==c.PtzPresetId){d.find("label").text(i.presets[e].Name);break}for(var f=d.find("ul"),g={Normal:"w_IVS_Analyse",FaceDetection:"w_faceDetection",SDFaceDetect:"w_faceDetection",NumberStat:"w_flowrate",NumberStatPlan:"w_flowrate",HeatMap:"HeatMap",HeatMapPlan:"HeatMap",Track:"Track",Traffic:"Traffic",VideoDiagnosis:"VideoDiagnosis",WideView:"WideView",Gate:"TrafficTollGate"},e=0;e<a.length;e++)e==a.length-1&&d.css("margin-bottom","35px"),f.append('<li><div data-for="choose" class="img '+a[e]+'" data-sch="'+a[e]+'"></div><span class="tip" t="'+g[a[e]]+";title::"+g[a[e]]+'"></span></li>');f.translation(),d.appendTo(j)},renderShe:function(b){var c=h[m][b],d=i.$('[data-global="'+b+'"]'),e=jQuery.extend(!0,[],c.TypeList);c.Type&&e.push(c.Type),d.find("[data-sch]").removeClass("select").removeClass("disable"),e=i.protocolChange(e),a.each(e,function(a,b){b&&d.find("[data-sch="+b+"]").addClass("select")}),i.checkDisable(d)},checkDisable:function(b){var c=[],d=b.find(".select");a.each(d,function(b,d){c.push(a(d).attr("data-sch"))});for(var e=[],h=0;h<g.length;h++)i.arrInclude(g[h],c)&&(e=e.concat(g[h]));a.each(f,function(c,d){-1===a.inArray(d,e)?b.find('[data-sch="'+d+'"]').addClass("disable"):b.find('[data-sch="'+d+'"]').removeClass("disable")})},arrInclude:function(b,c){var d=!0;return a.each(c,function(c,e){-1===a.inArray(e,b)&&(d=!1)}),d},addShe:function(a){m?i.initSheTemplate(l,a):i.initSheTemplate(f,a),i.renderShe(a)},delShe:function(a){var b=i.$("[data-global="+a+"]");b.remove();var c=a.replace("Scene","CalibrateArea");delete h[m][a],delete h[m][c]},saveShe:function(b){var c={Type:"",TypeList:[]},d=[],e=i.$("[data-global="+b+"] .select");return 0===e.length&&0!==i.$("#heatNumberWrap").find("div.select")&&(e=i.$("#heatNumberWrap").find("div.select")),0!==e.length&&(a.each(e,function(b,c){d.push(a(c).attr("data-sch"))}),d=i.protocolChange(d,!0),c.Type=d.shift(),c.TypeList=0!==d.length?d:[]),c},selectPreset:function(a){return j.data("heatmapPlan")!==!0?(i.$(a.currentTarget).parent().addClass("select"),!1):void 0},renderElement:function(){if(j.empty(),j.css("height","0px"),setTimeout(function(){j.css("height","auto")},100),null==h[m])return void(h[m]={});var b=!1,c=["HeatMapPlan","NumberStatPlan"],d="",e=[];for(var f in h[m])e.push(f);for(var g=a.grep(e,function(a){return-1!==a.indexOf("Scene")}),k=0;k<g.length;k++)0==k?(i.addShe("Scene"),-1!==c.indexOf(h[m].Scene.Type)&&(d=h[m].Scene.Type,b=!0)):(i.addShe("Scene"+k),-1!==c.indexOf(h[m]["Scene"+k].Type)&&(d=h[m]["Scene"+k].Type,b=!0));"HeatMapPlan"==d?d="HeatMap":"NumberStatPlan"==d&&(d="NumberStatPlan"),i.$('div[data-list="preset"]').removeClass("select"),i.$("#heatNumberWrap div[data-sch]").addClass("disable"),i.$('div[data-sch="'+d+'"]').removeClass("disable").addClass("select"),b?(i.$("#iss_sd_heat").addClass("alarmconfig-flashbtn-on"),j.addClass("heatmapPlan").data("heatmapPlan",!0),i.$("#iss_sd_heatNumber").addClass("alarmconfig-flashbtn-on"),i.$('div[data-cap="HeatNumber"]').removeClass("heatmapPlan"),i.$('a[btn-for="selectPreset"]').addClass("ui-button-disabled")):(i.$("#iss_sd_heat").removeClass("alarmconfig-flashbtn-on"),j.removeClass("heatmapPlan").data("heatmapPlan",!1),i.$("#iss_sd_heatNumber").removeClass("alarmconfig-flashbtn-on"),i.$('div[data-cap="HeatNumber"]').addClass("heatmapPlan"),i.$('a[btn-for="selectPreset"]').removeClass("ui-button-disabled"))},saveElement:function(){var a=!1;if(!i.$("#heatNumberWrap").hasClass("fn-hide"))for(var b in h[m])-1!==b.indexOf("Scene")&&(h[m][b].Type="",h[m][b].TypeList=[]);if(0!==i.$("#heatNumberWrap").find("div.select").length){var c=i.saveShe(b);h[m].Scene.Type=c.Type,h[m].Scene.TypeList=c.TypeList,a=!0}else for(var b in h[m])if(-1!==b.indexOf("Scene")){var c=i.saveShe(b);0!==h[m][b].PtzPresetId&&(h[m][b].Type=c.Type,h[m][b].TypeList=c.TypeList),a=!0}a||(h[m]=null)},checkTable:function(b){for(var c=a.extend(!0,{},{}),d=j.children("div[data-global]"),e=["Scene","CalibrateArea","TimePeriod"],f=0;f<d.length;f++){var g="Scene"+(0==f?"":f),h=i.$(d[f]).attr("data-global");a.each(e,function(d,e){var f=g.replace("Scene",e),i=h.replace("Scene",e);switch(a.type(b[i])){case"null":c[f]=null;break;case"undefined":break;case"array":c[f]=a.extend(!0,[],b[i]);break;default:c[f]=a.extend(!0,{},b[i])}}),i.$(d[f]).attr("data-global",g)}return c},onDefault:function(){e.ConfigManager.getDefault("VideoAnalyseGlobal").done(function(a){h=a,i.renderElement(),i.tip("success","Defaultsuccess")}).fail(function(){i.tip("error","Defaultfailure")})},onRefresh:function(a){e.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(b){h=b,i.renderElement(),a!==!1&&i.tip("success","Operateingsuccess")}).fail(function(){i.tip("error","Operateingfailure")})},onSave:function(){i.saveElement(),h[m]=i.checkTable(h[m]),e.ConfigManager.setConfig("VideoAnalyseGlobal",h).done(function(){i.tip("success","Succeed in saving configure"),null==h[m]&&(h[m]={})}).fail(function(){i.tip("error","Saving failure")})},leave:function(){}})})}(jQuery);