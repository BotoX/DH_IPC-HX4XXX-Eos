!function(a){define(function(require,b,c){c.exports=require("jsCore/pageTab");var d=require("jsCore/ability");c.exports.prototype.getCondition=function(){c.exports.prototype.vid_abnormal=a.when(d.get("VideoDetectCaps",!0)).then(function(b){return b&&(!b.UnFocusDetect||b.UnFocusDetect&&webApp.DeviceType.contains("TPC"))&&(a("[data-for=vid_blind][t=w_videoOn]").attr("t","w_Video Shelter").parent().translation(),webApp.DeviceType.contains("TPC")&&webApp.CHANNEL_NUMBER<2&&a("[data-for=vid_blind]").hide()),b&&b.SupportMovedDetect}),c.exports.prototype.vid_blind=webApp.DeviceType.contains("TPC")&&webApp.CHANNEL_NUMBER>1?!0:!1}}),define("vid_motion",function(require,b,c){function d(a){var b,c,d=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,e=0,f="";if(/^(rgb|RGB)/.test(a))for(b=a.replace(/(?:\(|\)|rgb|RGB)*/g,"").split(","),e=b.length-1;e>=0;e--)c=Number(b[e]).toString(16),1===c.length&&(c="0"+c),f+=c;else d.test(a)&&(b=a.replace(/#/,"").split(""),6===b.length&&(f=b[4]+b[5]+b[2]+b[3]+b[0]+b[1]));return 6!==f.length?0:parseInt(f,16)}var e=require("jsCore/rpc"),f=require("jsCore/pageBase"),g=require("jsCore/plugin"),h=require("common/common"),i=require("jsCore/modules/timeSection");require("widget/js/dui.slider"),require("widget/js/dui.figure"),require("jsCore/modules/eventHandler"),require("widget/js/dui.iconlist"),require("widget/js/dui.iconSelect");var j,k,l=null,m=null,n=null,o=null,p=0,q=0,r=0,s=!!isEnable("is_has_detectPic"),t=null;c.exports=f.extend({init:function(){l=this,webApp.CHANNEL_NUMBER>1&&(l.$("#vid_motion_channel").parent().removeClass("fn-hide"),l.$("#vid_motion_channel").parent().next("div").removeClass("fn-hide"),m=a("#vid_motion_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){r=b.ch,l._renderElements()}}),m.iconSelect("index",r)),l.$("#v_m_anti").numberfield({min:0,max:100,allowDecimal:!1,allowNegative:!1}),webApp.EventCaps?e.EventManager.getEventLink("VideoMotion").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[r][0]?d=e:c[r].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),l.$("#v_m_event").eventHandler(d)}).fail(function(){l.$("#v_m_event").eventHandler()}):l.$("#v_m_event").eventHandler(),j=l.$("#v_m_dialog").dialog({confirm:function(a,b){n=o,l._detachData(),b.ui.close()},close:function(){l._detachData()}}).detach().appendTo(document.body),j.dialog("setPosition",[310,615]),j.find("#v_m_sen").slider({complete:function(a,b){o[r].MotionDetectWindow[q].Sensitive=b.value,l._setTempConfig()}}),j.find("#v_m_thr").slider({change:function(a,b){s&&j.find("#v_m_figure").figure("threshold",b.value)},complete:function(a,b){o[r].MotionDetectWindow[q].Threshold=b.value,l._setTempConfig()}}),s&&j.find("#v_m_figure").figure({width:240,equal:1}).parent().show(),j.find("#v_m_region").textfield({validReg:/[:"'{}\[\]<>\\,]/m,validRegRet:!1,errorHandle:"prevent",success:function(){o&&(o[r].MotionDetectWindow[q].Name=a(this).val())}}),j.find(".videodetect-region-item").on("click",function(){q=a(this).data("index"),g.SetCurrentDrawId(q);var b=o[r].MotionDetectWindow[q];a(this).addClass("videodetect-region-current").siblings().removeClass("videodetect-region-current"),j.find("#v_m_region").textfield("value",b.Name),j.find("#v_m_sen").slider("value",b.Sensitive),j.find("#v_m_thr").slider("value",b.Threshold)});var b=ability.get("VideoDetectCaps"),c=ability.get("PtzManualMotionDetect");a.when(b,c).done(function(a,b){t=a?a:{DetectVersion:["V1.0","V3.0"],MotionColumns:22,MotionDetectWindow:4,MotionRows:18},-1===webApp.DeviceType.indexOf("TPC")&&b===!0&&(t.PtzManual=!0,l.$("label[for=v_m_ptz]").parent().show()),l.render()})},initLinking:function(b){var c={InfraredLight:"w_red_light",WhiteLight:"w_white_light",LaserLight:"w_laser_light"};if(k){l.$("#v_light_link").show();var d=b.LinkingDetail.FilckerLighting;l.$("#v_light_duration").numberfield({min:.1*d.FilckerIntevalTime[0],max:.1*d.FilckerIntevalTime[1],allowDecimal:!0,allowNegative:!1}),l.$("#v_light_duration").next("span").next("span").text("("+.1*d.FilckerIntevalTime[0]+"~"+.1*d.FilckerIntevalTime[1]+")"),l.$("#v_light_num").numberfield({min:d.FilckerTimes[0],max:d.FilckerTimes[1],allowDecimal:!1,allowNegative:!1}),l.$("#v_light_num").next("span").next("span").text("("+d.FilckerTimes[0]+"~"+d.FilckerTimes[1]+")");var e=l.$("#v_light_type").empty();a.each(d.LightType,function(a,b){e.append("<option value="+b+" t="+c[b]+"></option>")}),e.translation()}},render:function(){l._getConfig(!1),a(window).on("resize.videoDetect",function(){g.cover("#v_m_detzone")}),e.ConfigManager.getConfig("Lighting").done(function(b){b&&b[r]&&"Linking"===b[r][0].Mode?ability.get("VideoInputCapsEx").done(function(b){b.LightingControl&&(capsLight=b.LightingControl,capsLight.LinkingDetail&&capsLight.LinkingDetail.FilckerLighting&&capsLight.LinkingDetail.FilckerLighting.Ability&&(k=a.isArray("MotionDetect",capsLight.LinkingDetail.FilckerLighting.Ability.SupportEvents)>-1?!0:!1,l.initLinking(capsLight)))}):(l.$("#v_light_link").hide(),k=!1)}),l.$("[cfg=LightLinkEnable]").change(function(a){var b=l.$(a.target),c=b.prop("checked");c?l.$("#v_light_type").parent().parent().show():l.$("#v_light_type").parent().parent().hide()}),l.$("#v_light_duration").change(function(){var a=l.$("#v_light_duration").val()-0;a=Math.round(a)>a?parseInt(a)+.5:Math.round(a)<a?parseInt(a):a,l.$("#v_light_duration").val(a)})},leave:function(){a(window).off("resize.videoDetect")},destory:function(){j.remove()},_getConfig:function(a){e.ConfigManager.getConfig("MotionDetect").done(function(b){n=b,l._renderElements(),a&&l.tip("success","Operateingsuccess"),l.disabled("[btn-for=onConfirm]",!1)}).fail(function(){l.tip("error","Operateingfailure"),l.disabled("[btn-for=onConfirm]",!0)})},_renderElements:function(){var a=n[r];if(t.PtzManual&&l.$("#v_m_ptz").prop("checked",a.PtzManualEnable),l.$("#v_m_enable").prop("checked",a.Enable),l.$("#v_m_anti").numberfield("value",a.EventHandler.Dejitter),l.$("#v_m_event").eventHandler("set",a.EventHandler),k&&a.EventHandler.LightingLink){l.$("#v_light_link_enable").prop("checked",a.EventHandler.LightingLink.Enable),l.$("#v_light_type").val(a.EventHandler.LightingLink.FilckerLightType),l.$("#v_light_duration").numberfield("value",.1*a.EventHandler.LightingLink.FilckerIntevalTime),l.$("#v_light_num").numberfield("value",a.EventHandler.LightingLink.FilckerTimes);var b=l.$("#v_light_link_enable").prop("checked");b?l.$("#v_light_type").parent().parent().show():l.$("#v_light_type").parent().parent().hide()}},setAreaZone:function(){j.dialog("show"),o=a.extend(!0,[],n),s&&(j.find("#v_m_figure").figure("start"),e.DevVideoDetect.attachMotionData(++p%65535),webApp.NotifyVersion?h.devNotify.subscribe("devVideoDetect.notifyMotionData",window.showMotionFigure):l.$("#v_m_frame").attr("src","/cgi-bin/videomotion.cgi?sessionId="+e.getSession()),app.addEvent("RECONNECTION",l._reconnect));var b=o[r].MotionDetectWindow||[],c=[],f=[],i=new Array(t.MotionRows);if(b.length<t.MotionDetectWindow){a.each(b,function(a,b){c.push(b.Id)}),a.each(i,function(a){i[a]=0});for(var k=0;k<t.MotionDetectWindow;k++)-1===a.inArray(k,c)&&b.splice(k,0,{Id:k,Name:"Region "+(k+1),Region:i,Sensitive:isEnable("videodetect_default_sensitive")||58,Threshold:isEnable("videodetect_default_threshold")||4})}o[r].MotionDetectWindow=b,a.each(b,function(a,b){var c=d(j.find(".videodetect-regions a").eq(a).css("background-color"));f.push(b.Id+"@"+c+"-"+b.Region.join(":")),j.find(".videodetect-region-item:eq("+a+")").data("index",b.Id)}),g.cover("#v_m_detzone",function(){g.SetModuleMode(1),webApp.DeviceType.contains("TPC")?(g.SetVisibleVideoWnd(1,r),login.chkAuthority("Monitor_0"+(r+1))&&g.open(g.stream,r,1),!login.chkAuthority("Monitor_0"+(r+1))&&g.SetVideoWndTip(r,tl("noVideoAuthoity"))):g.open(),g.SetGridNum(t.MotionRows,t.MotionColumns),g.SetFuntionInfo("MotionDetect",f.join(" ")),g.SetCurrentDrawId(q)});var m=b[q];j.find("#v_m_region").textfield("value",m.Name),j.find("#v_m_sen").slider("value",m.Sensitive),j.find("#v_m_thr").slider("value",m.Threshold),l._setTempConfig(),g.addEvent("OutPutStringInfo",function(b,c){var d=c.split(" ");a.each(d,function(b,c){if(c){var d=c.split("-"),e=parseInt(d[0].split("@")[0]);a.each(d[1].split(":"),function(a,b){o[r].MotionDetectWindow[e].Region[a]=parseInt(b)})}}),l._setTempConfig()})},onClearArea:function(){webApp.DeviceType.contains("TPC")?g.RemoveAllMonDetectReg():g.DelSelReg(-2)},onDelArea:function(){webApp.DeviceType.contains("TPC")?(g.RemoveMonDetectReg(q),g.RemoveAllMonDetectReg(q)):g.DelSelReg(-1)},onSetPeriod:function(){n&&n[r].EventHandler&&n[r].EventHandler.TimeSection&&i.open(n[r].EventHandler.TimeSection).done(function(a){n[r].EventHandler.TimeSection=a})},onDefault:function(){e.ConfigManager.getDefault("MotionDetect").done(function(a){n[r]=a[r],l._renderElements(),l.tip("success","Defaultsuccess")}).fail(function(){l.tip("error","Defaultfailure")})},onRefresh:function(){l._getConfig(!0)},onConfirm:function(){n[r].Enable=l.$("#v_m_enable").prop("checked"),a.inArray("V3.0",t.DetectVersion)>-1&&(n[r].DetectVersion="V3.0"),t.PtzManual&&(n[r].PtzManualEnable=l.$("#v_m_ptz").prop("checked")),n[r].EventHandler=l.$("#v_m_event").eventHandler("get"),n[r].EventHandler.Dejitter=l.$("#v_m_anti").numberfield("value"),k&&n[r].EventHandler.LightingLink&&(n[r].EventHandler.LightingLink.Enable=l.$("#v_light_link_enable").prop("checked"),n[r].EventHandler.LightingLink.FilckerLightType=l.$("#v_light_type").val(),n[r].EventHandler.LightingLink.FilckerIntevalTime=10*(l.$("#v_light_duration").numberfield("value")-0),n[r].EventHandler.LightingLink.FilckerTimes=l.$("#v_light_num").numberfield("value")-0),e.ConfigManager.setConfig("MotionDetect",n).done(function(){l.tip("success","Succeed in saving configure")}).fail(function(){l.tip("error","Saving failure")})},_reconnect:function(){e.DevVideoDetect.attachMotionData(++p%65535),webApp.NotifyVersion?h.devNotify.reconnect():l.$("#v_m_frame").attr("src","/cgi-bin/videomotion.cgi?sessionId="+e.getSession())},_setTempConfig:function(){o[0].Enable=!0,e.ConfigManager.setTemporaryConfig("MotionDetect",o)},_detachData:function(){s&&(j.find("#v_m_figure").figure("stop"),e.DevVideoDetect.detachMotionData(p),webApp.NotifyVersion?h.devNotify.detach("devVideoDetect.notifyMotionData"):l.$("#v_m_frame").attr("src",""),app.removeEvent("RECONNECTION",l._reconnect)),e.ConfigManager.restoreTemporaryConfig("MotionDetect"),g.addEvent("OutPutStringInfo",null),g.SetGridNum(0,0),g.hide()}}),window.showMotionFigure=function(b){a.each(b.data,function(a,b){b.id===q&&j.find("#v_m_figure").figure("push",b.threshold)})}}),define("vid_blind",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/modules/timeSection");require("jsCore/modules/eventHandler");var g=null,h=null,i=null,j=0,k=!1;c.exports=e.extend({init:function(){i=this,webApp.EventCaps?d.EventManager.getEventLink("VideoBlind").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[j][0]?d=e:c[j].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),i.$("#v_b_event").eventHandler(d)}).fail(function(){i.$("#v_b_event").eventHandler()}):i.$("#v_b_event").eventHandler(),ability.get("VideoDetectCaps").done(function(a){-1===webApp.DeviceType.indexOf("TPC")&&a&&a.UnFocusDetect?(k=!0,i.$("#v_b_videoable").next("span").attr("t","w_VideoShelterEnable").parent().translation(),i.$("#v_b_focusable").parent().show()):i.$("#v_b_focusable").parent().remove(),i.render()})},render:function(){i._getConfig(!1)},_getConfig:function(a){d.ConfigManager.getConfig("BlindDetect").done(function(b){g=b,i._renderElements(),a&&i.tip("success","Operateingsuccess")}).fail(function(){i.tip("error","Operateingfailure")}),k&&d.ConfigManager.getConfig("UnFocusDetect").done(function(a){h=a,i.$("#v_b_focusable").prop("checked",h[j].Enable)})},_renderElements:function(){i.$("#v_b_videoable").prop("checked",g[j].Enable),i.$("#v_b_event").eventHandler("set",g[j].EventHandler)},onDefault:function(){d.ConfigManager.getDefault("BlindDetect").done(function(a){g[j]=a[j],i._renderElements(),i.tip("success","Defaultsuccess")}).fail(function(){i.tip("error","Defaultfailure")}),k&&d.ConfigManager.getDefault("UnFocusDetect").done(function(a){h=a,i.$("#v_b_focusable").prop("checked",h[j].Enable)})},onRefresh:function(){i._getConfig(!0)},onConfirm:function(){g&&(g[j].Enable=i.$("#v_b_videoable").prop("checked"),g[j].EventHandler=i.$("#v_b_event").eventHandler("get"),d.ConfigManager.setConfig("BlindDetect",g).done(function(){i.tip("success","Succeed in saving configure")}).fail(function(){i.tip("error","Saving failure")})),h&&(h[j].Enable=i.$("#v_b_focusable").prop("checked"),h[j].EventHandler=g[j].EventHandler,d.ConfigManager.setConfig("UnFocusDetect",h))},onSetPeriod:function(){g&&g[j].EventHandler&&g[j].EventHandler.TimeSection&&f.open(g[j].EventHandler.TimeSection).done(function(a){g[j].EventHandler.TimeSection=a})}})}),define("vid_abnormal",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=require("jsCore/modules/timeSection");require("jsCore/modules/eventHandler");var g=null,h=null,i=0,j=null;c.exports=e.extend({init:function(){g=this,webApp.EventCaps?d.EventManager.getEventLink("SceneChange").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[i][0]?d=e:c[i].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),g.$("#v_a_event").eventHandler(d)}).fail(function(){g.$("#v_a_event").eventHandler()}):g.$("#v_a_event").eventHandler(),g.render(),webApp.CHANNEL_NUMBER>1&&(g.$("#vid_abnormal_channel").parent().removeClass("fn-hide"),g.$("#vid_abnormal_channel").parent().next("div").removeClass("fn-hide"),j=a("#vid_abnormal_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){i=b.ch,g._renderElements()}}),j.iconSelect("index",i))},render:function(){g._getConfig(!1)},_getConfig:function(a){d.ConfigManager.getConfig("MovedDetect").done(function(b){h=b,g._renderElements(),a&&g.tip("success","Operateingsuccess"),g.disabled("[btn-for=onConfirm]",!1)}).fail(function(){g.tip("error","Operateingfailure"),g.disabled("[btn-for=onConfirm]",!0)})},_renderElements:function(){g.$("#v_a_enable").prop("checked",h[i].Enable),g.$("#v_a_event").eventHandler("set",h[i].EventHandler)},onDefault:function(){d.ConfigManager.getDefault("MovedDetect").done(function(a){h[i]=a[i],g._renderElements(),g.tip("success","Defaultsuccess")}).fail(function(){g.tip("error","Defaultfailure")})},onRefresh:function(){g._getConfig(!0)},onConfirm:function(){h[i].Enable=g.$("#v_a_enable").prop("checked"),h[i].EventHandler=g.$("#v_a_event").eventHandler("get"),d.ConfigManager.getConfig("MovedDetect").done(function(a){a[i]=h[i],d.ConfigManager.setConfig("MovedDetect",a).done(function(){g.tip("success","Succeed in saving configure")}).fail(function(){g.tip("error","Saving failure")})})},onSetPeriod:function(){h&&h[i].EventHandler&&h[i].EventHandler.TimeSection&&f.open(h[i].EventHandler.TimeSection).done(function(a){h[i].EventHandler.TimeSection=a})}})})}(jQuery);