!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("calibrate",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/plugin"),f=require("jsCore/rpcLogin"),g=require("jsCore/pageBase");require("jsCore/modules/minPtzControl");var h=null,i=null,j=null,k=null,l=null,m=!1,n=null,o=[{PointPair:[{id:0,VisalPoint:[100,400],ThermPoint:[200,400]},{id:1,VisalPoint:[600,600],ThermPoint:[1800,800]}]},{PointPair:[{id:2,VisalPoint:[800,800],ThermPoint:[1500,400]},{id:3,VisalPoint:[1e3,4e3],ThermPoint:[2e3,4e3]}]}];c.exports=g.extend({init:function(){h=this,h._initPtz(),h._initCalibration(),d.ConfigManager.getConfig("Encode").done(function(a){var b=a[0].MainFormat[0].Video,c=(b.Width-640*b.Height/512)/2;c=Math.ceil(8191*c/b.Width),j={CalibrationRange:[[c,0],[8191-c,8191]]},h.render()})},_initPtz:function(){a("#cal_PTZ").minPtzControl("init")},_initCalibration:function(){h.$("#cal_iconBar").find("a[calibrate]").click(function(a){var b=h.$(a.target),c=b.attr("btn-for")-0;2>c&&(m=!1),l=c;var d=l>1?1:0;return k=i.FusionPoints[d].PointPair[l-2*d],(2!==webApp.CHANNEL_NUMBER||-1!==webApp.DeviceType.indexOf("SD"))&&l>1&&!m?(h.$("#cal_tip").tip("error",tl("ChangeZoomFirst")),!1):void e.SetCalibrationEnable(l,!1).done(function(){b.removeClass("ui-button-current"),k.VisalPoint[0]=0,k.VisalPoint[1]=0,k.ThermPoint[0]=0,k.ThermPoint[1]=0,h._renderCalibration(),e.SetCalibrationEnable(l,!0).done(function(){b.hide().siblings("a[calibrate]").hide().siblings("a[btn-for=OnSubmit], a[btn-for=OnRange]").removeClass("fn-hide"),h.$(".ui-button-box a[btn-for=onSave]").hide(),h.$("#cal_tip").tip("success",tl("CalibrateCenter"))})})})},OnSubmit:function(){return 0===k.VisalPoint[0]&&0===k.VisalPoint[1]||0===k.ThermPoint[0]&&0===k.ThermPoint[1]?(h.$("#cal_tip").tip("error",tl("CalibrateOneFinish")),!1):void e.SetCalibrationEnable(l,!1).done(function(){h.$("#cal_tip").tip("success",tl("calibration")+tl(l+1+" ")+tl("CalibrateSuccess")),h._renderElement()})},OnRange:function(){e.ZoomActive(l,!0).done(function(){h.$("#cal_tip").tip("success",tl("CalibrateCenter"))}).fail(function(){alert("放大失效！")})},render:function(){e.SetIVSDrawingEnable(!1);var a=h.$("#cal_iconBar").width();h.$("#cal_video").width(a),e.cover("#cal_video",function(){f.chkAuthority("Monitor_01")&&f.chkAuthority("Monitor_02")&&(e.SetVisibleVideoWnd(2,0),e.ConnectAllChannel(2,1))}),n=setTimeout(function(){h._getConfig(!1),n=null},3e3),e.addEvent("CalibrationData",function(a){var b=JSON.decode(a),c=b.WndID;c?k.ThermPoint=b.ThermPoint[0]:k.VisalPoint=b.VisalPoint[0],h.$("#cal_tip").tip("success",tl("CalibrateCenter"))}),e.addEvent("CalibrationRange",function(a){a&&h.$("#cal_tip").tip("error",tl("CalibrateInArea"))})},leave:function(){e.hide(),l&&e.ZoomActive(l,!1),e.ClearAllOpData(),e.addEvent("CalibrationData",null),e.addEvent("CalibrationRange",null),n&&(clearTimeout(n),n=null)},_renderElement:function(){h.$("#cal_enable").prop("checked",i.Enable),i.Mode&&(h.$("#cal_mode").removeClass("fn-hide"),h.$("input[name=focusMode][value="+i.Mode+"]").prop("checked",!0)),h.$("a[btn-for=OnSubmit], a[btn-for=OnRange]").addClass("fn-hide"),h.$(".ui-button-box a[btn-for=onSave], #cal_iconBar a[calibrate]").show(),h._renderCalibration(),null!=l&&(e.ZoomActive(l,!1),e.SetCalibrationEnable(l,!1),l=null,k=null)},_renderCalibration:function(){i.FusionPoints.each(function(a,b){a.PointPair.each(function(a,c){a.VisalPoint[0]>0&&a.VisalPoint[1]>0&&a.ThermPoint[0]>0&&a.ThermPoint[1]>0&&h.$("#cal_iconBar a[calibrate]").eq(2*b+c).addClass("ui-button-current"),o[b].PointPair[c].VisalPoint[0]=a.VisalPoint[0],o[b].PointPair[c].VisalPoint[1]=a.VisalPoint[1],o[b].PointPair[c].ThermPoint[0]=a.ThermPoint[0],o[b].PointPair[c].ThermPoint[1]=a.ThermPoint[1]})}),e.SetCalibrationRange(JSON.encode(j)),e.SetCalibrationData(JSON.encode(o))},onDefault:function(){return d.ConfigManager.getDefault("CalibratePoints").done(function(a){i=a,h._renderElement(),h.$("#cal_tip").tip("success",tl("Defaultsuccess"))}).fail(function(){h.$("#cal_tip").tip("error",tl("Defaultfailure"))}),!1},onRefresh:function(){return h._getConfig(!0),!1},onSave:function(){return i?(i.Enable=h.$("#cal_enable").prop("checked"),i.Mode&&(i.Mode=h.$("input[name=focusMode]:checked").val()),i.Enable||d.ConfigManager.getConfig("VisualRadiometry").done(function(a){a[0].HotFollowEnable=!1,a[0].RadiometryEnable=!1,d.ConfigManager.setConfig("VisualRadiometry",a)}),d.ConfigManager.setConfig("CalibratePoints",i).done(function(){h.$("#cal_tip").tip("success",tl("Succeed in saving configure"))}).fail(function(){h.$("#cal_tip").tip("error",tl("Saving failure"))}),!1):void 0},_getConfig:function(a){d.ConfigManager.getConfig("CalibratePoints").done(function(b){i=b,h._renderElement(),a&&h.$("#cal_tip").tip("success",tl("Operateingsuccess"))}).fail(function(){h.$("#cal_tip").tip("error",tl("Operateingfailure"))})}})})}(jQuery);