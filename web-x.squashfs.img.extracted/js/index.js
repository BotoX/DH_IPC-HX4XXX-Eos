!function(a){define(function(require,b,c){function d(){var b=m.getLoginInfo(),c=b.username,d=b.password,e=b.logintype,f=a("#pre_type").val()-0;"ActiveDirectory"===e&&(f=13),"LDAP"===e&&(f=12),plugin.login(c,d,f).done(function(){n.leave(),webApp.IsSDIntel&&l.DevIntelliTracker.start(),require.async("index_page",function(b){n.indexPage=new b({element:a("#main").translation()})})})}function e(){plugin.logout(),m.logout()}var f,g=require("/jsCore/pageBase"),h=require("common/common"),i=h.Cookie,j=h.Check,k=require("/jsCore/ability"),l=require("/jsCore/rpc"),m=require("/jsCore/rpcLogin"),n=null,o=null;c.exports=g.extend({init:function(){if(n=this,n.$("#login_user").textfield(),n.$("#login_psw").textfield().on({keydown:function(a){13===a.keyCode&&(n.$("#login_psw").blur(),n.$("[btn-for=onLogin]").click())},keyup:function(){var a=h.pwdStrenthValidator(this.value),b=n.$(".ui-pwd-strength");b.find("li").removeClass("current"),this.value?(b.find("li."+a).addClass("current"),b.removeClass().addClass("ui-pwd-strength").addClass(a)):b.removeClass().addClass("ui-pwd-strength")}}),o=n.$("#login_modify").dialog({confirm:function(){return f.isInvalid()?f.validate():(o.closeFlag=!0,o.dialog("close"),o.closeFlag=!1,void l.MagicBox.getSerialNo().done(function(b){var c,e,f="Login to "+b,g=m.getLoginInfo(),h=o.find("[name=newpwd]").textfield("value");webApp.EncryptInfo&&webApp.EncryptInfo.asymmetric&&webCaps.OnvifSync?(c=h,e=g.password):(c=hex_md5(g.username+":"+f+":"+h),e=hex_md5(g.username+":"+f+":"+g.password)),l.UserManager.modifyPassword(g.username,c,e).done(function(){m.getLoginInfo().password=o.find("[name=newpwd]").textfield("value"),d()}).fail(function(b){var c=b.error.code,d="w_ChangePwdFail";switch(c){case 604:d="w_useMannageErr_InputNotValid";break;case 605:d="w_useMannageErr_IndexOverlap_user";break;case 606:case 607:d="w_useMannageErr_ObjectNotValid_user";break;case 608:d="w_useMannageErr_ObjectInUse_user";break;case 609:d="w_useMannageErr_SubsetOverlap_user";break;case 610:d="w_useMannageErr_SaveCfgError";break;case 611:d="w_useMannageErr_PwdNotValid";break;case 612:d="w_useMannageErr_PwdNotMatch";break;case 613:d="w_useMannageErr_ReservedAccount";break;case 614:d="w_useMannageErr_TooManyGroup";break;case 615:d="w_useMannageErr_TooManyUser"}a.alert(tl(d))})}))},close:function(){!o.closeFlag&&d()}}).detach().appendTo(document.body),o.find(":checkbox").on("change",function(a){i.set("pwdNoTip",a.target.checked?1:0,{expires:365})}),o.find("[name=newpwd2]").textfield({success:a.noop}),o.find("[name=newpwd]").textfield({success:a.noop}).on("keyup",function(){var a=h.pwdStrenthValidator(this.value),b=o.find(".ui-pwd-strength");b.find("li").removeClass("current"),this.value?(b.find("li."+a).addClass("current"),b.removeClass().addClass("ui-pwd-strength").addClass(a)):b.removeClass().addClass("ui-pwd-strength")}),f=a.validator([{element:o.find("[name=newpwd]"),check:[j.require,j.noQuotationColonAnd],errorMsg:["w_passwordMustnotNull","badPwdString"],events:["keyup","keyup"],errorElem:".u-input-error"},{element:o.find("[name=newpwd2]"),check:[j.require,function(a){return a===o.find("[name=newpwd]").val()},j.noQuotationColonAnd],errorMsg:["w_passwordMustnotNull","w_PwdDif","badPwdString"],events:["keyup","keyup","keyup"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),"Dahua"===webApp.Vendor)n.$("#login_logo").addClass("login-logo-dahua"),a("#main_logo").addClass("main-logo-dahua");else if(-1!==webApp.DeviceType.indexOf("TPC"))n.$("#login_logo").addClass("login-logo-tpc"),a("#main_logo").addClass("main-logo-tpc");else if(-1===webApp.DeviceType.indexOf("SD"))n.$("#login_logo").addClass("login-logo"),a("#main_logo").addClass("main-logo");else switch(webApp.DeviceSubClass){case"SDC":n.$("#login_logo").addClass("login-logo-ipdome"),a("#main_logo").addClass("main-logo-ipdome");break;case"SD_CA":case"SD_CA_ICT":n.$("#login_logo").addClass("login-logo"),a("#main_logo").addClass("main-logo");break;case"SD_PTZ":n.$("#login_logo").addClass("login-logo-ipptz"),a("#main_logo").addClass("main-logo-ipptz");break;default:n.$("#login_logo").addClass("login-logo-ipdome"),a("#main_logo").addClass("main-logo-ipdome")}!isEnable("is_show_LDAP")&&n.$("#login_type").remove(),isEnable("is_show_secrityCheck")&&n.$("#login_psw").parent().next().removeClass("fn-hide"),n.render()},render:function(b){a("#main").hide(),n.element.css("top","50%").show(),"anonymity"!==i.get("username")&&n.$("#login_user").textfield("value",i.get("username")),n.$("#login_psw").textfield("value",""),(isDDNS()||webCaps.Anonymous)&&b!==!0?setTimeout(n.onLogin,100):n.$("#login_user").textfield("value")?n.$("#login_psw").focus():n.$("#login_user").focus(),document.title=tl("w_Login")},leave:function(){n.element.css("top","-100000").hide(),a("#main").show()},destory:function(){o.remove()},onLogin:function(b){var c=n.$("#login_user").textfield("value"),e=n.$("#login_psw").textfield("value"),f=n.$("#login_selType").val()||"Direct";if(!b)if(isDDNS()){var g=getDDNSMessage();c=g.username,e=g.password}else webCaps.Anonymous&&(c="anonymity",e="anonymity");m.login(c,e,f).done(function(){!m.needModifyPsw()||i.get("pwdNoTip")-0?d():(k.get("SyncTime").done(function(a){if(a&&a.SyncZoneAndDST){var b=displayDstSwitchDates();l.ConfigManager.getConfig(["Locales","NTP"]).done(function(a){var c=a[0].params.table,d=a[1].params.table;2===b.length?(c.DSTEnable=!0,c.DSTEnd.Day=b[1].getDay(),c.DSTEnd.Hour=b[1].getHours(),c.DSTEnd.Minute=b[1].getMinutes(),c.DSTEnd.Month=b[1].getMonth(),c.DSTEnd.Week=b[1].getMonth(),c.DSTEnd.Year=b[1].getFullYear(),c.DSTStart.Day=b[0].getDay(),c.DSTStart.Hour=b[0].getHours(),c.DSTStart.Minute=b[0].getMinutes(),c.DSTStart.Month=b[0].getMonth(),c.DSTStart.Week=b[0].getMonth(),c.DSTStart.Year=b[0].getFullYear()):c.DSTEnable=!1;var e=(new Date).getTimezoneOffset,f=[0,3600,7200,10800,12600,14400,16200,18e3,19800,20700,21600,23400,25200,28800,32400,34200,36e3,39600,43200,46800,-3600,-7200,-10800,-12600,-14400,-18e3,-21600,-25200,-28800,-32400,-36e3,-39600,-43200,-16200,36e3,50400];d.TimeZone=f.indexOf(e),l.ConfigManager.setConfig(["Locales","NTP"],[c,d]).done(function(){})})}}),o.find(":password").val(""),o.find(".u-input-error").hide(),o.find(":checkbox").prop("checked",!1),o.find("li").removeClass("current"),o.find(".ui-pwd-strength").removeClass().addClass("ui-pwd-strength"),o.dialog("show"),o.find("[name=newpwd]").focus(),webApp.GongAnDetect&&(o.find("#no_tip").hide(),o.find("#u_close").hide(),o.find("#i_close").hide()))}).fail(function(b){switch(b){case 268632070:a.alert(tl("The user is not exited."));break;case 268632071:a.alert(tl("usernameOrPwdError"));break;case 268632073:a.alert(tl("The user is invalid."));break;case 268632074:a.alert(tl("The user has logined."));break;case 268632075:a.alert(tl("the number of connection is maximal.request is refused!"));break;case 268632081:a.alert(tl("The user is locked."));break;default:a.alert(tl("Login failure!"))}})},onCancel:function(){n.$("#login_user").textfield("value",""),n.$("#login_psw").textfield("value","")},onLogout:function(){webApp.IsSDIntel&&l.DevIntelliTracker.stop(),plugin.logout(),n.indexPage.leave(),n.indexPage.destory(),n.render(!0),m.logout()}}),a(window).on("unload",e)}),define("index_page",function(require,b,c){var d=require("/jsCore/pageBase"),e=(require("/jsCore/plugin"),webCaps.WebVersion?"?version="+webCaps.WebVersion:"");c.exports=d.extend({init:function(){var b=this,c=b.element.children(".u-tab"),d=b.element.children(".u-tab-content");b.tabs={},b.current=null,-1===webApp.DeviceType.indexOf("SD")&&login.chkAuthority("MPTZ")&&webApp.HasPtz&&!isEnable("is_8M_Flash")?ability.get("VideoInputCaps").always(function(a){a&&a.ElectricFocus?c.find("[data-for=ptz]").hide():c.find("[data-for=ptz]").show()}):c.find("[data-for=ptz]").hide(),ability.get("IsLocalStore").then(function(a){login.chkAuthority("Replay_01")&&a&&!isEnable("is_8M_Flash")?c.find("[data-for=playback]").show():c.find("[data-for=playback]").hide()}),-1!==webApp.DeviceType.indexOf("TPC")&&-1!==webApp.DeviceType.indexOf("-T")&&login.chkAuthority("ReportConfig")?c.find("[data-for=report]").show():c.find("[data-for=report]").hide(),a(document.body).css("background",'#373737 url("image/setbg.png") repeat-x'),c.tab({switched:function(a,f){var g=b.tabs[f.from],h=b.tabs[f.to];if(document.title=c.find("[data-for="+f.to+"] a").text(),g&&g.leave(),h)h.render(),b.current=h;else{var i=["/js/"+f.to+".js"+e];switch(f.to){case"logout":return webApp.loginPage.onLogout();case"playback":case"report":case"alarm":i.push("/html/"+f.to+".htm"+e);break;case"preview":case"ptz":case"set":}require.async(i,function(a,c){var e=d.find("[data-page="+f.to+"]");c?e.empty().append(c).translation():e.translation(),b.tabs[f.to]=new a({element:e}),b.current=b.tabs[f.to]})}}})},render:function(){this.current&&this.current.render()},leave:function(){this.current&&this.current.leave()},destory:function(){a.each(this.tabs,function(b,c){a.isFunction(c.destory)&&c.destory()}),this.current=null,this.tabs=null,this.element.children(".u-tab").tab("destroy"),a(document.body).css("background","#373737")}})})}(jQuery);