!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab"),b.exports.prototype.log_remote=!!isEnable("is_show_Syslog")}),define("log_system",function(require,b,c){var d,e,f,g,h,i,j=require("jsCore/rpc"),k=require("jsCore/pageBase"),l=(require("common/common"),require("jsCore/rpcLogin")),m=require("jsCore/plugin"),n=(require("jsCore/ability"),{System:["StartUp","Abort","Exit","Restart","ShutDown","Reboot","System.Upgrade","Upgrade","SetCurrentTime"],Config:["SaveConfig","RecallConfig","Focus&Zoom"],Storage:["SetWorkDirType","Storage.SetWorkDirGroup","Storage.ClearWorkDir","ClearWorkDir","Storage.HotPlug","HotPlug","RecordMode","FTP.Status","Storage.Unmount","NFS.Status","SD.Error","Disk.Error"],Event:["EventStart","EventStop","EventPulse"],Data:["FileAccess","FileAccessError","FileSearch","File.Access"],Account:["LogIn","LogOut","AddUser","DeleteUser","ModifyUser","AddGroup","DeleteGroup","ModifyGroup","Account.ModifyPwd"],ClearLog:["ClearLog"]}),o=100,p=0;c.exports=k.extend({init:function(){var a=this;d=a.$("#lm_table").table({pageable:!1,height:260,columns:[{title:tl("w_Numbers"),width:"10%",render:function(a){return a._index+1+p}},{title:tl("w_Logtime"),width:"30%",fields:"Time"},{title:tl("w_User"),width:"30%",fields:"User"},{title:tl("w_Event"),width:"30%",fields:"Type"}],onRowSelect:function(b,c){return a._renderDetail(c.data),!1}}),e=a.$(".u-pagination").pagination({pageSize:o,change:function(b,c){return a._find(c.currentPage),!1}}),f=a.$("#lm_st_date").datepicker({change:function(a,b){h.datepicker("minDate",b.value)}}),g=a.$("#lm_st_time").timefield(),h=a.$("#lm_en_date").datepicker(),i=a.$("#lm_en_time").timefield(),a.render()},render:function(){var a=this;j.ConfigManager.getConfig("Locales").done(function(a){switch(a.TimeFormat.split(" ")[0]){case"MM-dd-yyyy":f.datepicker("format","mm-dd-yyyy"),h.datepicker("format","mm-dd-yyyy");break;case"dd-MM-yyyy":f.datepicker("format","dd-mm-yyyy"),h.datepicker("format","dd-mm-yyyy");break;default:f.datepicker("format","yyyy-mm-dd"),h.datepicker("format","yyyy-mm-dd")}switch(a.TimeFormat.split(" ")[1]){case"HH:mm:ss":g.timefield("format","24"),i.timefield("format","24");break;default:g.timefield("format","12"),i.timefield("format","12")}});var b=new Date;f.datepicker("value",b.addDays(-1)),g.timefield("value",b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()),h.datepicker("value",b.addDays(1)),i.timefield("value",b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()),a._renderTable(),e.pagination("total",0),a.disabled(a.$("[btn-for=onBackup]"),!0),a.$("#lm_serachtip").hide(),a.disabled(a.$("[btn-for=onClear]"),!l.chkAuthority("DelLog")),a.disabled(a.$("[btn-for=onSearch]"),!l.chkAuthority("QueryLog"))},leave:function(){},onSearch:function(){function b(a){e.pagination("total",0),e.pagination("total",a),d.disabled(d.$("[btn-for=onSearch]"),!1),d.disabled(d.$("[btn-for=onBackup]"),!1),d.$("#lm_serachtip").show().find("span:eq(1)").text(a),d._find(1)}function c(a){d._renderTable(),e.pagination("total",0),d.disabled(d.$("[btn-for=onSearch]"),!1),d.disabled(d.$("[btn-for=onBackup]"),!0),d.$("#lm_serachtip").hide(),a&&d.tip("error",tl("w_QueryLogFail"))}var d=this,k=f.datepicker("value")+" "+g.timefield("value"),l=h.datepicker("value")+" "+i.timefield("value"),m=d.$("select[sel-for=onTypeChange]").val(),o={StartTime:k,EndTime:l,Translate:!0,Order:"Descent"};return m&&a.extend(o,{Types:n[m]}),new Date(k.replace(/-/g,"/"))>new Date(l.replace(/-/g,"/"))?(d.tip("warning",tl("the begin time must be less than the end time !")),!1):(d.disabled(d.$("[btn-for=onSearch]"),!0),void j.Integration.getLogCount(o).done(function(a){0===a?(d.tip("success",tl("w_NoQueryLog")),c()):b(a)}).fail(function(){c(!0)}))},onClear:function(){var b=this;a.confirm(tl("DelLog"),tl("w_ConfirmDeleteLog"),function(){j.Log.clear().done(function(a){a.result?(b.tip("success",tl("w_DelLogSucce")),b._renderTable(),e.pagination("total",0),b.$("#lm_serachtip").hide()):b.tip("error",tl("w_DelLogFail"))}).fail(function(){b.tip("error",tl("w_DelLogFail"))})})},onBackup:function(){var b=this,c=new Date,d="LogBackup"+(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate());m.ShowSaveOrOpenDlg("saveFile",d,[{description:"Log Files (*.txt)",extensions:["txt"]}]).done(function(c){function d(e,f){j.Integration.getLog(e,f).done(function(f){if(f&&f.found&&a.isArray(f.items)){var g=a.map(f.items,function(a,b){return e+b+1+"	"+a.User+"	"+a.Time+"	"+a.Type+"	"+JSON.stringify(a.Detail)+"\r\n"});m.WriteFile(g.join(""),"a+",c[1]),d(e+=f.found,10*o)}else f&&0===f.found?b.tip("success",tl("Succeed in saving configure")):b.tip("error",tl("Saving failure"))}).fail(function(){b.tip("error",tl("Saving failure"))})}if(""!=c[0]){b.tip("success",tl("w_waiting"),-1);var e=tl("w_Numbers")+"	"+tl("w_User")+"	"+tl("Time")+"			"+tl("Type")+"	"+tl("Content")+"\r\n";m.WriteFile(e,"w+",c[1]),d(0,10*o)}})},_find:function(a){var b=this;p=(a-1)*o,j.Integration.getLog(p,o).done(function(a){a.found?b._renderTable(a.items):b._renderTable()}).fail(function(){b._renderTable()})},_renderTable:function(a){var b=this;d.table("dataSource",a||[]),b._renderDetail(),a&&a.length>0&&(b.$("#lm_serachtip>span:eq(5)").text(a[0].Time),b.$("#lm_serachtip>span:eq(4)").text(a[a.length-1].Time))},_renderDetail:function(b){var c=this,d=c.$("#lm_logtime"),e=c.$("#lm_logtype"),f=c.$("#lm_loguser"),g=c.$("#lm_logcontent");d.text(b&&b.Time||""),e.text(b&&b.Type||""),f.text(b&&b.User||""),b&&b.Detail?"string"===a.type(b.Detail)?g.text(b.Detail):"object"===a.type(b.Detail)&&(g.empty(),a.each(b.Detail,function(b,c){a("<div></div>").text(b+": "+c).appendTo(g)})):g.text("")}})}),define("log_remote",function(require,a,b){var c=require("jsCore/rpc"),d=require("jsCore/pageBase"),e=null,f=null,g=null,h=null;b.exports=d.extend({init:function(){var a=this;e=a.$("#log_remote_ip").ipfield(),f=a.$("#log_remote_port").numberfield({max:65534,min:1,allowDecimal:!1,allowNegative:!1}),g=a.$("#log_remote_enable"),a.render()},render:function(){this._getConfig(!1)},_getConfig:function(a){var b=this;c.ConfigManager.getConfig("SysLogServer").done(function(c){c?(h=c,g.prop("checked",c.Enable),f.numberfield("value",c.Port),e.ipfield("value",c.Address),a&&b.tip("success",tl("Operateingsuccess"))):a&&b.tip("error",tl("Operateingfailure")),b.disabled(b.$("[btn-for=onSave]"),!c)}).fail(function(){a&&b.tip("error",tl("Operateingfailure")),b.disabled(b.$("[btn-for=onSave]"),!0)})},onRefresh:function(){return this._getConfig(!0),!1},onSave:function(){var a=this;return h.Enable=g.prop("checked"),h.Port=f.numberfield("value"),h.Address=e.ipfield("value"),c.ConfigManager.setConfig("SysLogServer",h).done(function(){a.tip("success",tl("Operateingsuccess"))}).fail(function(){a.tip("error",tl("Operateingfailure"))}),!1}})})}(jQuery);