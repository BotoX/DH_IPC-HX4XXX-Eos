!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("ipAuth",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase");require("widget/js/dui.macfield");var f=null,g=null,h=null,i=null,j=null,k=null,l=null,m=null,n=null,o={},p=[],q="",r="",s="",t=null,u="",v="add",w="TrustList";c.exports=e.extend({init:function(){f=this,(webApp.GongAnDetect||-1!==webApp.DeviceType.indexOf("TPC"))&&(f.$('[data-for="BannedList"]').show(),f.$("#ipAuth_enable").attr("t","enable").text(tl("enable"))),m=f.$("#ipAuth_Enable"),g=f.$("#ipAuth_AddIP").dialog({title:tl("w_Add IP/MAC"),save:function(){f._onSave()}}).detach().appendTo(document.body),h=f.$("#ipAuth_delIP").dialog({title:tl("w_Delete IP/MAC"),"delete":function(){f._onDel()}}).detach().appendTo(document.body),n=h.find("#delMsg"),i=g.find("#ipAuth_IP1").ipfield(),j=g.find("#ipAuth_IP2").ipfield(),k=g.find("#ipAuth_IP3").macfield(),l=f.$("#ip_Table").table({height:200,columns:[{title:tl("w_IPaddr/MAC"),width:"50%",fields:"ip"},{title:tl("w_Amend"),width:"25%",action:"modify",icon:"ui-table-icon-edit",handle:function(a){return v="modify",u=a.ip,f._onModifyIP(a.ip),!1}},{title:tl("Delete"),icon:"ui-table-icon-del",action:"delete",handle:function(a){return v="del",u=a.ip,f._closeAllDialog(),n.text(tl("w_Sure to delete this IP or IP Area/MAC?")),h.dialog("show").find(".u-dialog-head").find("h1").text(tl("w_Delete IP/MAC")),!1}}]}),m.on("click",function(){o.Enable=a(this).prop("checked")}),f.$(".ui-table-tab li").on("click",function(){a(this).siblings().removeClass("ui-table-tab-current"),w=a(this).addClass("ui-table-tab-current").attr("data-for"),-1!==webApp.DeviceType.indexOf("TPC")?"TrustList"===w?m.prop("checked",o.TrustEnable):m.prop("checked",o.BannedEnable):m.prop("checked",o.Enable),f._renderAccess()}),f.render()},render:function(){f._closeAllDialog(),d.ConfigManager.getConfig(["AccessFilter","Network"]).done(function(a){o=a[0].params.table,f._renderElements(),q=a[1].params.table.eth0.IPAddress,r=a[1].params.table.eth0.PhysicalAddress,a[1].params.table.eth2&&(s=a[1].params.table.eth2.IPAddress,t=a[1].params.table.eth2.PhysicalAddress)})},destory:function(){g.remove(),h.remove()},_renderElements:function(){-1!==webApp.DeviceType.indexOf("TPC")?"TrustList"===w?m.prop("checked",o.TrustEnable):m.prop("checked",o.BannedEnable):m.prop("checked",o.Enable),null==o.TrustList&&(o=JSON.decode('{"Enable" : false,"Type" : "BannedList","TrustList" : [],"BannedList" : []}')),f._renderAccess()},_renderAccess:function(){p=[],a.each(o[w],function(a,b){p.push({ip:b})}),l.table("dataSource",p),0==o[w].length?(f.disabled("#ipAuth_Enable"),m.prop("checked",!1)):f.disabled("#ipAuth_Enable",!1)},onChangeES:function(){switch(g.find("[sel-for=onChangeES]").get(0).selectedIndex){case 0:i.show(),j.hide(),k.hide();break;case 1:i.show(),j.show(),k.hide();break;case 2:i.hide(),j.hide(),k.show()}},_closeAllDialog:function(){g.dialog("close"),h.dialog("close"),i.ipfield("value","1.0.0.1"),j.ipfield("value","1.0.0.1"),k.macfield("empty")},onAddIP:function(){return(webApp.GongAnDetect||-1!==webApp.DeviceType.indexOf("TPC"))&&o[w].length>=50?(a.alert(tl("IpmostTo50"),function(){}),!1):(v="add",f._closeAllDialog(),g.find("[sel-for=onChangeES]").val("1"),i.show(),j.hide(),k.hide(),i.ipfield("value","1.0.0.1"),g.dialog("show").find(".u-dialog-head").find("h1").text(tl("w_Add IP/MAC")),j.ipfield("value","1.0.0.1"),k.macfield("empty"),void g.dialog("show"))},onClearIP:function(){v="clear",f._closeAllDialog(),n.text(tl("w_Are you sure to clear IP/MAC?")),h.dialog("show").find(".u-dialog-head").find("h1").text(tl("w_Removeall IP/MAC"))},_onModifyIP:function(a){if(f._closeAllDialog(),u=a,g.dialog("show").find(".u-dialog-head").find("h1").text(tl("w_Modify IP/MAC")),u.indexOf(":")>-1)g.find("[sel-for=onChangeES]").val(3),i.hide(),j.hide(),k.show().macfield("value",u);else if(u.indexOf("-")>-1){g.find("[sel-for=onChangeES]").val(2),i.show(),j.show(),k.hide();var b=u.split("-");i.ipfield("value",b[0]),j.ipfield("value",b[1])}else u.indexOf(".")>-1&&(g.find("[sel-for=onChangeES]").val(1),i.show(),j.hide(),k.hide(),i.ipfield("value",u))},onDefault:function(){d.ConfigManager.getDefault("AccessFilter").done(function(a){o=a,f._renderElements(),f.tip("success","Defaultsuccess")}).fail(function(){f.tip("error","Defaultfailure")})},onRefresh:function(){d.ConfigManager.getConfig("AccessFilter").done(function(a){o=a,f._renderElements(),f.tip("success","Operateingsuccess")}).fail(function(){f.tip("error","Operateingfailure")})},onConfirm:function(){-1!==webApp.DeviceType.indexOf("TPC")?("TrustList"===w?(o.TrustEnable=m.is(":checked"),o.TrustEnable&&(o.BannedEnable=!1)):(o.BannedEnable=m.is(":checked"),o.BannedEnable&&(o.TrustEnable=!1)),o.Enable=o.TrustEnable||o.BannedEnable):o.Enable=m.is(":checked"),o.Type=w,d.ConfigManager.setConfig("AccessFilter",o).done(function(){f.tip("success","Succeed in saving configure")}).fail(function(){f.tip("error","Saving failure")})},_onSave:function(){var b=-1;switch("modify"===v&&(b=a.inArray(u,o[w])),g.find("[sel-for=onChangeES]").get(0).selectedIndex){case 0:var c=i.ipfield("value");if(q==c||s==c)return g.dialog("close"),void f.tip("warning","w_deviceip");if(a.inArray(c,o[w])>-1)return g.dialog("close"),void f.tip("warning","IP is exise");u=c;break;case 1:var d=i.ipfield("value")+"-"+j.ipfield("value"),e=q+"-"+q,h=s+"-"+s;if(e==d||h==d)return g.dialog("close"),void f.tip("warning","w_deviceip");var l=i.ipfield("value").split("."),m=j.ipfield("value").split(".");if(256*l[0]*256*256+256*l[1]*256+256*l[2]+l[3]-0>256*m[0]*256*256+256*m[1]*256+256*m[2]+m[3]-0&&(d=j.ipfield("value")+"-"+i.ipfield("value")),a.inArray(d,o[w])>-1)return g.dialog("close"),void f.tip("warning","IP is exise");u=d;break;case 2:var n=k.macfield("value");if(r.toLowerCase()==n.toLowerCase()||t&&t.toLowerCase()==n.toLowerCase())return g.dialog("close"),void f.tip("warning","w_used");var p=!1;if(a.each(o[w],function(a,b){return u===b?b===n&&(p=!0):void(b.toLowerCase()===n.toLowerCase()&&(p=!0))}),p)return g.dialog("close"),void f.tip("warning","w_MAC is exist");u=n}-1===b?o[w].push(u):o[w][b]=u,u="",f._renderElements(),f._closeAllDialog(),f.tip("success","w_Operateingsuccess")},_onDel:function(){"del"===v?o[w].erase(u):"clear"===v&&(o[w]=[]),f._renderElements(),f._closeAllDialog(),f.tip("success","w_Operateingsuccess")}})})}(jQuery);