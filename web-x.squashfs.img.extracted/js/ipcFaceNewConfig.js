!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("ipc_face",function(require,b,c){function d(a){for(var b=0;b<a.length;b++)if(0!==a[b])return!1;return!0}var e=require("jsCore/rpc"),f=require("jsCore/pageBase"),g=require("jsCore/plugin"),h=require("jsCore/ability"),i=require("jsCore/modules/timeSection"),j=require("jsCore/modules/IntellMutex"),k=require("common/common");require("widget/js/dui.slider"),require("jsCore/modules/eventHandler");var l=null,m=null,n=null,o=null,p=null,q=null,r=!1,s=!0,t=null,u=null,v=null,w=[],x=!1,y=0;c.exports=f.extend({init:function(){l=this,m=new j("i_f_mutex"),webApp.EventCaps?e.EventManager.getEventLink("FaceDetection").done(function(b){var c=b.name,d=a.extend({},webApp.DefaultEvent),e=webApp.EventCaps;"default"===c[y][0]?d=e:c[y].each(function(a){d[a]=!0,"AlarmOutEnable"===a?d.AlarmOutLatch=e.AlarmOutLatch:"DejitterEnable"===a?d.DejitterRange=e.DejitterRange:"RecordEnable"===a&&(d.RecordLatch=e.RecordLatch)}),l.$("#i_f_event").eventHandler(d)}).fail(function(){l.$("#i_f_event").eventHandler()}):l.$("#i_f_event").eventHandler(),l.$("#i_f_alacount").numberfield({min:1,max:35,allowDecimal:!1,allowNegative:!1}),l.$("#i_f_t_value").numberfield({min:0,max:100,allowDecimal:!1,allowNegative:!1}),h.get("VideoInputCapsEx").done(function(a){a&&a.FaceAutoExposure&&a.FaceAutoExposure.Support&&(r=!0,l.$("#i_f_expo").show(),l.$("#i_f_expo_light, #i_f_expo_time").slider({min:0,max:100}),l.$("#i_f_expo_enable").on("click",function(){l.$(this).prop("checked")&&!l.$("#i_f_enable").prop("checked")&&l.$("#i_f_tip").tip("warning",tl("isEnableFacetect"))}),l.$("#i_f_enable").on("click",function(){!l.$(this).prop("checked")&&l.$("#i_f_expo_enable").prop("checked")&&l.$("#i_f_tip").tip("warning",tl("isDisableFacetect"))}))}),e.DevVideoEncode.getCaps().done(function(a){a&&a.DynamicTrackROI&&l.$("#i_f_enhance").prop("disabled",!1)}),h.get("IVSCaps").done(function(a){if(webCaps.is_new_IVSUI!==!0){var b=j.getIntellMutexTip("FaceDetection",a||{});b&&(m.add("intell",b),m.setCtrl("intell",!0)),m.add("tvout",'<span t="IntellMutexTVOut">'+tl("IntellMutexTVOut")+"</span>")}l.render()}),-1!==webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC")&&(s=!1,l.$("#i_f_target").parent().hide().prev().hide()),l.$("#i_f_enable").on("click",function(){-1===webApp.DeviceType.indexOf("TPC")&&(n.Enable=this.checked,this.checked?m.show():m.hide(),g.SetIVSConfig("",1),l._initTarget())}),-1!==webApp.DeviceType.indexOf("TPC")?(e.VideoInAnalyse.getTemplateRule("All").done(function(a){t=-1!==webApp.DeviceType.indexOf("SD")?a.SDFaceDetect.FaceDetection.Config.SizeFilter:a.FaceDetection.FaceDetection.Config.SizeFilter}),l.$("#i_f_max").on("click",function(){l.$(this).prop("checked",!0),g.SelectOneIntelShape(w[1],!0),g.SelectOneIntelShape(w[0],!1),l._renderSizeFilter(n.Config.SizeFilter,!0)}),l.$("#i_f_min").on("click",function(){l.$(this).prop("checked",!0),g.SelectOneIntelShape(w[0],!0),g.SelectOneIntelShape(w[1],!1),l._renderSizeFilter(n.Config.SizeFilter,!0)}),l.$("#i_f_enhance").parent().parent().hide(),l.$("#i_f_alacount").parent().show()):(l.$("#i_f_max").on("click",function(){l.$(this).prop("checked",!0),l._targetRule()}),l.$("#i_f_min").on("click",function(){l.$(this).prop("checked",!0),l._targetRule()}))},render:function(){webCaps.is_new_IVSUI!==!0&&m.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),g.cover("#i_f_video",function(a){g.SetRegionNum(0),g.SetModuleMode(2),-1!==webApp.DeviceType.indexOf("TPC")?(login.chkAuthority("Monitor_01")&&(g.SetVisibleVideoWnd(1,0),g.ConnectRealVideoEx(0,0,0)),a&&l._initTarget()):g.open()}),-1!==webApp.DeviceType.indexOf("TPC")?(e.ConfigManager.getConfig(["HeatImagingThermometry","CalibratePoints"]).done(function(a){a&&a[0]&&"Centigrade"==a[0].params.table.TemperatureUnit?(l.$("#i_f_t_value").numberfield({min:0,max:100,allowDecimal:!1,allowNegative:!1}),l.$("#i_f_t_value").next("span").text("(0~100)")):(l.$("#i_f_t_value").numberfield({min:32,max:212,allowDecimal:!1,allowNegative:!1}),l.$("#i_f_t_value").next("span").text("(32~212)")),-1!==webApp.DeviceType.indexOf("-T")&&a[1].params.table.Enable?(x=!0,l.$("[thermal]").show()):l.$("[thermal]").hide(),l._getConfig(!1)}),g.addEvent("VideoAnalyzeConfig",function(a){var b=JSON.decode(a),c=b.ShapeData.RectangleShape,d=b.EventParam.ShapeID,e=Math.abs(c[1][0]-c[0][0]),f=Math.abs(c[1][1]-c[0][1]);"BigFilter"==d?(n.Config.SizeFilter.MaxSize=[e,f],l.$("#i_f_max").prop("checked",!0)):(n.Config.SizeFilter.MinSize=[e,f],l.$("#i_f_min").prop("checked",!0)),g.SelectOneIntelShape(d,!0),l._renderSizeFilter(n.Config.SizeFilter,!0)})):(g.addEvent("OutPutStringInfo",function(a,b){if("OutPutObjectRect"===a){var c=JSON.parse(b);c.MinRect?n.Config.SizeFilter.MinSize=c.MinRect:c.MaxRect&&(n.Config.SizeFilter.MaxSize=c.MaxRect),l._renderSizeFilter(n.Config.SizeFilter,!0),l.$("#i_f_max, #i_f_min").prop("disabled",!1)}}),l._getConfig(!1))},leave:function(){-1!==webApp.DeviceType.indexOf("TPC")?(g.addEvent("VideoAnalyzeConfig",null),u&&g.DeleteAllIntelShape(u)):g.addEvent("OutPutStringInfo",null),g.hide(),g.close()},_getConfig:function(a){var b=["VideoAnalyseRule","VideoEncodeROI"];x&&b.push("FaceRadiometry"),r&&b.push("VideoInFaceAutoExposure"),e.ConfigManager.getConfig(b).done(function(b){k.chkMutilCallRet(b)?(l._renderElements(b),a&&l.$("#i_f_tip").tip("success",tl("Operateingsuccess"))):l.$("#i_f_tip").tip("error",tl("Operateingfailure"))})},_renderElements:function(b,c){l.$("#i_f_max, #i_f_min").prop("disabled",!1);var d=b[0].params.table,e=analyseSenceRuleMap.FaceDetection?analyseSenceRuleMap.FaceDetection:0;a.each(d[e],function(a,b){return"FaceDetection"===b.Type?(n=b,!1):void 0}),n.Config.SizeFilter||(n.Config.SizeFilter={},-1!==webApp.DeviceType.indexOf("TPC")?(n.Config.SizeFilter.MinSize=t.MinSize,n.Config.SizeFilter.MaxSize=t.MaxSize):(n.Config.SizeFilter.MaxSize=[8191,8191],n.Config.SizeFilter.MinSize=[500,500])),l.$("#i_f_enable").prop("checked",n.Enable),l.$("#i_f_alacount").numberfield("value",n.Config.TriggerTargets||1),l.$("#i_f_event").eventHandler("set",n.EventHandler),l._renderSizeFilter(n.Config.SizeFilter),c!==!1&&(p=b[1].params.table,l.$("#i_f_enhance").prop("checked",p[0].DynamicTrack)),x&&(q=r?b[b.length-2].params.table:b[b.length-1].params.table,l.$("#i_f_t_enable").prop("checked",q[0].Enable),l.$("#i_f_t_value").numberfield("value",q[0].threshold||0)),r&&(o=b[b.length-1].params.table,l.$("#i_f_expo_enable").prop("checked",o[0].Enable),l.$("#i_f_expo_light").slider("value",o[0].TargetBrightness),l.$("#i_f_expo_time").slider("value",o[0].Interval))},_renderSizeFilter:function(b,c){s&&(!c&&l._initTarget(),a.each(l.$("#i_f_target").find("input[type=text]"),function(a,c){var d=c.name.split("-");l.$(this).val(b[d[0]][parseInt(d[1])])}))},onDrawTarget:function(){if(-1!==webApp.DeviceType.indexOf("TPC")){if(!n||!g)return;v?null==w[0]&&null==w[1]?(v=null,l._targetTPCRule("BigSmallFilterBox")):w[0]&&null==w[1]?l._targetTPCRule("BigFilter"):w[1]&&null==w[0]&&l._targetTPCRule("SmallFilter"):l._targetTPCRule("BigSmallFilterBox")}else{if(!l.$("#i_f_enable").prop("checked"))return;if(l.$("#i_f_max").prop("disabled"))return void l.$("#i_f_tip").tip("error",tl("Please draw shape"));l._targetRule()}},clearTarget:function(){if(-1!==webApp.DeviceType.indexOf("TPC")){if(!n||!n.Config.SizeFilter||!g||0==w.length)return;l.$("#i_f_max").prop("checked")?(n.Config.SizeFilter.MaxSize=[8191,8191],g.DeleteOneIntelShape(w[1]),w[1]=null):(n.Config.SizeFilter.MinSize=[0,0],g.DeleteOneIntelShape(w[0]),w[0]=null)}else{if(!l.$("#i_f_enable").prop("checked")||!n||!n.Config.SizeFilter)return;if(l.$("#i_f_max").prop("disabled"))return void l.$("#i_f_tip").tip("error",tl("Please draw shape"));l.$("#i_f_max").prop("checked")?(g.DeleteShape("MaxRect"),g.AddShape(5,"","MaxRect",0,-1)):(g.DeleteShape("MinRect"),g.AddShape(5,"","MinRect",0,-1)),l.$("#i_f_max, #i_f_min").prop("disabled",!0)}},_initTarget:function(){if(-1!==webApp.DeviceType.indexOf("TPC"))u&&(g.RemoveOneIntelShapeContainer(u),u=null,v=null,w=[]),l._targetTPCRule("BigSmallFilterBox");else{if(g.SetIVSConfig("",1),!l.$("#i_f_enable").prop("checked"))return;if(n&&n.Config.SizeFilter){var a={};a.MaxRect=n.Config.SizeFilter.MaxSize,a.MinRect=n.Config.SizeFilter.MinSize,g.SetObjectConfig(JSON.stringify(a)),g.SetCurPtzID(0)}}},_targetRule:function(){l.$("#i_f_enable").prop("checked")&&n&&n.Config.SizeFilter&&(l.$("#i_f_max").prop("checked")?d(n.Config.SizeFilter.MaxSize)?g.AddShape(5,"","MaxRect",0,-1):g.SetCurShape("MaxRect"):d(n.Config.SizeFilter.MinSize)?g.AddShape(5,"","MinRect",0,-1):g.SetCurShape("MinRect"))},_targetTPCRule:function(b){function c(b){var c={RectangleShape:f[b]};return c=JSON.encode(c),a.Deferred(function(a){g.AddOneSubIntelShape(u,v,"RectangleShape","VideoAnalyzeConfig",b,"",c,"").done(function(b){g.SetOneIntelShapeDisplayColor(b,0,0,255,255),g.SetOneIntelShapeDisplayColor(b,1,0,255,255),g.SetOneIntelShapeThickness(b,1),a.resolve(b)}).fail(function(){a.reject()})}).promise()}var d=n.Config.SizeFilter.MinSize,e=n.Config.SizeFilter.MaxSize,f={};if(f.SmallFilter=[[(8191-d[0])/2,(8191-d[1])/2],[(8191+d[0])/2,(8191+d[1])/2]],f.BigFilter=[[(8191-e[0])/2,(8191-e[1])/2],[(8191+e[0])/2,(8191+e[1])/2]],u||g.CreateOneIntelShapeContainer(0,"").done(function(a){u=a}),"BigSmallFilterBox"==b)v&&g.DeleteOneIntelShape(v),g.CreateOneIntelShape(u,b,"VideoAnalyzeConfig",b,"","","").done(function(a){v=a,w=[],c("SmallFilter").done(function(a){w.push(a),c("BigFilter").done(function(a){w.push(a)})})});else{var h="SmallFilter"==b?0:1;c(b).done(function(a){w[h]=a})}l.$("#i_f_max").prop("checked")?(g.SelectOneIntelShape(w[1],!0),g.SelectOneIntelShape(w[0],!1)):(g.SelectOneIntelShape(w[0],!0),g.SelectOneIntelShape(w[1],!1))},onDefault:function(){var a=["VideoAnalyseRule"];x&&a.push("FaceRadiometry"),r&&a.push("VideoInFaceAutoExposure"),e.ConfigManager.getDefault(a).done(function(a){k.chkMutilCallRet(a)?(l._renderElements(a,!1),l.$("#i_f_tip").tip("success",tl("Defaultsuccess"))):l.$("#i_f_tip").tip("error",tl("Defaultfailure"))})},onRefresh:function(){l._getConfig(!0)},onConfirm:function(){if(-1===webApp.DeviceType.indexOf("TPC")&&l.$("#i_f_max").prop("disabled"))return void l.$("#i_f_tip").tip("error",tl("Please draw shape"));var b=["VideoAnalyseRule","VideoEncodeROI"],c=[n,p];g.SetCurShape("save"),n.Enable=l.$("#i_f_enable").prop("checked"),n.Config.TriggerTargets=l.$("#i_f_alacount").numberfield("value"),n.EventHandler=l.$("#i_f_event").eventHandler("get"),p[0].DynamicTrack=l.$("#i_f_enhance").prop("checked"),x&&(q[0].Enable=l.$("#i_f_t_enable").prop("checked"),q[0].threshold=l.$("#i_f_t_value").numberfield("value"),b.push("FaceRadiometry"),c.push(q)),r&&(o[0].Enable=l.$("#i_f_expo_enable").prop("checked"),o[0].TargetBrightness=l.$("#i_f_expo_light").slider("value"),o[0].Interval=l.$("#i_f_expo_time").slider("value"),b.push("VideoInFaceAutoExposure"),c.push(o)),e.ConfigManager.getConfig("VideoAnalyseRule").done(function(d){var f=analyseSenceRuleMap.FaceDetection?analyseSenceRuleMap.FaceDetection:0;a.each(d[f],function(a,g){return"FaceDetection"===g.Type?(d[f][a]=n,c[0]=d,e.ConfigManager.setConfig(b,c).done(function(a){k.chkMutilCallRet(a)?l.$("#i_f_tip").tip("success",tl("Succeed in saving configure")):l.$("#i_f_tip").tip("error",tl("Saving failure"))}),!1):void 0})}).fail(function(){l.$("#i_f_tip").tip("error",tl("Saving failure"))})},onSetPeriod:function(){n&&n.EventHandler&&n.EventHandler.TimeSection&&(g.hide(),i.open(n.EventHandler.TimeSection).done(function(a){n.EventHandler.TimeSection=a}).always(function(){g.cover("#i_f_video")}))}})})}(jQuery);