!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("https",function(require,b,c){var d=require("jsCore/rpc"),e=require("common/rpcBase"),f=require("jsCore/pageBase"),g=null,h=null,i={},j={},k=[],l=null,m=require("common/common"),n=m.Check,o=!1,p=!1;c.exports=f.extend({init:function(){g=this,g.$("#https_enable").on("change",function(){g._renderButton()}),l=g.$("#https_addDialog").dialog({save:function(){g._onSave()}}).detach().appendTo(document.body),l.find("[cfg=CommonName], [cfg=Email]").textfield(),l.find("[cfg=State], [cfg=Locatity], [cfg=Organization],[cfg=OrganizationUnit]").textfield(),l.find("[cfg=UsefulLife]").numberfield({min:1,max:5e3,allowDecimal:!1,allowNegative:!1}),l.find("[cfg=Country]").textfield({validReg:/^[a-zA-Z]*$/,validRegRet:!0,errorHandle:"prevent"}),l.find("[cfg=Country]").keyup(function(a){a.target.value=a.target.value.toUpperCase()}),h=a.validator([{element:l.find("[cfg=Country]"),check:function(a){return/^[a-zA-Z]{2}$/.test(a)},errorMsg:["w_Need2Caps"],events:["blur"],errorElem:".u-input-error"},{element:l.find("[cfg=CommonName]"),check:[n.require],errorMsg:["w_Need"],events:["blur"],errorElem:".u-input-error"},{element:l.find("[cfg=Email]"),check:function(a){return a?/^[\w-.]+@[\w-]+(\.{1}[\w-]+)+$/.test(a):!0},errorMsg:["w_WrongEmailFormat"],events:["blur"],errorElem:".u-input-error"}],function(a){a.parent().translation()}),g.$("#cert_path, #key_path, #installed_cert_path, #cert_createdRequest").textfield(),g.render()},render:function(){g.$("#cert_path").textfield("value",""),g.$("#key_path").textfield("value",""),g.$("#installed_cert_path").textfield("value",""),g.$("#cert_createdRequest").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),p=!1,d.ConfigManager.getConfig("Https").done(function(a){i=a,g.$("#https_enable").prop("checked",i.Enable),o=""===i.ServerCertificate.CommonName?!1:!0,o&&e.CertManager.getSvrCertInfo().done(function(a){j=a,g._renderElements()}).fail(function(){g.tip("error","w_connectFailed")}),g._renderButton()}).fail(function(){g.tip("error","w_connectFailed"),g._renderButton()}),"https:"===window.location.protocol.toLowerCase()&&g.$("#https_enable").prop("disabled",!0)},onRefresh:function(){g.$("#https_enable").prop("checked",i.Enable),g.$("#cert_path").textfield("value",""),g.$("#key_path").textfield("value",""),g.$("#installed_cert_path").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),g.$("#cert_createdRequest").textfield("value",""),p=!1,d.ConfigManager.getConfig("Https").done(function(a){i=a,o=""===i.ServerCertificate.CommonName?!1:!0,o&&e.CertManager.getSvrCertInfo().done(function(a){j=a,g._renderElements(),g.tip("success","Operateingsuccess")}).fail(function(){return g.tip("error","Operateingfailure"),!1}),g._renderButton(),g.tip("success","Operateingsuccess")}).fail(function(){g.tip("error","Operateingfailure"),g._renderButton()})},onConfirm:function(){g.$("#https_enable").prop("checked")!==i.Enable?(g.$("#installed_cert_path").textfield("value",""),g.$("#installed_cert_info0").text(""),g.$("#installed_cert_info1").text(""),g.$("#installed_cert_info2").text(""),g.onRequestInstall()):g.tip("success","Operateingsuccess")},destory:function(){l.remove()},_renderElements:function(){g.$("#https_download_cert").attr("src",""),a.each(l.find("[cfg]"),function(b,c){var d=a(c).attr("cfg");"UsefulLife"===d?a(c).numberfield("value",i.ServerCertificate[d]):a(c).textfield("value",i.ServerCertificate[d])});var b=g._toLocalTime(j.usefulLife.Start),c=g._toLocalTime(j.usefulLife.End);g.$("#installed_cert_path").textfield("value","H/IP="+i.ServerCertificate.CommonName+";C="+i.ServerCertificate.Country+";ST="+i.ServerCertificate.State+";L="+i.ServerCertificate.Locatity+";O="+i.ServerCertificate.Organization+";OU="+i.ServerCertificate.OrganizationUnit+";EM="+i.ServerCertificate.Email);var d=tl("w_subject")+" H/IP="+j.subject.CommonName+"; C="+j.subject.Country+"; ST="+j.subject.State+"; L="+j.subject.Locality+"; O="+j.subject.Organization+"; OU="+j.subject.OrganizationUnit+"; EM="+j.subject.Email+";",e=tl("w_issuer")+" H/IP="+j.issuer.CommonName+"; C="+j.issuer.Country+"; ST="+j.issuer.State+"; L="+j.issuer.Locality+"; O="+j.issuer.Organization+"; OU="+j.issuer.OrganizationUnit+"; EM="+j.issuer.Email+";",f=tl("w_usefulLife")+": "+b+"~"+c;g.$("#cert_info_subject").text(d),g.$("#cert_info_issuer").text(e),g.$("#cert_info_usefullife").text(f),g._renderButton(),h.validate()},_renderButton:function(){var a=g.$("#https_enable").prop("checked");return i.Enable?(g.disabled(".ui-button",!0),g.$(".ui-button").addClass("ui-button-disabled"),g.disabled(".cert-btn3",!1),g.$(".cert-btn3").removeClass("ui-button-disabled"),!1):(o?a?(g.disabled(".ui-button",!0),g.$(".ui-button").addClass("ui-button-disabled")):p?(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6",!0),g.$(".cert-btn0,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6").addClass("ui-button-disabled")):(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn1,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6",!0),g.$(".cert-btn0,.cert-btn1,.cert-btn2,.cert-btn4,.cert-btn5,.cert-btn6").addClass("ui-button-disabled")):(g.$("#installed_cert_path").textfield("value",""),g.$("#cert_info_subject").text(""),g.$("#cert_info_issuer").text(""),g.$("#cert_info_usefullife").text(""),a?(g.tip("error","w_CertificateNotAvailible"),g.$("#https_enable").prop("checked",!1)):p?(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn0,.cert-btn3,.cert-btn6,.cert-btn7",!0),g.$(".cert-btn0,.cert-btn3,.cert-btn6,.cert-btn7").addClass("ui-button-disabled")):(g.disabled(".ui-button",!1),g.$(".ui-button").removeClass("ui-button-disabled"),g.disabled(".cert-btn1,.cert-btn2,.cert-btn3,.cert-btn6,.cert-btn7",!0),g.$(".cert-btn1,.cert-btn2,.cert-btn3,.cert-btn6,.cert-btn7").addClass("ui-button-disabled"))),g.disabled(".cert-btn3",!1),g.$(".cert-btn3").removeClass("ui-button-disabled"),void 0)},onRequestDelete:function(){g.$("#cert_createdRequest").textfield("value",""),p=!1,g._renderButton(),g.tip("success","Operateingsuccess")},onRequestInstall:function(){i.Enable=g.$("#https_enable").prop("checked"),d.ConfigManager.setConfig("Https",i).done(function(a){e.CertManager.getSvrCertInfo().done(function(b){j=b,o=!0,g._renderElements(),webApp.isNeedReboot(a)&&webApp.reboot("The configration take effect! The device is restarting now,please reconnect later...")}).always(function(){g.tip("success","Operateingsuccess")})}).fail(function(){g.tip("error","Operateingfailure")})},onRequestDownload:function(){return a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("saveFile","RootCert",[{description:"(*.cer)",extensions:["cer"]}]).done(function(a){e.CertManager.exportRootCert().done(function(b){var c=Base64.decode(b.params.cert);plugin.WriteFile(c,"w+",a[1]).done(function(a){-1===a?g.tip("error","Operateingfailure"):g.tip("success","Operateingsuccess")})}).fail(function(){g.tip("error","Operateingfailure")})}):g.tip("error","w_NeedPlugin"),!1},onCertDelete:function(){e.CertManager.removeSvrCert().done(function(){o=!1,g.onRefresh(),g.tip("success","w_Delsuccess")}).fail(function(){g.tip("error","w_Delfail")})},onCertSelect:function(){return a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("openFile","",[{description:"cacert (*.pem)",extensions:["pem"]}]).done(function(a){a[1].split("\\");k[0]=a[1],g.$("#cert_path").textfield("value",a[1]),""!==g.$("#key_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled"))}):g.tip("error","w_NeedPlugin"),!1},onKeySelect:function(){return a("#ocx")[0]?plugin.ShowSaveOrOpenDlg("openFile","",[{description:"privkey(*.pem)",extensions:["pem"]}]).done(function(a){a[1].split("\\");k[1]=a[1],g.$("#key_path").textfield("value",a[1]),""!==g.$("#cert_path").textfield("value")&&(g.disabled(".cert-btn6",!1),g.$(".cert-btn6").removeClass("ui-button-disabled"))}):g.tip("error","w_NeedPlugin"),!1},onCertUpload:function(){var a={};plugin.ReadFile(k[0]).done(function(b){a.cert=Base64.encode(b)}),plugin.ReadFile(k[1]).done(function(b){a.key=Base64.encode(b)}),m.EncryptInfo(webApp.EncryptInfo.pub,{cert:a.cert,key:a.key}).done(function(a){d.CertManager.importSvrCert(a.salt,"AES-128",a.content).done(function(){o=!0,g.render(),g.tip("success","w_uploadSuccess")}).fail(function(){g.tip("error","w_uploadFail")})})},openDialog:function(){l.dialog("show"),l.find("[cfg=Country]").textfield("value",""),l.find("[cfg=CommonName]").textfield("value",""),l.find("[cfg=Email]").textfield("value",""),l.find("[cfg=State]").textfield("value","none"),l.find("[cfg=Locatity]").textfield("value","none"),l.find("[cfg=Organization]").textfield("value","none"),l.find("[cfg=OrganizationUnit]").textfield("value","none"),l.find("[cfg=UsefulLife]").numberfield("value",365)},_toLocalTime:function(a){var b=a.split(" "),c=b[0].split("-"),d=b[1].split(":"),e=new Date(c[0]-0,c[1]-0,c[2]-0,d[0]-0,d[1]-0,d[2]-0),f=e.getTimezoneOffset();return e.addMonths(-1).addSeconds(60*-f),e.format()},_onSave:function(){return h.validate(),h.isInvalid()?l.find("#httpDiaTip").tip("warning",tl(h.errors()[0].errorMsg)):(a.each(l.find("[cfg]"),function(b,c){var d=a(c).attr("cfg");i.ServerCertificate[d]="UsefulLife"===d?a(c).numberfield("value")-0:a(c).textfield("value")}),""===i.ServerCertificate.State&&(i.ServerCertificate.State="none"),""===i.ServerCertificate.Locatity&&(i.ServerCertificate.Locatity="none"),""===i.ServerCertificate.Organization&&(i.ServerCertificate.Organization="none"),""===i.ServerCertificate.OrganizationUnit&&(i.ServerCertificate.OrganizationUnit="none"),l.dialog("close"),g.$("#cert_createdRequest").textfield("value","H/IP="+i.ServerCertificate.CommonName+";C="+i.ServerCertificate.Country+";ST="+i.ServerCertificate.State+";L="+i.ServerCertificate.Locatity+";O="+i.ServerCertificate.Organization+";OU="+i.ServerCertificate.OrganizationUnit+";EM="+i.ServerCertificate.Email),p=!0,void g._renderButton())}})})}(jQuery);