!function(a){define(function(require,a,b){b.exports=require("jsCore/pageTab")}),define("upnp",function(require,b,c){var d=require("jsCore/rpc"),e=require("jsCore/pageBase"),f=null,g={},h=0,i=[],j=null;c.exports=e.extend({init:function(){f=this,j=f.$("#modify").dialog({save:function(){f._onModifyItem()}}).detach().appendTo(document.body),f.$("#upnp_tableList_th").empty();var a='<table cellpadding="0" cellspacing="0">                    <tr>                        <th class="fn-widp10"></th>                        <th class="fn-widp20" t="w_ServerName">'+tl("w_ServerName")+'</th>                        <th class="fn-widp15" t="w_Protocol">'+tl("w_Protocol")+'</th>                        <th class="fn-widp15" t="w_Inner Port">'+tl("w_Inner Port")+'</th>                        <th class="fn-widp15" t="w_Outer Port">'+tl("w_Outer Port")+"</th>";isEnable("is_show_upnpMode")&&(a+='<th class="fn-widp15" t="w_State">'+tl("w_State")+"</th>"),a+='<th><span t="w_Amend">'+tl("w_Amend")+"</span></th>                    </tr>                </table>",f.$("#upnp_tableList_th").html(a),f.$("#upnp_status_label").text(tl(isEnable("is_show_upnpMode")?"w_RouterState":"w_State")),j.find("#upnp_modify_oute_port").numberfield({min:1,max:65535,allowDecimal:!1,allowNegative:!1}),f.render()},render:function(){d.ConfigManager.getConfig("UPnP").done(function(a){g=a,f._renderElement()})},destory:function(){j.remove()},_renderElement:function(){f.$("#upnp_enable").prop("checked",g.Enable),f.$("#upnp_discover, #upnp_mode_label, [sel-for=onSelMode]").hide(),isEnable("is_show_startDeviceDiscover")&&void 0!=g.StartDeviceDiscover&&(f.$("#upnp_discover").show(),f.$("#upnp_discover_check").prop("checked",g.StartDeviceDiscover)),isEnable("is_show_upnpMode")&&g.Mode&&(f.$("#upnp_mode_label, [sel-for=onSelMode]").show(),f.$("[sel-for=onSelMode]").val(g.Mode),g.Enable&&"Auto"==g.Mode&&setTimeout(f._refreshMapStatus,5e3)),f._getUPnPStatus()},_onModifyItem:function(){var a={};return a.Enable=j.find("#upnp_modify_enable_on").is(":checked"),a.ServiceName=g.MapTable[h].ServiceName,a.ServiceType=g.MapTable[h].ServiceType,a.Protocol=j.find("#upnp_modify_protocol").text(),a.InnerPort=j.find("#upnp_modify_inner_port").text()-0,a.OuterPort=j.find("#upnp_modify_oute_port").val()-0,""==a.ServiceName||""==a.InnerPort||""==a.OuterPort?f.$("#modify").tip("warning","Inputing is invalid"):(g.MapTable[h]=a,f.$("#upnp_item_"+h+" td input").prop("checked",a.Enable),f.$("#upnp_item_"+h+" td")[1].innerHTML=f._getDisplayServiceName(a),f.$("#upnp_item_"+h+" td")[2].innerHTML=(a.ServiceType||a.ServiceName)+":"+a.Protocol,f.$("#upnp_item_"+h+" td")[3].innerHTML=a.InnerPort,f.$("#upnp_item_"+h+" td")[4].innerHTML=a.OuterPort,j.dialog("close"),void f.$("#upnp_item_"+h).addClass("ui-table-tr-current"))},_refreshMapStatus:function(){Site.currentPage.is.UPnPConfig&&d.ConfigManager.getConfig("UPnP").done(function(a){g=a,f._getUPnPStatus()})},_getUPnPStatus:function(){webApp.IsNewProtocol?d.UPnPPortmap.getUPnPStatus().done(function(a){f._setUPnPStatus(a)}):d.NetApp.getUPnPStatus().done(function(a){f._setUPnPStatus(a)})},_setUPnPStatus:function(b){f.$("#upnp_status").text(tl(b.Working?"w_Mapping Succeed":"w_Mapping Unkown")),isEnable("is_show_upnpMode")&&(i=[],a.each(g.MapTable,function(a){i.push(b.Working?"Success"==b.PortMapStatus[a]?tl("w_Mapping Succeed"):"Failed"==b.PortMapStatus[a]?tl("w_Mapping Unkown"):tl("w_Mapping Error"):tl("w_Mapping Unkown"))})),f._showMappingList()},_showMappingList:function(){if(g.MapTable){isEnable("is_show_upnpMode")&&0==i.length&&a.each(g.MapTable,function(){i.push(tl("w_Mapping Unkown"))});var b='<table cellpadding="0" cellspacing="0">';a.each(g.MapTable,function(a,c){var d=c,e=d.Enable?"checked":"",h=a%2?"":"ui-table-tr-odd",j=f._getDisplayServiceName(d);b+='<tr id="upnp_item_'+a+'" class="upnp_item '+h+'">',b+='<td class="fn-widp10"><input class="upnp_item_enable" id="upnp_item_enable_'+a+'"  '+e+' type="checkbox"/></td>',b+='<td class="fn-widp20" '+(isEnable("is_show_upnpMode")?'data-service-name="'+d.ServiceName+'"':"")+">"+j+"</td>",b+='<td class="fn-widp15">'+(isEnable("is_show_upnpMode")?(d.ServiceType||d.ServiceName)+":":"")+d.Protocol+"</td>",b+='<td class="fn-widp15">'+d.InnerPort+"</td>",b+='<td class="fn-widp15">'+d.OuterPort+"</td>",b+=isEnable("is_show_upnpMode")?'<td class="fn-widp15">'+i[a]+"</td>":"",b+=g.Mode&&isEnable("is_show_upnpMode")?'<td class="fn-widp10"><i class="ui-table-icon-edit '+(0==f.$("[sel-for=onSelMode]").get(0).selectedIndex?"":"ui-table-icon-edit-disabled")+' user_changeUserInfo"></i></td>':'<td class="fn-widp10"><i class="ui-table-icon-edit ui-table-icon-edit-disabled user_changeUserInfo" id="user_item_changeuser_0" style="cursor:pointer;"></i></td>',b+="</tr>"}),b+="</table>",f.$("#upnp_list").html(b),f.$('tr[id*="upnp_item"]').on("click",function(){f.$(".upnp_item").removeClass("ui-table-tr-current"),f.$(this).addClass("ui-table-tr-current")}),f.$(".upnp_item_enable").click(function(){var a=this.id.replace(/[^\d]/g,"");g.MapTable[a].Enable=f.$(this).is(":checked")}),f.$(".user_changeUserInfo").click(function(){a(this).hasClass("ui-table-icon-edit-disabled")||(h=f.$(this).closest("tr").prop("id").replace(/[^\d]/g,""),j.dialog("show"),j.find("#upnp_modify_enable_"+(g.MapTable[h].Enable?"on":"off")).prop("checked",!0),j.find("#upnp_modify_inner_port").text(g.MapTable[h].InnerPort),j.find("#upnp_modify_oute_port").val(g.MapTable[h].OuterPort),j.find("#upnp_modify_protocol").text(g.MapTable[h].Protocol))})}},_getDisplayServiceName:function(a){if(a.ServiceType&&a.ServiceName)return a.ServiceName;var b=a.ServiceType||a.ServiceName;return"WebService"==b?"HTTP":"PrivService"==b?a.Protocol:"RTSPService"==b?"RTSP":""},onSelMode:function(){"Manual"==f.$("[sel-for=onSelMode]").val()?f._getUPnPStatus():d.ConfigManager.getConfig("UPnP").done(function(a){g=a,f._getUPnPStatus()})},onDefault:function(){d.ConfigManager.getDefault("UPnP").done(function(a){g=a,f._renderElement(),f.tip("success","Defaultsuccess")}).fail(function(){f.tip("error","Defaultfailure")})},onRefresh:function(){d.ConfigManager.getConfig("UPnP").done(function(b){return g=b,isEnable("is_show_upnpMode")?(f.$("#upnp_enable").prop("checked",g.Enable),f.$("[sel-for=onSelMode]").val(g.Mode),void(g.Enable?webApp.IsNewProtocol?d.UPnPPortmap.refreshUpnpRouter().done(function(){f.disabled("[btn-for=onDefault], [btn-for=onRefresh], [btn-for=onConfirm]"),f.tip("warning","w_onfresh"),setTimeout(function(){f.disabled("[btn-for=onDefault], [btn-for=onRefresh], [btn-for=onConfirm]",!1),f._getUPnPStatus(),f.tip("success","Operateingsuccess")},5e3)}):d.NetApp.refreshUpnpRouter().done(function(){f.disabled("[btn-for=onDefault], [btn-for=onRefresh], [btn-for=onConfirm]"),f.tip("warning","w_onfresh"),setTimeout(function(){f.disabled("[btn-for=onDefault], [btn-for=onRefresh], [btn-for=onConfirm]",!1),f._getUPnPStatus(),f.tip("success","Operateingsuccess")},5e3)}):(f.$("#upnp_status").text(tl("w_Mapping Unkown")),a.each(i,function(a){i[a]=tl("w_Mapping Unkown")}),f._showMappingList(),f.tip("success","Operateingsuccess")))):f._renderElement()}).fail(function(){return f.tip("error","Operateingfailure")})},onConfirm:function(){g.Enable=f.$("#upnp_enable").is(":checked"),isEnable("is_show_startDeviceDiscover")&&void 0!=g.StartDeviceDiscover&&(g.StartDeviceDiscover=f.$("#upnp_discover_check").is(":checked")),g.Mode&&isEnable("is_show_upnpMode")&&(g.Mode=f.$("[sel-for=onSelMode]").val(),g.Enable&&"Auto"==g.Mode&&f._refreshMapStatus()),d.ConfigManager.setConfig("UPnP",g).done(function(){f.tip("success","Succeed in saving configure")}).fail(function(){f.tip("error","Saving failure")})}})})}(jQuery);