define(function(require){var a,b={},c={},d=require("jsCore/modules/eventHandler"),e=require("jsCore/rpc"),f=require("jsCore/modules/timeSection"),g=require("jsCore/rpcLogin"),h=require("jsCore/plugin"),k=require("jsCore/ability"),l=require("common/common");require("widget/js/dui.iconlist"),require("widget/js/dui.iconSelect");var m,n=require("PtzCmd"),o={LeftDetection:[6,3600],TakenAwayDetection:[6,3600],WanderDetection:[1,600],MoveDetection:[6,300],RioterDetection:[10,300],ParkingDetection:[6,300]},p=[],q=[],r=!1,s=null,t=0;!function(){var d=Page.ivsConfig={Tab:[],current:null,init:function(){k.get("IntelliTracker").done(function(a){f.init(webApp.DeviceType.contains("TPC")&&!webApp.DeviceType.contains("SD")?!1:a&&a.Support),a&&a.Support&&($$('div[data-wrap="TrackEnable"]').removeClass("fn-hide"),r=!0,isEnable("no_need_track_duration")&&$("ipcIntellentNew_TrackTime").getParent().addClass("fn-hide")),n.init("ivsSdPtzWrap",{markScene:a&&a.Support,setPreset:!0})}),k.get("IVSCaps").done(function(a){if(a){for(var c in a.SupportedScenes.Normal.SupportedRules)b[c]=[],"SmokeDetection"!=c&&p.push(c);-1!==p.indexOf("HeatMap")&&p.splice(p.indexOf("HeatMap"),1),-1!==p.indexOf("VideoAbnormalDetection")&&p.splice(p.indexOf("VideoAbnormalDetection"),1),$("ipcIntellentNew_Global_tab").setStyle("display",""),$("ipcIntellentNew_CrossLineDetection_tab").setStyle("display",""),$("ipcIntellentNew_CrossLineDetection_tab").setProperty("t","Config");var e=a.SupportedScenes&&a.SupportedScenes.Normal.SupportedRules||[];$each(e,function(a,b){a.TriggerTrack&&(q.push(b),jQuery("#ipcIntellentNew_TrackTip").attr("t","w_TriggerTrack").text(tl("w_TriggerTrack")))})}Object.keys(b).length>6&&$$(".ipcIntellentNew_tab_title").setStyle("min-width","80px"),d.Tab["public"].init(),d.Tab.Global.init(),-1!==webApp.DeviceType.indexOf("TPC")&&webApp.CHANNEL_NUMBER>1&&r?(d.Tab.Track.init(),$("ipcIntellentNew_track_tab").setStyle("display","")):$("ipcIntellentNew_track_tab").setStyle("display","none"),d.translate(),d.bind(),d.render();var f=a.SupportedScenes.Normal.SupportedModuleParams;0==f.Shadow&&jQuery('#Global_TrackForm div[data-cap="Shadow"]').addClass("fn-hide"),0==f.AntiDisturbance&&jQuery('#Global_TrackForm div[data-cap="AntiDisturbance"]').addClass("fn-hide"),0==a.SupportedScenes.Normal.SupportedCalibrateParams.MaxCelibateAreas&&$("ipcIntellentNew_Global_tab").addClass("fn-hide")});"VideoAnalyseRule["+analyseSenceRuleMap.Normal+"]";e.VideoInAnalyse.getTemplateRule("All",0).done(function(a){d.parseDefaultConfig(a.Normal)}).fail(function(){e.DevVideoAnalyse.getTemplateRule("All").done(function(a){d.parseDefaultConfig(a)}).fail(function(){d.parseDefaultConfig()})}),-1===webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC")?jQuery('[data-show="SD"]').addClass("fn-hide"):-1!==webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC")?jQuery('[data-show="IPC"]').addClass("fn-hide"):-1!==webApp.DeviceType.indexOf("TPC")&&(jQuery('[data-show="SD"]').addClass("fn-hide"),jQuery('[data-show="TPC"]').removeClass("fn-hide"),jQuery('[data-showtwo="TPC"]').removeClass("fn-hide"))},destory:function(){f.leave(),p.empty()},translate:function(){$("page_ivsConfig").translation()},render:function(){e.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){a=b,$$(".ipcIntellentNew_tab_title.ui-tab-current").fireEvent("click")}),!isEnable("is_show_help")&&$("ipcIntellentNew_help").setStyle("display","none"),-1===webApp.DeviceType.indexOf("TPC")&&f.render(),e.ConfigManager.getConfig("Lighting").done(function(a){"Linking"===a[t][0].Mode?k.get("VideoInputCapsEx").done(function(a){a.LightingControl&&(capsLight=a.LightingControl,capsLight.LinkingDetail&&capsLight.LinkingDetail.FilckerLighting&&capsLight.LinkingDetail.FilckerLighting.Ability&&(m=capsLight.LinkingDetail.FilckerLighting.Ability.SupportIntelliScence.indexOf("Normal")>-1?!0:!1,g.init(capsLight)))}):(jQuery("#ivs_light_link").hide(),m=!1)})},bind:function(){$("ipcIntellentNew_help").addEvent("click",d._openHelp),$$(".ipcIntellentNew_tab_title").addEvent("click",d._onTabTitleClick)},_onTabTitleClick:function(){var a=this,b=this.getProperty("data-for");d.current!==d.Tab[b]&&d.current&&d.current.leave&&d.current.leave(),setTimeout(function(){$$(".ipcIntellentNew_tab_title").removeClass("ui-tab-current"),$$(".ipcIntellentNew_tab_con").setStyle("display","none"),a.addClass("ui-tab-current");var c=["CrossLineDetection","CrossRegionDetection","LeftDetection","VideoAbnormalDetection","WanderDetection","RioterDetection","MoveDetection","CrossFenceDetection"];if(c.contains(b)){var e="public";b="public"}else var e=b;$("ipcIntellentNew_tab_"+e).setStyle("display","block"),d._hideElement(),d.current=d.Tab[b],d.Tab[b].render()},20)},_hideElement:function(){$("ipcIntellentNew_remark1").setStyle("minWidth","310px"),$("ipcIntellentNew_remark1").setStyle("height","100%"),$("ipcIntellentNew_remark1").setStyle("visibility","hidden"),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-width310"),$$(".ipcIntellentNew_VideoAbnormalDetectionButton").removeClass("fn-marl140"),$$(".ipcIntellentNew_VideoAbnormalDetection").setStyle("display",""),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-left"),$("ipcIntellentNew_minDuration_wrap").setStyle("display","none"),$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","none"),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display","none"),$("ipcIntellentNew_actionWrap").setStyle("display","none"),$("ipcIntellentNew_fieldset").removeClass("intell-abnormal-fieldset"),$("ipcIntellentNew_fenceDirection_wrap").addClass("fn-hide"),$("ipcIntellentNew_object_filter_ck").setStyle("display",""),$("ipcIntellentNew_target_label").set("text",tl("w_aimFiltrate"))},_openHelp:function(){openHelp("ipcIntellentNewConfig.htm")},parseDefaultConfig:function(a){if(void 0===a||null===a)throw new Error("VideoInAnalyse.getTemplateRule(All) error!");c=a},leave:function(){f.leave(),h.close(),d.current&&d.current.leave&&d.current.leave(),d.current=null}},f={support:!1,status:"",timer:0,init:function(a){a=a===!0?!0:!1,this.support=a,1==a&&$("ipcIntellentNew_lockPtz_wrap").removeClass("fn-hide"),this.Traceer=e.DevIntelliTracker,$("ipcIntellentNew_lockPtz").set("text",tl("unlockPtz")+"(180s)")},render:function(){if(0!=this.support){var a=this;this.Traceer.getLockLeft().done(function(b){0==b?a.setLocktime(180):(a.renderDom(b),setTimeout(function(){a.getLocktime()},1e3))}).fail(function(){setTimeout(function(){remarkDisplay("ipcIntellentNew_remark1",tl("getLockLeft Error"),3e3,1)},1e3)})}},renderDom:function(a){var b=this,c=$("ipcIntellentNew_lockPtz");if(c){c.removeEvents("click");var d="";switch(a){case 0:d=tl("lockPtz")+"(180s)",c.addEvent("click",function(){b.setLocktime(180)}),b.status="unlocked";break;default:d=tl("unlockPtz")+"("+a+"s)",c.addEvent("click",function(){b.setLocktime(0)}),b.status="locking"}c.set("text",d)}},leave:function(){0!=this.support&&"locking"==this.status&&this.setLocktime(0)},disabledButton:function(a){var b=$("ipcIntellentNew_lockPtz");a?(this.leave(),b.setProperty("disabled",!0),b.addClass("ui-button-disabled")):(b.setProperty("disabled",!1),b.removeClass("ui-button-disabled"),this.render()),b=null},getLocktime:function(){var a=this;this.Traceer.getLockLeft().done(function(b){a.renderDom(b),"locking"==f.status?a.timer=setTimeout(function(){a.getLocktime()},1e3):$clear(a.timer)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("getLockLeft Error"),3e3,1)})},setLocktime:function(a){var b=this;this.Traceer.setLockDuration(a).done(function(){b.renderDom(a),b.getLocktime()}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("setLockDuration Error"),3e3,1)})}};s=f;var g={bind:function(){$("ivs_light_link_enable").addEvent("change",function(a){var b=a.target,c=b.checked;c?$("ivs_light_type").getParent().getParent().removeClass("fn-hide"):$("ivs_light_type").getParent().getParent().addClass("fn-hide")}),$("ivs_light_duration").addEvent("change",function(a){var b=a.target.value-0;b=Math.round(b)>b?parseInt(b)+.5:Math.round(b)<b?parseInt(b):b,$("ivs_light_duration").value=b})},init:function(a){var b={InfraredLight:"w_red_light",WhiteLight:"w_white_light",LaserLight:"w_laser_light"};jQuery("#ivs_light_link").show();var c=a.LinkingDetail.FilckerLighting;jQuery("#ivs_light_duration").numberfield({min:.1*c.FilckerIntevalTime[0]||0,max:.1*c.FilckerIntevalTime[1]||100,allowDecimal:!0,allowNegative:!1}),jQuery("#ivs_light_duration").next("span").next("span").text("("+.1*c.FilckerIntevalTime[0]+"~"+.1*c.FilckerIntevalTime[1]+")"),jQuery("#ivs_light_num").numberfield({min:c.FilckerTimes[0]||0,max:c.FilckerTimes[1]||100,allowDecimal:!1,allowNegative:!1}),jQuery("#ivs_light_num").next("span").next("span").text("("+c.FilckerTimes[0]+"~"+c.FilckerTimes[1]+")");var d=jQuery("#ivs_light_type").empty();jQuery.each(c.LightType,function(a,c){d.append("<option value="+c+" t="+b[c]+"></option>")}),d.translation()}}}(),function(){var a,b=null,c=null,d=null,f=null,i=null,j=null,m=[],n=1,o=null,p=null,q=null,r=null,s=null,t=null,u=0,v=null,w=0,x=Page.ivsConfig.Tab.Global={init:function(){x.getTemplate(),x.translate(),x.bind(),webApp.DeviceType.contains("TPC")?(webApp.CHANNEL_NUMBER>1&&($("ivs_global_channel").getParent().removeClass("fn-hide"),$("ivs_global_channel").getParent().getNext("div").removeClass("fn-hide"),$channel=jQuery("#ivs_global_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){u=b.ch,x.render()}}),$channel.iconSelect("index",u)),$("VAM_ExcludeRegionD").removeClass("fn-hide"),$("calibrate_wrapper").addClass("fn-hide")):$("waterFilter_wrapper").addClass("fn-hide"),k.get("TrackPositionLimit").done(function(a){a&&a.Support&&$("ivs_trackLimit").removeClass("fn-hide")})},getTemplate:function(){e.VideoInAnalyse.getTemplateModule("Normal").done(function(a){q=a.Normal}),e.VideoInAnalyse.getTemplateGlobal().done(function(a){r=a})},translate:function(){},bind:function(){attachLimit($("ipcIntellentNew_isoThresholdUp"),0,255),$("ipcIntellentNew_isoThresholdUp").addEvent("blur",function(){attachLimit($("ipcIntellentNew_isoThresholdDown"),0,$("ipcIntellentNew_isoThresholdUp").value-0)}),$("ipcIntellentNew_isoThresholdDown").addEvent("blur",x._ajustThresholdDown),$("ipcIntellentNew_isoThresholdUp").addEvent("blur",x._ajustThresholdUp),$("ivs_AddScaleArea").addEvents({click:function(){-1!=$("ivs_global_presets").value&&("hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")?(h.SetCalibrateAndRules("CalibrateArea",0,!0),$("ivs_ScaleAreaShow").setStyle("visibility","visible")):remarkDisplay("ivs_global_remark",tl("w_areaError"),3e3,1))}}),$("ivs_DeleteScaleArea").addEvent("click",function(){if($("ivs_ScaleAreaCheck").hasClass("scale_current")){$("ivs_ScaleAreaShow").setStyle("visibility","hidden"),$("ivs_ScaleAreaCheck").removeClass("scale_current"),h.SetCalibrateAndRules("CalibrateArea",0,!1),d=null;var a=x._findCalibrateKey();b[0][a]=d,c=$unlink(b),$("ivs_ScaleListShow").empty(),m.empty(),x.disableStaffOperation()}});var a=$("ivs_scaleContent");$("ivs_AddScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){if("hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")||!d)return void remarkDisplay("ivs_global_remark",tl("w_areadraw"),3e3,1);if(m.contains("Horizontal")&&!$("scaleVertical").checked)return void remarkDisplay("ivs_global_remark",tl("w_horizontalError"),3e3,1);if(3==m.length&&0==$unlink(m).erase("Vertical").length&&$("scaleVertical").checked||4==m.length)return void remarkDisplay("ivs_global_remark",tl("w_verticalError"),3e3,1);if(!d.Staffs&&m.length||d.Staffs&&m.length!=d.Staffs.length)return void remarkDisplay("ivs_global_remark",tl("Please draw shape"),3e3,1);var b=$("scaleVertical").checked?"Vertical":"Horizontal",c=0;m.each(function(a){a==b&&c++}),m.push(b),h.SetCalibrateAndRules(b,0,!0),$("ivs_ScaleListShow").getElements("i.scale_bottom_icon").set("class","scale_main_icon"),a.getElements("a").removeClass("scale_current");var e=new Element("span",{name:b});e.innerHTML='<div class="fn-clear scale-region"><i class="scale_bottom_icon"></i><a href="javascript:;" class="scale_current" data-staffIndex="'+(m.length-1)+'" scale-index="'+c+'" data-type="'+b+'">'+tl("w_"+b)+"</a></div>",e.inject($("ivs_ScaleListShow"))}}),$("ivs_DeleteScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){var b=a.getElement("#ivs_ScaleListShow a.scale_current");if(!b)return void remarkDisplay("ivs_global_remark",tl("pleaseSelectStaff"),3e3,1);var c=b.getProperty("data-type"),e=parseInt(b.getProperty("scale-index"),10),f=parseInt(b.getProperty("data-staffIndex"),10);b.getParent("span").destroy(),m.splice(f,1),d.Staffs.splice(f,1),h.SetCalibrateAndRules(c,e,!1);var g=$$("#ivs_ScaleListShow a"),i=$$("#ivs_ScaleListShow span").getProperty("name"),j=0;m.each(function(a,b){var c=0;"Vertical"==i[b]&&(c=j++),g[b].setProperties({"scale-index":c,"data-staffIndex":b})}),$("ivs_ScaleListShow").getLast()&&$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")}}),$("scaleLength").addEvent("change",function(){var a=$("ivs_ScaleListShow").getElement("a.scale_current"),b=this.value-0,c=this;if(isNaN(b)?(this.value=n,b=n):.05>=b?(b=1,this.value=b):b>10&&(b=10,this.value=b),b+""!=this.value){var e=this.getProperty("maxlength");this.value=e?(b+"").substr(0,e-0):b}if(a){var f=(a.getProperty("data-staffindex")-0,a.getProperty("data-type"));d.Staffs.each(function(a){a.Type==f&&(a.Length=c.value-0)})}}).addEvent("keyup",function(){var a=this.value;/[^\d\.]/g.test(a)&&(this.value=a.replace(/[^\d\.]/g,""))}),a.addEvent("click:relay([data-toggle])",function(){var a,b,c,c=this.getProperty("data-toggle"),d=this.getParent().getNext("span");"fold"==c?(a="visible",b="scale_icon_hide",c="unfold"):(a="hidden",b="scale_icon_show",c="fold"),d.setStyle("visibility",a),$("ivs_ScaleIcon").setProperty("class",b),this.setProperty("data-toggle",c)}),a.addEvent("click:relay(a)",function(){var b=this.getProperty("data-type"),c=null,d=this.getProperty("scale-index")||0;d=parseInt(d),a.getElements("a").removeClass("scale_current"),this.addClass("scale_current"),("Horizontal"==b||"Vertical"==b)&&(c=x.getStaff(b,d),$("ivs_global_staffType").getElement("input[value="+b+"]").checked=!0,c&&($("scaleLength").setProperty("disabled",!1).value=c.Length)),h.SelectRule(b,d)}),$("ivs_scaleCheck").addEvent("click",function(){return d&&d.Area&&d.Staffs&&4==d.Staffs.length?($$("#ivs_ScaleListShow a").removeClass("scale_current"),scaleCheckNum=$("ivs_scaleValue").value-0,void h.SetCalibrateAndRules("CheckedLength",scaleCheckNum,!0)):void remarkDisplay("ivs_global_remark",tl("w_scaleAll"),3e3,1)}),$("ivs_global_default").addEvent("click",x._onDefaultClick),$("ivs_global_refresh").addEvent("click",x._onRefreshClick),$("ivs_global_confirm").addEvent("click",x._onConfirmClick),$$("#ipcIntellentNew_tab_Global i[data-link]").addEvent("click",function(){var a=this.getProperty("data-link");jQuery("[data-link="+a+"]").toggleClass("toggle"),jQuery("#"+a).addClass("fn-relative"),jQuery("#"+a).slideToggle("normal",function(){jQuery("#"+a).removeClass("fn-relative")})}),jQuery("#Global_IVSForm").slideUp(),x.sliderInit(),$("VAM_DetectRegion").addEvent("click",x._onParaDetectRegionClick),$("VAM_ExcludeRegion").addEvent("click",x._onParaExcludeRegionClick),$("VAM_ExcludeRegionD").addEvent("click",x._onDelExcludeRegion),x.ocxMode="ParaOrGlobal",$$('#ipcIntellentNew_tab_Global fieldset["data-ocx"]').addEvent("mouseover",function(){var a=this.getProperty("data-ocx");if(a&&x.ocxMode!==a)switch(x.ocxMode=a,a){case"para":x._renderModuleOcx();break;case"global":x._renderCalibrateOcx()}}),y.bind(),$("trackLimit_save").addEvent("click",function(){var a=$("ivs_global_presets").value-0,b=this.getPrevious("select").value;e.DevIntelliTracker.markSceneLimit(a,b).done(function(){remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("ivs_global_remark",tl("Operateingfailure"),3e3,1)})}),$("trackLimit_goto").addEvent("click",function(){var a=$("ivs_global_presets").value-0,b=this.getPrevious("select").value;e.DevIntelliTracker.gotoSceneLimit(a,b).done(function(){})})},sliderInit:function(){x.Slider={},x.Slider.OverlapPercent=new FineSlider("Global_IVS_1_slider","Global_IVS_1_knob",{range:[0,100],snap:!0},"Global_IVS_1_tip","Global_IVS_1_add","Global_IVS_1_sub"),x.Slider.DistLimit=new FineSlider("Global_IVS_2_slider","Global_IVS_2_knob",{range:[0,100],snap:!0},"Global_IVS_2_tip","Global_IVS_2_add","Global_IVS_2_sub"),x.Slider.TimeLimit=new FineSlider("Global_IVS_3_slider","Global_IVS_3_knob",{range:[0,100],snap:!0},"Global_IVS_3_tip","Global_IVS_3_add","Global_IVS_3_sub"),x.Slider.VAMSensitivity=new FineSlider("Global_IVS_4_slider","Global_IVS_4_knob",{range:[1,10],snap:!0},"Global_IVS_4_tip","Global_IVS_4_add","Global_IVS_4_sub")},leave:function(){h.addEvent("OutPutStringInfo",null),h.addEvent("VideoAnalyzeConfig",null),h.SetIVSConfig("",0),h.SetIVSConfig("",1),h.hide(),webApp.DeviceType.contains("TPC")&&t&&h.RemoveOneIntelShapeContainer(t)},render:function(){h.cover("#ivs_global_video",function(a){h.SetRegionNum(0),webApp.DeviceType.contains("TPC")?(h.SetModuleMode(1),h.SetVisibleVideoWnd(1,u),g.chkAuthority("Monitor_0"+(u+1))&&h.ConnectRealVideoEx(u,u,0),!g.chkAuthority("Monitor_0"+(u+1))&&h.SetVideoWndTip(u,tl("noVideoAuthoity")),t&&h.RemoveOneIntelShapeContainer(t)):(h.SetModuleMode(2),g.chkAuthority("Monitor_01")&&h.open()),a&&x._onRefreshClick(!1)}),h.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutGlobalCalibrateInfo":x.outPutGlobalCalibrateInfo(b);break;case"OutPutCheckedInfo":x.outPutCheckedInfo(b);break;case"OutPutModuleRect":x.OutPutModuleRect(b)}}),h.addEvent("VideoAnalyzeConfig",function(a){x.OutPutShapeRect(a)});var a=["VideoAnalyseGlobal","VideoAnalyseModule"];$$("ipcIntellentNew_Global_tab").hasClass("fn-hide")||a.push("IntelliTrackScene"),-1!==webApp.DeviceType.indexOf("TPC")&&a.push("ThermoIntelliVideoFilter"),e.ConfigManager.getConfig(a).done(function(a){b=a[0].params.table,a[3]&&a[3].result&&(o=a[3].params.table),a[1].result&&(p=a[1].params.table),a[2]&&a[2].result&&(v=a[2].params.table),c=$unlink(b),x.SD.render()}),k.get("IVSCaps").done(function(a){a&&h.SetMaxPntNum(a.MaxPointOfLine,a.MaxPointOfRegion)})},_renderGlobalElements:function(){if(-1!==webApp.DeviceType.indexOf("TPC")){if(-1!==webApp.DeviceType.indexOf("SD")&&!$("ivs_global_presets").getSelected()[0].hasClass("fn-color-ivsGreen"))return $$("#params_wrapper,#waterFilter_wrapper,#advance_wrapper").addClass("fn-hide"),void remarkDisplay("ivs_global_remark",tl("pleaseAddScenceFirst"),3e3,1);1===u||1===webApp.CHANNEL_NUMBER?($("waterFilter_wrapper").removeClass("fn-hide"),$$("#params_wrapper,#advance_wrapper").removeClass("fn-hide"),webApp.DeviceType.contains("TPC")&&$$("#ivsSdPtzWrap .ptz-adjust").addClass("fn-hide")):($$("#params_wrapper,#advance_wrapper").removeClass("fn-hide"),$("waterFilter_wrapper").addClass("fn-hide"),$$("#ivsSdPtzWrap .ptz-adjust").removeClass("fn-hide"))}var a=$("ivs_global_presets").value-0;if(x._renderIVS(a),x._renderTrack(a),0!==b.length){var c=x._findCalibrateKey(),e=b[w][c]||[];if(d=e[0]||null,x._renderScale(),$("scaleVertical").checked=!0,-1===webApp.DeviceType.indexOf("SD")&&-1===webApp.DeviceType.indexOf("TPC"))x.ocxMode="global",x._renderCalibrateOcx();else if(webApp.DeviceType.contains("TPC")){x._analyseRule(),t=null,h.CreateOneIntelShapeContainer(u,"").done(function(a){t=a});x._renderDetect(),v&&v[u]&&x._renderISOFilter()}else switch(x.ocxMode){case"para":x._renderModuleOcx();break;case"global":x._renderCalibrateOcx()}}},_findCalibrateKey:function(){var a=$("ivs_global_presets").value-0,c="CalibrateArea";for(var d in b[w])-1!==d.indexOf("Scene")&&b[w][d].PtzPresetId==a&&(c=d.replace("Scene","CalibrateArea"));return c},_renderISOFilter:function(){$("ipcIntellentNew_filter_enable").checked=v[u].Enable,$("ipcIntellentNew_isoThresholdUp").value=v[u].HighThreshold,$("ipcIntellentNew_isoThresholdDown").value=v[u].LowThreshold,attachLimit($("ipcIntellentNew_isoThresholdDown"),0,$("ipcIntellentNew_isoThresholdUp").value-0)},_ajustThresholdDown:function(){this.value-0>$("ipcIntellentNew_isoThresholdUp").value-0&&(this.value=$("ipcIntellentNew_isoThresholdUp").value-0)},_ajustThresholdUp:function(){this.value-0<$("ipcIntellentNew_isoThresholdDown").value-0&&($("ipcIntellentNew_isoThresholdDown").value=this.value-0)},_renderIVS:function(a){if(p&&void 0!=p[u]){for(var c=0;c<p[u].length;c++)if(p[u][c].PtzPresetId==a&&"Normal"==p[u][c].Type){p[u][c].AntiDisturbance===!0?$("VAM_AntiDisturbance_true").checked=!0:$("VAM_AntiDisturbance_false").checked=!0,p[u][c].Shadow===!0?$("VAM_Shadow_true").checked=!0:$("VAM_Shadow_false").checked=!0,x.Slider.VAMSensitivity.set(p[u][c].Sensitivity);break}var d=b[u];for(var e in d)-1!==e.indexOf("Scene")&&d[e].PtzPresetId==a&&d[e].Detail.Track&&(x.Slider.OverlapPercent.set(d[e].Detail.Track.OverlapPercent),x.Slider.DistLimit.set(d[e].Detail.Track.DistLimit),x.Slider.TimeLimit.set(d[e].Detail.Track.TimeLimit))}},_renderTrack:function(){if(o&&o[0]&&o[0].Scene)for(var a=0;a<o[0].Scene.length;a++)if(0==o[0].Scene[a].PresetID){!o[0].Scene[a].PositionLimit&&(o[0].Scene[a].PositionLimit={}),$("trackLimit_enable").checked=!!o[0].Scene[a].PositionLimit.Enable;break}},_buildAnalyseGlobal:function(a){if("[object Array]"!==Object.prototype.toString.call(a)){var b=[];b.push(a[0]),a=b}var c={result:!0,params:{table:[a]}};f=JSON.encode(c)},_renderScale:function(){var a=x._findCalibrateKey(),c=b[w][a]||[],d=c[0];if(m.empty(),$("ivs_ScaleListShow").empty(),!d||!d.Area)return $("ivs_ScaleAreaShow").setStyle("visibility","hidden"),void x.disableStaffOperation();$("ivs_ScaleAreaShow").setStyle("visibility","visible"),x.enableStaffOperation();var e="",f=0;d.Staffs&&d.Staffs.each(function(a,b){var c=0;c="Horizontal"==a.Type?0:f++,e+="<span name="+a.Type+'><div class="fn-clear scale-region"><i class="scale_main_icon"></i><a href="javascript:;" data-staffIndex="'+b+'" scale-index="'+c+'" data-type="'+a.Type+'">'+tl("w_"+a.Type)+"</a></div></span>",m.push(a.Type),"Vertical"==a.Type?($("scaleLength").value=a.Length,i=a.Length):j=a.Length}),$("ivs_ScaleListShow").innerHTML=e,$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")},getStaff:function(a,b){var c=d.Staffs;if(c){var e=c.filter(function(b){return b.Type==a});return e[b]}},saveCurrentStaff:function(){var a=$("scaleVertical").checked?"Vertical":"Horizontal";if(d.Staffs){var b=parseFloat($("scaleLength").value);d.Staffs.each(function(c){c.Type===a&&(c.Length=isNaN(b)?n:b)})}},outPutGlobalCalibrateInfo:function(a){var c=x._findCalibrateKey();d=JSON.decode(a);var e=d.Staffs,f=b[w][c]||[];if(e){var g=f[0]||{},h=g.Staffs,i=$("scaleLength").value-0;if(h){if(h.each(function(a,b){e[b]&&(e[b].Length=a.Length)}),h.length<e.length){var j=e[e.length-1].Type;e.each(function(a){a.Type==j&&(a.Length=i)}),$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}}else e[0].Length=i,$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}else d.Area.length>0&&x.enableStaffOperation();f[0]=d,b[w][c]=f},outPutCheckedInfo:function(a){var b=JSON.decode(a),c=b.CheckedLength[0],d=b.CheckedLength[1];if(0==scaleCheckNum)var f="Horizontal";else var f="Vertical";e.DevVideoAnalyse.testCalibrateWithScreenPoints(f,c,d).done(function(a){h.GetLength(a.toFixed(2))})},disableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!0),$("scaleLength").disabled=!0,$("scaleLength").value=1,$("ivs_AddScale").addClass("ui-button-disabled"),$("ivs_DeleteScale").addClass("ui-button-disabled")},enableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!1),$("scaleLength").disabled=!1,$("ivs_AddScale").removeClass("ui-button-disabled"),$("ivs_DeleteScale").removeClass("ui-button-disabled")},_onDefaultClick:function(){var a=$("ivs_global_presets").value-0;for(var c in b[u])if(-1!==c.indexOf("Scene")&&b[u][c].PtzPresetId==a){var d=c.replace("Scene","CalibrateArea");b[u][d]=null,b[u][c].Detail.Track=jQuery.extend(!0,{},r.Scene.Detail.Track);break}for(var f=0;f<p[u].length;f++)if(p[u][f].PtzPresetId==a&&"Normal"==p[u][f].Type){for(var c in q)"PtzPresetId"!==c&&"Type"!==c&&(p[u][f][c]=$unlink(q[c]),p[u][f].ExcludeRegion&&p[u][f].ExcludeRegion.empty());break}-1!==webApp.DeviceType.indexOf("TPC")?e.ConfigManager.getDefault("ThermoIntelliVideoFilter").done(function(a){v=a,x._renderGlobalElements(0),remarkDisplay("ivs_global_remark",tl("Defaultsuccess"),3e3,0)}):(remarkDisplay("ivs_global_remark",tl("Defaultsuccess"),3e3,0),x._renderGlobalElements(0))},_saveGlobalScale:function(){d&&x.saveCurrentStaff()},_saveIVS:function(a){for(var c=0;c<p[u].length;c++)if(p[u][c].PtzPresetId==a&&"Normal"==p[u][c].Type){p[u][c].AntiDisturbance=$("VAM_AntiDisturbance_true").checked,p[u][c].Shadow=$("VAM_Shadow_true").checked,p[u][c].Sensitivity=$("Global_IVS_4_slider").getProperty("title")-0;break}var d=b[u];for(var e in d)-1!==e.indexOf("Scene")&&d[e].PtzPresetId==a&&d[e].Detail.Track&&(d[e].Detail.Track.OverlapPercent=$("Global_IVS_1_slider").getProperty("title")-0,d[e].Detail.Track.DistLimit=$("Global_IVS_2_slider").getProperty("title")-0,d[e].Detail.Track.TimeLimit=$("Global_IVS_3_slider").getProperty("title")-0)},_saveTrack:function(){if(o&&o[0]&&o[0].Scene)for(var a=0;a<o[0].Scene.length;a++)if(0==o[0].Scene[a].PresetID){!o[0].Scene[a].PositionLimit&&(o[0].Scene[a].PositionLimit={}),o[0].Scene[a].PositionLimit.Enable=$("trackLimit_enable").checked;break}},_onRefreshClick:function(a){var d=["VideoAnalyseGlobal","VideoAnalyseModule"];v&&d.push("ThermoIntelliVideoFilter"),o&&d.push("IntelliTrackScene"),e.ConfigManager.getConfig(d).done(function(d){l.chkMutilCallRet(d,!0)?(b=d[0].params.table,c=$unlink(b),d[3]&&d[3].result&&(o=d[3].params.table),d[1].result&&(p=d[1].params.table),d[2]&&d[2].result&&(v=d[2].params.table),x._renderGlobalElements(0),a!==!1&&remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)):remarkDisplay("ivs_global_remark",tl("Operateingfailure"),3e3,1)})},_onConfirmClick:function(){var a=d&&d.Area&&d.Staffs&&4==d.Staffs.length;if(!a&&d)return void remarkDisplay("ivs_global_remark",tl("w_scaleAll"),3e3,1);if("visible"==$("ivs_ScaleAreaShow").getStyle("visibility")&&$$("#ivs_ScaleListShow span").length<4)return void remarkDisplay("ivs_global_remark",tl("w_areadraw"),3e3,1);x._saveGlobalScale();var f=$("ivs_global_presets").value-0;x._saveIVS(f),v&&v[u]&&(v[u].Enable=$("ipcIntellentNew_filter_enable").checked,v[u].HighThreshold=$("ipcIntellentNew_isoThresholdUp").value-0,v[u].LowThreshold=$("ipcIntellentNew_isoThresholdDown").value-0);var g=["VideoAnalyseGlobal","VideoAnalyseModule"],h=[b,p],i=jQuery.Deferred();v&&(g.push("ThermoIntelliVideoFilter"),h.push(v)),o?ITS=e.ConfigManager.getConfig("IntelliTrackScene").done(function(a){o=a,x._saveTrack(f),g.push("IntelliTrackScene"),h.push(o),i.resolve()}):i.reject(),jQuery.when(i).always(function(){e.ConfigManager.setConfig(g,h).done(function(a){l.chkMutilCallRet(a)?(c=$unlink(b),remarkDisplay("ivs_global_remark",tl("Succeed in saving configure"),3e3,0),webApp.isNeedReboot(a)&&webApp.reboot("The configration take effect! The device is restarting now,please reconnect later...")):remarkDisplay("ivs_global_remark",tl("IvsGlobalSave"),3e3,1)})})},_renderCalibrateOcx:function(){if(b.length){var a=x._findCalibrateKey(),c=b[w][a]||[];x._buildAnalyseGlobal(c),h.SetIVSConfig(f,0),h.SubVideoWndCtrl(12,1)}},_clearCalibrateOcx:function(){h.SetIVSConfig("",0)},_bulidModuleJson:function(){for(var a=$("ivs_global_presets").value-0,b={result:!0,params:{table:[[{DetectRegion:null,ExcludeRegion:null,PtzPresetId:0}]]}},c=0;c<p[u].length;c++)if(p[u][c].PtzPresetId===a&&"Normal"===p[u][c].Type){b.params.table[0][0].DetectRegion=p[u][c].DetectRegion,b.params.table[0][0].ExcludeRegion=p[u][c].ExcludeRegion||"";break}return JSON.encode(b)},_renderModuleOcx:function(){var a=($("ivs_global_presets").value-0,x._bulidModuleJson());h.SetIVSConfig(a,1),h.AddShape(1,"","",2,0),h.SetCurModule(0)},_clearModuleOcx:function(){h.SetIVSConfig("",1)},_onParaDetectRegionClick:function(){webApp.DeviceType.contains("TPC")?(a&&(h.DeleteOneIntelShape(a),a=null,curRule&&0!==curRule.length&&(curRule.DetectRegion.empty(),s.each(function(a){h.DeleteOneIntelShape(a)}),s.empty(),curRule.ExcludeRegion&&curRule.ExcludeRegion.empty())),name=tl("DetectArea"),h.CreateOneIntelShape(t,"Polygon","VideoAnalyzeConfig","Polygon",name,"","").done(function(b){a=b}),h.SetOneIntelShapeThickness(a,2),h.SetOneIntelShapeDisplayColor(a,0,255,255,0),h.SetOneIntelShapeDisplayColor(a,1,0,0,255)):("para"!==x.ocxMode&&(x.ocxMode="para",x._renderModuleOcx()),h.AddDetectionRegion("",0))},_onParaExcludeRegionClick:function(){if(webApp.DeviceType.contains("TPC")){if(!a)return void remarkDisplay("ivs_global_remark",tl("addDetectRegionFirst"),3e3,1);var b,c;if(s.length>9)return void remarkDisplay("ivs_global_remark",tl("maxRules10"),3e3,1);curRule&&!curRule.ExcludeRegion?c=tl("Exclude Region")+1:(s.each(function(a){h.SelectOneIntelShape(a,!1)}),c=tl("Exclude Region")+(curRule.ExcludeRegion.length+1)),h.CreateOneIntelShape(t,"Polygon","VideoAnalyzeConfig","Polygon",c,"","").done(function(a){b=a}),s.push(b),h.SetOneIntelShapeThickness(b,2),h.SetOneIntelShapeDisplayColor(b,0,0,255,255),h.SetOneIntelShapeDisplayColor(b,1,0,255,255),h.SelectOneIntelShape(b,!0)}else"para"!==x.ocxMode&&(x.ocxMode="para",x._renderModuleOcx()),h.AddExcludeRegion("",0)},OutPutModuleRect:function(a){for(var b=$("ivs_global_presets").value-0,c=JSON.decode(a),d=0;d<p[u].length;d++)if(p[u][d].PtzPresetId===b){p[u][d].DetectRegion=c.DetectRegion,p[u][d].ExcludeRegion=c.ExcludeRegion;break}},_analyseRule:function(){var a=$("ivs_global_presets").value-0;p?p[u]?(curRule=p[u].filter(function(b){return b.PtzPresetId==a})[0],curRule||(curRule=$unlink(q),curRule.PtzPresetId=a,p[u].push(curRule))):(curRule=$unlink(q),curRule.PtzPresetId=a,p[u]=[],p[u].push(curRule)):(p=[[],[]],curRule=$unlink(q),curRule.PtzPresetId=a,p[u].push(curRule))},_renderDetect:function(){if(0!==curRule.length&&null!==curRule){var b=curRule.DetectRegion;if(0!=b[0]||0!=b[1]||0!=b[2]||0!=b[3]){b&&b.length>0?(info={Polygon:b},info=JSON.encode(info)):info="";var c=tl("Detect Region");h.CreateOneIntelShape(t,"Polygon","VideoAnalyzeConfig","Polygon",c,info,"").done(function(b){a=b}),h.SetOneIntelShapeThickness(a,2),h.SetOneIntelShapeDisplayColor(a,0,255,255,0),h.SetOneIntelShapeDisplayColor(a,1,0,0,255),s=[],curRule.ExcludeRegion&&0!=curRule.ExcludeRegion.length&&curRule.ExcludeRegion.each(function(a,b){if(0!=a[0]||0!=a[1]||0!=a[2]||0!=a[3]){a&&a.length>0?(info={Polygon:a},info=JSON.encode(info)):info="";var c,d=tl("Exclude Region")+(b+1);h.CreateOneIntelShape(t,"Polygon","VideoAnalyzeConfig","Polygon",d,info,"").done(function(a){c=a}),s[b]=c,h.SetOneIntelShapeThickness(c,2),h.SetOneIntelShapeDisplayColor(c,0,255,255,0),h.SetOneIntelShapeDisplayColor(c,1,0,255,255),h.SelectOneIntelShape(c,!1)}})}}},_onDelExcludeRegion:function(){s.length>0&&(h.DeleteOneIntelShape(s[s.length-1]),s.erase(s[s.length-1]),curRule.ExcludeRegion.erase(curRule.ExcludeRegion[curRule.ExcludeRegion.length-1]))},OutPutShapeRect:function(b){var c=JSON.decode(b);c.EventParam.ObjectID==a?curRule.DetectRegion=c.ShapeData.DetectLine:s.each(function(a,b){a==c.EventParam.ObjectID&&(curRule.ExcludeRegion||(curRule.ExcludeRegion=[]),curRule.ExcludeRegion[b]=c.ShapeData.DetectLine)})}},y=x.SD={bind:function(){$("ivs_global_presets").addEvent("change",function(){var a=this.value-0,b=this.getSelected()[0];b&&b.hasClass("fn-color-ivsGreen")?this.addClass("fn-color-ivsGreen"):this.removeClass("fn-color-ivsGreen"),-1!==webApp.DeviceType.indexOf("SD")?e.PTZ.gotoPreset(a).always(function(){x._renderGlobalElements()
}):x._renderGlobalElements()})},render:function(){this.getPresets(function(){$("ivs_global_presets").fireEvent("change")})},getPresets:function(a){var c=$("ivs_global_presets");return webApp.DeviceType.contains("SD")?void e.PTZ.getPresets().done(function(d){var f=d||[];if(c.empty(),0==f.length)c.options.add(new Option(tl("addPlanFirst"),-1)),remarkDisplay("ivs_global_remark",tl("addPlanFirst"),4e3,2);else if(-1===webApp.DeviceType.indexOf("TPC")){for(var g=[],h=0;h<f.length;h++){var i=new Option(f[h].Name,f[h].Index);$(i).setProperty("title",tl("Preset")+f[h].Index),1===f[h].Type?($(i).addClass("fn-color-ivsGreen"),c.options.add(i)):($(i).addClass("fn-color-black"),g.push(i))}g.each(function(a){c.options.add(a)})}else{for(var h=0;h<f.length;h++){var i=new Option(f[h].Name,f[h].Index);$(i).setProperty("title",tl("Preset")+f[h].Index),c.options.add(i),$(i).addClass("fn-color-black")}for(var j in b[u])if(j.contains("Scene")){var k=b[u][j].PtzPresetId;jQuery("#ivs_global_presets").find('[value="'+k+'"]').removeClass("fn-color-black").addClass("fn-color-ivsGreen")}}e.ConfigManager.getConfig("PtzMovement").done(function(a){if("Preset"==a[0].Function){c.value=a[0].Index+1;var b=c.getSelected()[0];b&&b.hasClass("fn-color-ivsGreen")?c.addClass("fn-color-ivsGreen"):c.removeClass("fn-color-ivsGreen"),c.selectedIndex<0&&(c.selectedIndex=0)}}).always(function(){a&&a()})}).fail(function(){$("ivs_global_presets_wrap").addClass("fn-hide"),c.empty(),c.options.add(new Option(tl("addPresetFirst"),0)),a&&a()}):($("ivs_global_presets_wrap").addClass("fn-hide"),c.empty(),c.options.add(new Option(tl("addPresetFirst"),0)),void(a&&a()))}}}(),function(){Page.ivsConfig.Tab.CrossLineDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.CrossRegionDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),-1!==webApp.DeviceType.indexOf("TPC")?$("ipcIntellentNew_RegionRule").setStyle("display",""):$("ipcIntellentNew_actionWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.LeftDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.TakenAwayDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.VideoAbnormalDetection={render:function(){},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.WanderDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.RioterDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display",""),$("ipcIntellentNew_target_label").set("text",tl("minGatherRegion")),$("ipcIntellentNew_object_filter_ck").setStyle("display","none")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.MoveDetection={render:function(){$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.RetrogradeDetection={render:function(){$("ipcIntellentNew_SensitivityWrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.CrossFenceDetection={render:function(){$("ipcIntellentNew_fenceDirection_wrap").removeClass("fn-hide")},leave:function(){$("ipcIntellentNew_fenceDirection_wrap").addClass("fn-hide"),Page.ivsConfig.Tab["public"].leave()}}}(),function(){Page.ivsConfig.Tab.ParkingDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display","")},leave:function(){Page.ivsConfig.Tab["public"].leave()}}}(),function(){function b(a,b,c){function d(){for(var a,d=this.value,e=0,f=0,g=d.length;g>f&&(a=d.charCodeAt(f),e+=127>=a?b.asciiByte||1:b.notAsciiByte||3,!(e>b.maxByte));f++);e>b.maxByte&&(this.value=d.slice(0,f),c&&c())}b=b||{},b.maxlength&&a.setProperty("maxLength",b.maxlength),a.addEvent("keyup",d),a.addEvent("blur",d)}{var i,j,l,n={MaxRect:[8191,8191],MinRect:[0,0]},r=!1,t=!1,u=0,v={},w=null,x=10,y=10,z=null,A=0,B=null,C=null,D=null,E=[],F=null,G=Page.ivsConfig.Tab["public"]={init:function(){w=$("ipcIntellentNew_ruleManager"),G.translate(),G.bind(),v=new FineSlider("ipcIntellentNew_Sensitivity_slider","ipcIntellentNew_Sensitivity_knob",{range:[1,10],snap:!0},"ipcIntellentNew_Sensitivity_tip","ipcIntellentNew_Sensitivity_add","ipcIntellentNew_Sensitivity_sub"),k.get("IVSCaps").done(function(a){x=a.MaxRules||10,y=a.SupportedScenes.Normal.MaxRules||10;var b=void 0!==a.LinkPtzSupport?a.LinkPtzSupport:webApp.HasPtz;G.eventHandler=new d("#ipcIntellentNew_eventHandler",{PtzLinkEnable:b})}),e.VideoInAnalyse.getTemplateGlobal().done(function(a){l=a}),webApp.DeviceType.contains("TPC")&&webApp.CHANNEL_NUMBER>1&&($("ipcIntellentNew_channel").getParent().removeClass("fn-hide"),$("ipcIntellentNew_channel").getParent().getNext("div").removeClass("fn-hide"),z=jQuery("#ipcIntellentNew_channel").iconSelect({channelNumber:webApp.CHANNEL_NUMBER,allEnable:!1,change:function(a,b){A=b.ch,G.render()}}),z.iconSelect("index",A))},translate:function(){},render:function(){-1!==webApp.DeviceType.indexOf("TPC")&&-1===webApp.DeviceType.indexOf("SD")&&($("ipcIntellentNew_rebuild").style.display=""),$("ipcIntellentNew_left").setStyle("display","block"),$("ipcIntellentNew_VideoAbnormalDetection").getChildren().setStyle("margin-left","470px"),G._disabledDraw(!1),h.cover("#ipcintellentNewVideo",function(a){h.SetRegionNum(0),-1!==webApp.DeviceType.indexOf("TPC")?(h.SetModuleMode(1),h.SetVisibleVideoWnd(1,A),g.chkAuthority("Monitor_0"+(A+1))&&h.ConnectRealVideoEx(A,A,0),!g.chkAuthority("Monitor_0"+(A+1))&&h.SetVideoWndTip(A,tl("noVideoAuthoity"))):(h.SetRegionNum(0),h.SetModuleMode(2),g.chkAuthority("Monitor_01")&&h.open()),a&&G._onRefreshClick(!1)}),h.addEvent("OutPutStringInfo",function(a,b){switch(a){case"OutPutShapeRect":G.outPutShapeRect(b);break;case"OutPutObjectRect":G.setFilterValue(b);break;case"OutPutRuleRect":G.outPutRuleRect(b)}}),h.addEvent("VideoAnalyzeConfig",function(a){G.outPutShapeRect(a)}),i=$unlink(a),webApp.DeviceType.contains("TPC")?e.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(a){F=a,G.SD.render()}):G.SD.render()},renderMinDuration:function(a){var b=o[a]||[1,600];attachLimit("ipcIntellentNew_minDuration",b[0],b[1]),$("ipcIntellentNew_minDurationTip").set("text","("+b[0]+"~"+b[1]+")")},bind:function(){function a(){var a=this.getProperty("data-index"),b=i[A][a];b.Enable=this.checked;var c=w.getElements("[data-input]");$("ipcIntellentNew_allRuleEnable").checked=!0;for(var d=0;d<c.length;d++)0==c[d].checked&&($("ipcIntellentNew_allRuleEnable").checked=!1)}function b(){var a=w.getElement(".current");a&&G._saveElements(),this.getSiblings().removeClass("current"),this.addClass("current");var b=this.getProperty("data-index")-0,c=i[A][b].Type;G._renderRuleDom(c),G._changeRule(b),G.renderMinDuration(c)}G.SD.bind(),$("ipcIntellentNew_default1").addEvent("click",G._onDefaultClick),$("ipcIntellentNew_refresh1").addEvent("click",G._onRefreshClick),$("ipcIntellentNew_confirm1").addEvent("click",G._onConfirmClick),$("ipcIntellentNew_setButton1").addEvent("click",G._onSetupClick),$("ipcIntellentNew_RegionRuleType").addEvent("change",G._changeRuleType),attachLimit("ipcIntellentNew_TrackTime",5,300),G._attachLimitCompare("ipcIntellentNew_MinTargets","ipcIntellentNew_MaxTargets",1,100,!0),G._attachLimitCompare("ipcIntellentNew_MaxTargets","ipcIntellentNew_MinTargets",1,100,!1),attachLimit("ipcIntellentNew_ReportInterval",0,600),$("ipcIntellentNew_drawRule").addEvent("click",function(){G._drawRuleType(!1)}),$("ipcIntellentNew_rebuild").addEvent("click",function(){G._rebuild()}),$("ipcIntellentNew_clearRule").addEvent("click",function(){var a=G._findIndexNow(),b=i[A][a];if(r)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);var c="";switch(b.Type){case"CrossLineDetection":c="DetectLine";break;case"CrossRegionDetection":c="DetectRegion";break;case"WanderDetection":case"MoveDetection":case"RioterDetection":case"LeftDetection":case"TakenAwayDetection":c="DetectRegion";break;case"VideoAbnormalDetection":c="DetectLine";break;case"CrossFenceDetection":c="UpstairsLine";break;default:c="DetectRegion"}"DetectLine"==c?b.Config[c]=[[0,0],[0,0]]:"DetectRegion"==c?b.Config[c]=[[0,0],[0,0],[0,0],[0,0]]:"UpstairsLine"==c&&(b.Config.UpstairsLine=[[0,0],[0,0]],b.Config.DownstairsLine=[[0,0],[0,0]]),G._buildRuleJson(),h.DeleteShape(b.Name),G._drawRuleType(!0),G._renderRule()}),$("ipcIntellentNew_NumberSelect").addEvent("change",G._changeRule),attachLimit("ipcIntellentNew_minDuration",1,600),$("ipcIntellentNew_ruleDirection").addEvent("change",function(){var a=G._findIndexNow(),b=i[A][a];b.Config.Direction=this.value,G._changeDiection()}),$("ipcIntellentNew_ruleDirection2").addEvent("change",function(){var a=G._findIndexNow(),b=i[A][a];b.Config.Direction=this.value,G._changeDiection()}),$("ipcIntellentNew_fenceDirection").addEvent("change",function(){var a=G._findIndexNow(),b=i[A][a];b.Config.Direction=this.value,G._changeDiection()}),$("ipcIntellentNew_drawTarget").addEvent("click",function(){var a=G._findIndexNow(),b=i[A][a];if(r)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);if(webApp.DeviceType.contains("TPC"))G._displayOCXRule(C,!1),D?null==E[0]&&null==E[1]?(D=null,G._drawOCXFilter("BigSmallFilterBox",b)):E[0]&&null==E[1]?G._drawOCXFilter("BigFilter",b):E[1]&&null==E[0]?G._drawOCXFilter("SmallFilter",b):G._displayOCXRule(D,!0):G._drawOCXFilter("BigSmallFilterBox",b),G._disabledDraw(!1);else{var c=b.Config.SizeFilter;$("ipcIntellentNew_max").checked?isZeroArray(c.MaxSize)?(h.AddShape(5,"","MaxRect",0,-1),G._disabledDraw(!0)):h.SetCurShape("MaxRect"):isZeroArray(c.MinSize)?(h.AddShape(5,"","MinRect",0,-1),G._disabledDraw(!0)):h.SetCurShape("MinRect")}if("RioterDetection"==b.Type){if(b.Enable===!1)return;return void(isEmptyRect(b.Config.MinDetectRect)?(h.AddShape(6,"","RuleRect",-1,0),G._disabledDraw(!0)):(h.DeleteShape("RuleRect"),h.SetObjectConfig(JSON.encode({RuleRect:b.Config.MinDetectRect})),h.SetCurShape("RuleRect")))}}),$("ipcIntellentNew_clearTarget").addEvent("click",function(){var a=G._findIndexNow(),b=i[A][a];if(r)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);if("RioterDetection"==b.Type)return b.Config.MinDetectRect=[[0,0],[0,0]],void(b.Enable&&h.DeleteShape("RuleRect"));if(!webApp.DeviceType.contains("TPC")||0!==E.length){if($("ipcIntellentNew_max").checked){if(b.Config.SizeFilter.MaxSize=[8191,8191],webApp.DeviceType.contains("TPC")){var c=E[1];h.DeleteOneIntelShape(c),E[1]=null}}else if(b.Config.SizeFilter.MinSize=[0,0],webApp.DeviceType.contains("TPC")){var c=E[0];h.DeleteOneIntelShape(c),E[0]=null}webApp.DeviceType.contains("TPC")?(n.MaxRect=b.Config.SizeFilter.MaxSize,n.MinRect=b.Config.SizeFilter.MinSize):b.Enable&&(h.DeleteShape("MaxRect"),h.DeleteShape("MinRect"),n.MaxRect=b.Config.SizeFilter.MaxSize,n.MinRect=b.Config.SizeFilter.MinSize,h.SetObjectConfig(JSON.encode(n)),$("ipcIntellentNew_max").checked?h.AddShape(5,"","MaxRect",0,-1):h.AddShape(5,"","MinRect",0,-1),G._disabledDraw(!0,!0))}}),$("ipcIntellentNew_max").addEvent("click",function(){return r?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):void(webApp.DeviceType.contains("TPC")?(h.SelectOneIntelShape(E[1],!0),h.SelectOneIntelShape(E[0],!1)):h.SetCurShape("MaxRect"))}),$("ipcIntellentNew_min").addEvent("click",function(){var a=G._findIndexNow(),b=i[A][a];return r?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):void(webApp.DeviceType.contains("TPC")?(h.SelectOneIntelShape(E[1],!1),h.SelectOneIntelShape(E[0],!0)):isZeroArray(b.Config.SizeFilter.MinSize)?(h.AddShape(5,"","MinRect",0,-1),G._disabledDraw(!0)):h.SetCurShape("MinRect"))}),$$("#ivs_crd_appear,#ivs_crd_cross").addEvent("click",function(){var a=G._findIndexNow(),b=this.checked,c=this.getProperty("data-val"),d=i[A][a].Config;b?d.Action.push(c):d.Action.splice(d.Action.indexOf(c),1),"Cross"==c&&(d.Direction=b?$("ipcIntellentNew_ruleDirection2").value:"",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",b?"":"none"),G._changeDiection())}),$("ipcIntellentNew_fieldset").addEvent("click:relay([data-add])",function(){if(this.hasClass("disabled"))return void(-1!==webApp.DeviceType.indexOf("TPC")&&$$("#ipcIntellentNew_ruleManager tbody tr").length&&remarkDisplay("ipcIntellentNew_remark1",tl("noMoreRule"),3e3,1));if(-1!==webApp.DeviceType.indexOf("SD")&&-1!==webApp.DeviceType.indexOf("TPC")&&!$("ipcIntellentNew_presets").getSelected()[0].hasClass("fn-color-ivsGreen"))return void remarkDisplay("ipcIntellentNew_remark1",tl("pleaseAddScenceFirst"),3e3,1);var a="CrossLineDetection";-1==p.indexOf(a)&&(a=p[0]);var b=$unlink(c[a]),d=i[A];if(!b)throw remarkDisplay("ipcIntellentNew_remark1",tl("Operateingfailure"),3e3,1),new Error("the rule of "+a+" has no default config");var e=jQuery.extend(!0,{},b),f=[a];"LeftDetection"==a&&f.push("TakenAwayDetection"),e.Name=G.getUniqueName(e.Name,i,f,d),e.PtzPresetId=$("ipcIntellentNew_presets").value-0,d.push(e),G._renderRuleList(d,d.length-1),G._changeRule(d.length-1,!0)}),w.addEvent("click",function(c){c.target.getProperty("data-del")||(""===c.target.getProperty("data-input")&&a.apply(c.target),b.apply(jQuery(c.target).parents("tr")[0]),G._renderOcx())}),w.addEvent("click:relay([data-del])",function(){var a,b=this.getProperty("data-del")-0,c=G._findIndexNow(),d=i[A];webApp.DeviceType.contains("TPC")?G._delectOCXRule(C):h.DeleteShape(d[b].Name),d.splice(b,1),a=d.length,G._renderRuleList(d,c),G._renderRule(),G._renderOcx()}),w.addEvent("dblclick:relay([data-name])",function(){this.addClass("edit"),this.getElement("input").select()}),w.addEvent("change:relay(select)",function(){this.getSiblings("span").setProperty("text",tl(this.value)),this.getSiblings("span").setProperty("data-value",this.value),this.style.display="none",this.getSiblings("span").setStyle("display","");var a=G._findIndexNow(),b=i[A][a];b.Type=this.value,G._renderRuleDom(b.Type),b.Config=$unlink(c[b.Type].Config),G._changeRule(a)}),w.addEvent("blur:relay(select)",function(){this.getSiblings("span").setProperty("text",tl(this.value)),this.getSiblings("span").setProperty("data-value",this.value),this.style.display="none",this.getSiblings("span").setStyle("display","")}),w.addEvent("dblclick:relay(span.ruleSpan)",function(){this.style.display="none",this.getSiblings("select").setStyle("display","");var a=(this.getProperty("data-value"),this.getSiblings("select")[0]);a.value=this.getProperty("data-value"),u=this.getParents("tr").getProperty("data-index")-0}),$("ipcIntellentNew_allRuleEnable").addEvent("click",function(){var a=w.getElements("[data-input]");if(0==a.length)return void(this.checked=!1);for(var b=i[A],c=0;c<a.length;c++){a[c].checked=this.checked;var d=a[c].getProperty("data-index")-0;b[d].Enable=this.checked}var e=w.getElement(".current").getElement("[data-input]").getProperty("data-index");G._changeRule(e)}),w.addEvent("blur:relay(input)",function(){var a=this.getProperty("type");if("checkbox"!=a){var b,c,d=this.value;if(b=this.getParent().removeClass("edit").getProperty("data-name")-0,d){this.getSiblings("span").set("text",d).setProperty("title",d);var e=i[A][b];c=e.Name,e.Name=d,h.SetCurShape(c),h.SetCurName(d),h.SetCurShape("save")}}})},leave:function(){h.addEvent("OutPutStringInfo",null),h.addEvent("VideoAnalyzeConfig",null),h.SetIVSConfig("",2),h.hide(),webApp.DeviceType.contains("TPC")&&B&&h.RemoveOneIntelShapeContainer(B)},getUniqueName:function(a,b,c,d){var e=0,f=[];if(/[^\d]\d{1}$/g.test(a)&&(a=a.substr(0,a.length-1)),a=tl("rule"),null==b[0])return a+"1";for(b.each(function(a){a.each(function(a){c.contains(a.Type)||f.push(a.Name)})}),d.each(function(a){a&&f.push(a.Name)});f.contains(a+ ++e););return a+e},_ruleInitEmpty:function(a){var b=G._findIndexNow();if(-2!=b){G._buildRuleJson();var c=JSON.decode(j).params.table[0][0],d=!1;if(c.Config.DetectLine)0==c.Config.DetectLine[0][0]&&0==c.Config.DetectLine[0][1]&&0==c.Config.DetectLine[1][0]&&0==c.Config.DetectLine[1][1]&&(a||h.DeleteShape(c.Name),d=!0);else if(c.Config.DetectRegion&&"array"==$type(c.Config.DetectRegion)){var e,f=c.Config.DetectRegion,g=!0;for(e=f.length;e--;)if(f[e][0]||f[e][1]){g=!1;break}g&&!a&&h.DeleteShape(c.Name),d=g}else d=!0;return"CrossFenceDetection"==c.Type&&c.Config.DownstairsLine&&c.Config.UpstairsLine&&(d="0,0,0,0"==c.Config.DownstairsLine.toString()&&"0,0,0,0"==c.Config.UpstairsLine.toString()?!0:!1),d}},_renderElements:function(){if((null==i[A]||0===i[A].length)&&(i[A]=[]),G._lockDisable(),G._disabledDraw(!1),G._renderRuleList(),a=G._findIndexNow(),0>a)return h.SetIVSConfig("",2),void(webApp.DeviceType.contains("TPC")&&B&&(h.RemoveOneIntelShapeContainer(B),B=null,D=null,C=null,E=[]));{var a=G._findIndexNow();i[A][a]}G._renderRule(),G._renderOcx()},_renderOcx:function(){var a=G._findIndexNow(),b=i[A][a];if(b)if(webApp.DeviceType.contains("TPC")){B&&(h.RemoveOneIntelShapeContainer(B),B=null,D=null,C=null,E=[]);var c,d,e,f=b.Type;switch(f){case"CrossRegionDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"CrossLineDetection":c="DetectLine",d=b.Config.DetectLine,e={DetectLine:d};break;case"LeftDetection":case"TakenAwayDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"MoveDetection":case"WanderDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"CrossFenceDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"ParkingDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;case"SmokeDetection":c="Polygon",d=b.Config.DetectRegion,e={Polygon:d};break;default:return}if(0==d[0][0]&&0==d[0][1]&&0==d[1][0]&&0==d[1][1])return;if(h.CreateOneIntelShapeContainer(A,"").done(function(a){B=a}),e=JSON.encode(e),shapeName=b.Name,h.CreateOneIntelShape(B,c,"VideoAnalyzeConfig",c,shapeName,e,"").done(function(a){C=a}),"none"!=$("ipcIntellentNew_ruleDirectionWrap").getStyle("display")||"none"!=$("ipcIntellentNew_ruleDirectionWrap2").getStyle("display")||"LeftDetection"==b.Type||"TakenAwayDetection"==b.Type){if("LeftDetection"==b.Type)var g=0;else if("TakenAwayDetection"==b.Type)var g=1;else if("CrossRegionDetection"==b.Type){var k=$("ipcIntellentNew_ruleDirection2").value;switch(k){case"Enter":var g=0;break;case"Leave":var g=1;break;case"Both":var g=2;break;default:var g=0}}else{var k=$("ipcIntellentNew_ruleDirection").value;switch(k){case"LeftToRight":var g=0;break;case"RightToLeft":var g=1;break;case"Both":var g=2;break;default:var g=0}}h.SetIntelShapeDirection(C,g)}h.SetOneIntelShapeDisplayColor(C,0,255,255,0),h.SetOneIntelShapeDisplayColor(C,1,0,0,255),h.SetOneIntelShapeThickness(C,2),h.SetOneIntelShapeVisible(C,!0),h.SelectOneIntelShape(C,!0)}else{var l=b.Config.SizeFilter;l&&isZeroArray(l.MaxSize)&&($("ipcIntellentNew_min").disabled=!0),G._buildRuleJson(),h.SetIVSConfig(j,2),h.SetCurShape(b.Name),G._ruleInitEmpty(),b.Enable&&("RioterDetection"==b.Type||(n.MaxRect=l&&l.MaxSize,n.MinRect=l&&l.MinSize,h.SetObjectConfig(JSON.encode(n)),h.SetCurPtzID(0))),h.SetCurShape("save")}},_renderRule:function(){var a=G._findIndexNow(),b=i[A][a];if(b){if(G._renderSizeFilter(b.Config.SizeFilter),G.eventHandler.set(b.EventHandler),webApp.DeviceType.contains("TPC"))if(b.Config.MinDuration&&"CrossLineDetection"!=b.Type?($("ipcIntellentNew_minDuration_wrap").style.display="",$("ipcIntellentNew_minDuration").value=b.Config.MinDuration):$("ipcIntellentNew_minDuration_wrap").style.display="none","CrossRegionDetection"==b.Type?($("ipcIntellentNew_RegionRule").style.display="",$("ipcIntellentNew_RegionRuleType").value=2==b.Config.Action.length?"both":"Cross"==b.Config.Action[0]?"Cross":"Inside"):$("ipcIntellentNew_RegionRule").style.display="none","CrossRegionDetection"==b.Type)$("ipcIntellentNew_RegionRule").style.display="",2==b.Config.Action.length?($("ipcIntellentNew_RegionRuleType").value="both",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$$(".InsideRule").setStyle("display","")):"Cross"==b.Config.Action[0]?($("ipcIntellentNew_RegionRuleType").value="Cross",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$$(".InsideRule").setStyle("display","none")):($("ipcIntellentNew_RegionRuleType").value="Inside",$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$$(".InsideRule").setStyle("display","")),$("ipcIntellentNew_MaxTargets").value=b.Config.MaxTargets,$("ipcIntellentNew_MinTargets").value=b.Config.MinTargets,$("ipcIntellentNew_ReportInterval").value=b.Config.ReportInterval,$("ipcIntellentNew_ruleDirection2").value=b.Config.Direction,$("ipcIntellentNew_ruleDirection2").selectedIndex="Enter"==b.Config.Direction?0:"Leave"==b.Config.Direction?1:2,G._changeRuleType();else if("SmokeDetection"==b.Type)$("ipcIntellentNew_RegionRule").style.display="none",$$(".InsideRule").setStyle("display","none"),$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_ReportIntervalcon").setStyle("display",""),$("ipcIntellentNew_ReportInterval").value=b.Config.ReportInterval;else if("LeftDetection"==b.Type||"TakenAwayDetection"==b.Type)$("ipcIntellentNew_RegionRule").style.display="none",$$(".InsideRule").setStyle("display","none"),$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$("ipcIntellentNew_minDuration").value=b.Config.MinDuration;else if($("ipcIntellentNew_RegionRule").style.display="none",$$(".InsideRule").setStyle("display","none"),b.Config.Direction){$("ipcIntellentNew_ruleDirectionWrap").style.display="";var c=$("ipcIntellentNew_ruleDirection").getElements("option");c[0].setProperty("text",tl("w_RightToLeft")),c[1].setProperty("text",tl("w_LeftToRight")),c[2].setProperty("text",tl("w_toBoth"));var d={LeftToRight:"RightToLeft",RightToLeft:"LeftToRight",Both:"Both"};$("ipcIntellentNew_ruleDirection").value=d[b.Config.Direction]}else $("ipcIntellentNew_ruleDirectionWrap2").style.display="none";else if(b.Config.MinDuration&&($("ipcIntellentNew_minDuration").value=b.Config.MinDuration),b.Config.Action){$("ivs_crd_cross").checked=!1,$("ivs_crd_appear").checked=!1,jQuery.each(b.Config.Action,function(a,b){switch(b){case"Cross":$("ivs_crd_cross").checked=!0;break;case"Appear":$("ivs_crd_appear").checked=!0}});var e="none";b.Config.Action.contains("Cross")&&(e=""),$("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",e)}b.Config.Direction&&($("ipcIntellentNew_ruleDirection").value=b.Config.Direction,$("ipcIntellentNew_ruleDirection2").value=b.Config.Direction,$("ipcIntellentNew_fenceDirection").value=b.Config.Direction),b.Config.Sensitivity&&v.set(b.Config.Sensitivity),$("ipcIntellentNew_TrackTime").value=void 0!==b.Config.TrackDuration?b.Config.TrackDuration:30,void 0!==b.TrackEnable&&($("ipcIntellentNew_TrackEnable").checked=b.TrackEnable),m&&b.EventHandler&&b.EventHandler.LightingLink&&(b.EventHandler.LightingLink.Enable&&$("ivs_light_type").getParent().getParent().removeClass("fn-hide"),$("ivs_light_link_enable").checked=b.EventHandler.LightingLink.Enable,$("ivs_light_type").value=b.EventHandler.LightingLink.FilckerLightType,$("ivs_light_duration").value=.1*b.EventHandler.LightingLink.FilckerIntevalTime,$("ivs_light_num").value=b.EventHandler.LightingLink.FilckerTimes,$("ivs_light_link_enable").addEvent("change",function(a){var b=a.target,c=b.checked;c?$("ivs_light_type").getParent().getParent().removeClass("fn-hide"):$("ivs_light_type").getParent().getParent().addClass("fn-hide")}),$("ivs_light_duration").addEvent("change",function(a){var b=a.target.value-0;b=Math.round(b)>b?parseInt(b)+.5:Math.round(b)<b?parseInt(b):b,$("ivs_light_duration").value=b}))}},_renderRuleDom:function(a){Page.ivsConfig._hideElement(),Page.ivsConfig.Tab[a]&&Page.ivsConfig.Tab[a].render(),"VideoAbnormalDetection"==a?jQuery("div[data-emptyDraw]").addClass("fn-hide"):jQuery("div[data-emptyDraw]").removeClass("fn-hide"),G.renderMinDuration(a),q.contains(a)&&webApp.IsIPCIntel?$("ipcIntellentNew_TriggerTrack").removeClass("fn-hide"):webApp.IsIPCIntel&&$("ipcIntellentNew_TriggerTrack").addClass("fn-hide")},_renderSizeFilter:function(a){if(a){var b=["MaxSize-0","MaxSize-1","MinSize-0","MinSize-1"];$("ipcIntellentNew_left").getElements("input[type=text]").each(function(c){var d=c.name;if(b.contains(d)){var e=d.split("-"),f=e[0],g=e[1]-0;c.value=a[f][g]}})}},_renderRuleList:function(a,c){var d=$("ipcIntellentNew_presets").value-0;a=i[A]||[];var e=w.getElement("tbody"),f=e.getElement(".current");if(f){var g=f.getProperty("data-index")-0;a[g]&&void 0==c&&(c=g)}for(var j=jQuery("<select></select>"),k=0;k<p.length;k++){var l=jQuery('<option value="'+p[k]+'" title="'+tl(p[k])+'">'+tl(p[k])+"</option>");j.append(l)}var m='<tr data-index="{index}" data-type="{type}" data-enable="{bool}">                                <td width="8%" class="enable"><input  data-input data-index="{index}" type="checkbox" class="ruleform fn-marl5"></td>                                <td width="10%" class="num fn-textcenter">{No}</td>                                <td width="37%" data-name="{index}" class="fn-indent10 fn-word-wrap">                                    <span class="ui-label fn-text-overflow fn-width120" style="height:20px;" title="{name}">{name}</span>                                    <input data-name class="fn-width110" value="{name}"/></td>                                <td width="37%" data-rule="{index}">                                    <span class="ruleSpan fn-padl10" style="display:block" data-value ={type}>{typevalue}</span>                                    <select class="fn-width110" style="display:none">'+j.html()+'<select></td>                                <td width="8%"><span class="ui-button-icon-clear" data-del="{index}"></span></td>                            </tr>',n=[],o=a.length;webApp.DeviceType.contains("TPC")&&0===o&&B&&(h.RemoveOneIntelShapeContainer(B),B=null,D=null,C=null,E=[]),e.empty();var q=1;a.each(function(a,b){a&&a.PtzPresetId==d&&-1!==p.indexOf(a.Type)&&n.push(m.substitute({bool:a.Enable,No:q++,index:b,type:a.Type,name:a.Name,typevalue:tl(a.Type)}))}),e.set("html",n.join("")),b($$("#ipcIntellentNew_ruleManager input[data-name]"),{maxByte:63});var f=e.getElements("tr");$("ipcIntellentNew_allRuleEnable").checked=!!f.length;for(var k=0;k<f.length;k++){var r=f[k].getProperty("data-type"),s=f[k].getElement("select");s.value=r;var t=f[k].getProperty("data-enable"),u=f[k].getElement("input");u.checked="false"===t?!1:!0,"false"===t&&($("ipcIntellentNew_allRuleEnable").checked=!1)}(void 0==c||0==c||0==e.getElements("tr[data-index="+c+"]").length)&&(0!=e.getElements("tr[data-index="+(c+1)+"]").length?c++:c=G._findIndexNow()),e.getElements("tr[data-index="+c+"]").addClass("current");var v=e.getElements("tr[data-index="+c+"]").getProperty("data-type");G._renderRuleDom(v[0]);var t=G._getAddStatus();$("ipcIntellentNew_fieldset").getElements("[data-add]").toggleClass("disabled",t);var x=$("ipcIntellentNew_tab_public");x.getElements("[data-emptyReules]").toggleClass("fn-hide",!f.length),x.getElements("[data-emptyDraw]").toggleClass("fn-invisib",!f.length)},_getAddStatus:function(){for(var a=i[A]||[],b=0,c=$("ipcIntellentNew_presets").value-0,d=0;d<a.length;d++)"Normal"==a[d].Class&&a[d].PtzPresetId==c&&b++;return b>=y||a.length>=x||0>=c&&-1!==webApp.DeviceType.indexOf("SD")?!0:!1},_findIndexNow:function(){var a=w.getElement(".current");if(null!==a)return a.getProperty("data-index")-0;var b=w.getElements("tr")[0];return b?b.getProperty("data-index")-0:-2},_buildRuleJson:function(){var a=G._findIndexNow(),b=i[A][a],c=jQuery.extend(!0,{},b);delete c.EventHandler;var d={result:!0,params:{table:[[c]]}};return c.PtzPresetId=0,j=JSON.encode(d),JSON.encode(d)},_drawRuleType:function(a){var b=G._findIndexNow(),c=i[A][b],d=c.Name,e=c.Type,f=jQuery("#ipcIntellentNew_ruleManager .current .enable input");if(f[0]&&!f[0].checked)return void remarkDisplay("ipcIntellentNew_remark1",tl("Rule isn't enable!"),3e3,1);if(webApp.DeviceType.contains("TPC")){if(null===b||"undefined"===b)return;if(a){if(B)C&&(G._delectOCXRule(C),C=null,D&&(G._delectOCXRule(D),D=null));else if(r)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1)}else B?C?(D&&G._displayOCXRule(D,!1),G._displayOCXRule(C,!0),h.SelectOneIntelShape(C,!0)):G._drawNewRule(B,e,d):G._drawNewRule(null,e,d);var g=G._ruleInitEmpty(!0);if(!g)return;G._disabledDraw(!0)}else{var j=$("ipcIntellentNew_ruleDirection").selectedIndex,k=$("ipcIntellentNew_presets").value-0,k=0;if(r)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);var g=G._ruleInitEmpty(!0);if(!g)return void(a||h.SelectRule(d,0));switch(h.DeleteShape(d),G._disabledDraw(!0),e){case"CrossRegionDetection":j=$("ipcIntellentNew_ruleDirection2").selectedIndex,c.Config.Action.contains("Cross")||(j=-1),h.AddShape(2,e,d,j,k);break;case"CrossLineDetection":h.AddShape(2,e,d,j,k);break;case"CrossFenceDetection":j=$("ipcIntellentNew_fenceDirection").selectedIndex,h.AddShape(2,e,d,j,k);break;default:h.AddShape(2,e,d,-1,k)}}},_rebuild:function(){e.DevVideoAnalyse.setModuleState(-1,1)},_changeRule:function(a){analyseRuleList=i[A]||[],a>=analyseRuleList.length&&(a=analyseRuleList.length-1),u=a,G._disabledDraw(!1),G._renderRule(),G._renderOcx()},_changeDiection:function(){G._renderOcx()},_disabledDraw:function(a,b){r=a,t=b,$("ipcIntellentNew_max").disabled=a,$("ipcIntellentNew_min").disabled=a,$("ipcIntellentNew_NumberSelect").disabled=a,$("ipcIntellentNew_ruleDirection").disabled=a,$("ipcIntellentNew_ruleInputName").disabled=a,$("ivs_crd_cross").disabled=a,$("ipcIntellentNew_ruleDirection2").disabled=a,$("ipcIntellentNew_fenceDirection").disabled=a},_onDefaultClick:function(){e.ConfigManager.getDefault("VideoAnalyseRule").done(function(a){for(var b=$("ipcIntellentNew_presets").value-0,c=i[A].length,d=c-1;d>=0;d--)i[A][d].PtzPresetId===b&&"Normal"==i[A][d].Class&&i[A].erase(i[A][d]);for(var e=a[0],d=0;d<e.length;d++)e[d]&&e[d].PtzPresetId===b&&"Normal"==e[d].Class&&i[A].push(e[d]);-1!==webApp.DeviceType.indexOf("TPC")&&(i[A]=a[A]),G._renderElements(),remarkDisplay("ipcIntellentNew_remark1",tl("Defaultsuccess"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Defaultfailure"),3e3,1)})},_onRefreshClick:function(b){e.ConfigManager.getConfig("VideoAnalyseRule").done(function(c){a=c,i=$unlink(a),G._renderElements(i),b!==!1&&remarkDisplay("ipcIntellentNew_remark1",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Operateingfailure"),3e3,1)})},_onConfirmClick:function(){var b=G._findIndexNow(),c=i[A][b];if(t)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);if(r){if(webApp.DeviceType.contains("TPC"))return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);r=!1,G._disabledDraw(!1),h.DeleteShape(c.Name)}if(!webApp.DeviceType.contains("TPC")&&c&&"CrossFenceDetection"==c.Type&&"0,0,0,0"==c.Config.DownstairsLine.toString()&&"0,0,0,0"!==c.Config.UpstairsLine.toString())return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);h.SetCurShape("save"),G._saveElements();var d=G._ruleRenameTest();if(!d){a=$unlink(i);var f=G.defCheckGlobal(a);f.done(function(){e.ConfigManager.setConfig("VideoAnalyseRule",a).done(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Succeed in saving configure"),3e3,0),e.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){a=b,i=$unlink(a),G._renderRule(),G._lockDisable()
})}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Saving failure"),3e3,1)})}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Saving failure"),3e3,1)})}},_lockDisable:function(){if(webApp.DeviceType.contains("TPC"))if(i&&i[A]&&i[A].length>0){var a=i[A],b=a.filter(function(a){return 1==a.TrackEnable&&1==a.Enable});s.disabledButton(b.length>0?!1:!0)}else s.disabledButton(!0)},defCheckGlobal:function(a){return jQuery.Deferred(function(b){-1==webApp.DeviceType.indexOf("SD")?b.resolve():e.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){var d=c;null==d[0]&&(d[0]={}),d=G.checkGlobal(d,a),e.ConfigManager.setConfig("VideoAnalyseGlobal",d).done(function(){b.resolve()}).fail(function(){b.reject("setGlobalFailed")})}).fail(function(){b.reject("getGlobalFailed")})})},checkGlobal:function(a,b){var c=0,d=[],e="";for(var f in a[c])-1!==f.indexOf("Scene")&&(d.push(a[c][f].PtzPresetId),e+=f);for(var g=0;g<b[c].length;g++)if(b[c][g].PtzPresetId&&-1==jQuery.inArray(b[c][g].PtzPresetId,d)&&0!==b[c][g].PtzPresetId&&-1!==b[c][g].PtzPresetId){for(var h,i=0;255>i&&(h="Scene"+(0==i?"":i),-1!==e.indexOf(h));i++);var j=h.replace("Scene","CalibrateArea");a[c][h]=jQuery.extend(!0,{},l.Scene),a[c][j]=null!==l.CalibrateArea?jQuery.extend(!0,{},l.CalibrateArea):null,a[c][h].PtzPresetId=b[c][g].PtzPresetId,a[c][h].Type="Normal",d.push(b[c][g].PtzPresetId)}return a},_saveElements:function(){var a=G._findIndexNow(),b=i[A][a];if(b){if(b.Config.MinDuration&&"MoveDetection"!=b.Type&&(b.Config.MinDuration=$("ipcIntellentNew_minDuration").value-0),void 0!==b.Config.Direction)switch(b.Type){case"CrossLineDetection":b.Config.Direction=$("ipcIntellentNew_ruleDirection").value;break;case"CrossRegionDetection":-1!==webApp.DeviceType.indexOf("TPC")?(b.Config.Action&&(b.Config.Direction=$("ipcIntellentNew_ruleDirection2").value),b.Config.MaxTargets=$("ipcIntellentNew_MaxTargets").value-0,b.Config.MinTargets=$("ipcIntellentNew_MinTargets").value-0,b.Config.ReportInterval=$("ipcIntellentNew_ReportInterval").value-0):b.Config.Action&&b.Config.Action.contains("Cross")&&(b.Config.Direction=$("ipcIntellentNew_ruleDirection2").value);break;case"CrossFenceDetection":b.Config.Direction=$("ipcIntellentNew_fenceDirection").value}return-1!==webApp.DeviceType.indexOf("TPC")&&b.Config.Action&&(b.Config.Action="both"==$("ipcIntellentNew_RegionRuleType").value?["Cross","Inside"]:"Cross"==$("ipcIntellentNew_RegionRuleType").value?["Cross"]:["Inside"]),b.Config.Sensitivity&&(b.Config.Sensitivity=v.slider.step),void 0!==b.Config.TrackDuration&&(b.Config.TrackDuration=$("ipcIntellentNew_TrackTime").value-0),void 0!==b.TrackEnable&&(b.TrackEnable=$("ipcIntellentNew_TrackEnable").checked),m&&b.EventHandler.LightingLink&&(b.EventHandler.LightingLink.Enable=$("ivs_light_link_enable").checked,b.EventHandler.LightingLink.FilckerLightType=$("ivs_light_type").value,b.EventHandler.LightingLink.FilckerIntevalTime=10*($("ivs_light_duration").value-0),b.EventHandler.LightingLink.FilckerTimes=$("ivs_light_num").value-0),b.EventHandler=G.eventHandler.get(),b}},_ruleRenameTest:function(){var a=[],b=0,c=0,d=null,e=null,f=!1;return i.each(function(d){-1!==webApp.DeviceType.indexOf("TPC")&&webApp.CHANNEL_NUMBER>1&&(a=[]),d.each(function(d){if(-1!==webApp.DeviceType.indexOf("SD")&&"Gate"==d.Class)return!1;var e=d.Name;if(f)return!1;if(-1!==webApp.DeviceType.indexOf("TPC")&&"FaceDetection"===e)return!0;var g=a.some(function(a){return a.Name==e?(c=a.Type,b=d.Type,f=!0,!0):!1});g||a.include({Name:e,Type:d.Type})})}),f&&(d=G._stringShow(c),e=G._stringShow(b),remarkDisplay("ipcIntellentNew_remark1",tl(d)+" "+tl("w_and")+" "+tl(e)+" "+tl("w_groupNameSame"),3e3,1)),f},_stringShow:function(a){return"CrossLineDetection"==a?a="w_CrossLineDetection":"CrossRegionDetection"==a&&(a="w_CrossRegionDetection"),a},_onSetupClick:function(){var a=G._findIndexNow();if(!(-1>=a)){h.hide();var b=i[A][a];b&&b.EventHandler&&b.EventHandler.TimeSection&&f.open(b.EventHandler.TimeSection,null,function(){h.cover("#ipcintellentNewVideo")}).done(function(a){b.EventHandler.TimeSection=a}).always(function(){h.cover("#ipcintellentNewVideo")})}},outPutShapeRect:function(a){var b=G._findIndexNow(),c=i[A][b];G._disabledDraw(!1);var d=c.Type,e=JSON.decode(a);if(webApp.DeviceType.contains("TPC")){var f=e.EventParam.ShapeID;switch(d){case"CrossLineDetection":if("DetectLine"==e.EventParam.ShapeID)c.Config.DetectLine=e.ShapeData.DetectLine;else if("BigFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];j=Math.abs(parseInt(j)),k=Math.abs(parseInt(k)),c.Config.SizeFilter.MaxSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=k}else if("SmallFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];c.Config.SizeFilter.MinSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=k}G._disabledDraw(!1);break;case"CrossFenceDetection":if("Polygon"==e.EventParam.ShapeID){if(e.ShapeData.DetectLine.length<3){G._disabledDraw(!0);break}c.Config.DetectRegion=e.ShapeData.DetectLine}else if("BigFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];j=Math.abs(parseInt(j)),k=Math.abs(parseInt(k)),c.Config.SizeFilter.MaxSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=k}else if("SmallFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];c.Config.SizeFilter.MinSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=k}break;case"CrossRegionDetection":case"LeftDetection":case"MoveDetection":case"WanderDetection":case"TakenAwayDetection":if("Polygon"==e.EventParam.ShapeID){if(e.ShapeData.DetectLine.length<3){G._disabledDraw(!0);break}c.Config.DetectRegion=e.ShapeData.DetectLine}else if("BigFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];j=Math.abs(parseInt(j)),k=Math.abs(parseInt(k)),c.Config.SizeFilter.MaxSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=k}else if("SmallFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];c.Config.SizeFilter.MinSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=k}break;case"ParkingDetection":c.Config.DetectRegion=e.Config.DetectRegion;break;case"VideoAbnormalDetection":c.Config.DetectRegion=e.Config.DetectRegion;break;case"SmokeDetection":if("Polygon"==e.EventParam.ShapeID){if(e.ShapeData.DetectLine.length<3){G._disabledDraw(!0);break}c.Config.DetectRegion=e.ShapeData.DetectLine}else if("BigFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];j=Math.abs(parseInt(j)),k=Math.abs(parseInt(k)),c.Config.SizeFilter.MaxSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MaxSize-"]')[1].value=k}else if("SmallFilter"==e.EventParam.ShapeID){var g=e.ShapeData.RectangleShape,j=g[1][0]-g[0][0],k=g[1][1]-g[0][1];c.Config.SizeFilter.MinSize=[j,k],$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[0].value=j,$$('#ipcIntellentNew_object_filter_ck input[name^="MinSize-"]')[1].value=k}break;default:c.Config.DetectRegion=e.Config.DetectRegion}h.SelectOneIntelShape(f,!0)}else switch(d){case"CrossLineDetection":e.Config.DetectLine&&(c.Config.DetectLine=e.Config.DetectLine);break;case"CrossFenceDetection":e.Config.UpstairsLine&&(c.Config.UpstairsLine=e.Config.UpstairsLine),e.Config.DownstairsLine&&(c.Config.DownstairsLine=e.Config.DownstairsLine);break;case"CrossRegionDetection":case"LeftDetection":case"TakenAwayDetection":if(e.Config.DetectRegion.length<3){G._disabledDraw(!0);break}e.Config.DetectRegion&&(c.Config.DetectRegion=e.Config.DetectRegion);break;default:e.Config.DetectRegion&&(c.Config.DetectRegion=e.Config.DetectRegion)}},outPutRuleRect:function(a){var b=G._findIndexNow(),c=i[A][b];G._disabledDraw(!1);var d=JSON.decode(a);d.OutPutRuleRect&&(c.Config.MinDetectRect=d.OutPutRuleRect)},setFilterValue:function(a){var b=G._findIndexNow(),c=i[A][b],d=!1,e=JSON.decode(a),f=c.Config.SizeFilter,g=[1,1];e.MinRect?f.MinSize=e.MinRect:e.MaxRect&&(f.MaxSize=e.MaxRect,g=e.MaxRect),d=isZeroArray(g),G._renderSizeFilter(f),G._disabledDraw(d,d)},_displayOCXRule:function(a,b){h.SetOneIntelShapeVisible(a,b)},_drawNewRule:function(a,b,c){switch(D=null,C=null,E=[],a?a=B:h.CreateOneIntelShapeContainer(A,"").done(function(a){B=a}),b){case"CrossRegionDetection":var d="Polygon";break;case"CrossLineDetection":var d="DetectLine";break;case"TakenAwayDetection":var d="Polygon";break;case"MoveDetection":var d="Polygon";break;case"WanderDetection":var d="Polygon";break;case"CrossFenceDetection":var d="Polygon";break;case"LeftDetection":var d="Polygon";case"ParkingDetection":var d="Polygon";break;case"SmokeDetection":var d="Polygon"}if(h.CreateOneIntelShape(B,d,"VideoAnalyzeConfig",d,c,"","").done(function(a){C=a}),"none"!==$("ipcIntellentNew_ruleDirectionWrap").getStyle("display")||"none"!=$("ipcIntellentNew_ruleDirectionWrap2").getStyle("display")){if("LeftDetection"==b)var e=0;else if("TakenAwayDetection"==b)var e=1;else if("CrossRegionDetection"==b){var f=$("ipcIntellentNew_ruleDirection2").value;switch(f){case"Enter":var e=0;break;case"Leave":var e=1;break;case"Both":var e=2;break;default:var e=0}}else{var f=$("ipcIntellentNew_ruleDirection").value;switch(f){case"LeftToRight":var e=0;break;case"RightToLeft":var e=1;break;case"Both":var e=2;break;default:var e=0}}h.SetIntelShapeDirection(C,e)}h.SetOneIntelShapeDisplayColor(C,0,255,255,0),h.SetOneIntelShapeDisplayColor(C,1,0,0,255),h.SetOneIntelShapeThickness(C,2),h.SetOneIntelShapeVisible(C,!0),h.SelectOneIntelShape(C,!0)},_delectOCXRule:function(a){h.DeleteOneIntelShape(a)},_drawOCXFilter:function(a,b){var c=b.Config.SizeFilter;if(b.Config.SizeFilter)var d=b.Config.SizeFilter.MinSize,e=b.Config.SizeFilter.MaxSize;else{var d=c.MinSize,e=c.MaxSize;b.Config.SizeFilter={},b.Config.SizeFilter.MinSize=d,b.Config.SizeFilter.MaxSize=e}var f=(8191-d[0])/2,g=(8191-d[1])/2,i=[[f,g],[d[0]+f,d[1]+g]],j=(8191-e[0])/2,k=(8191-e[1])/2,l=[[j,k],[e[0]+j,e[1]+k]],m="VideoAnalyzeConfig";if("BigSmallFilterBox"==a){D&&h.DeleteOneIntelShape(D),E=[];var n="BigSmallFilterBox",o="",m="VideoAnalyzeConfig";h.CreateOneIntelShape(B,"BigSmallFilterBox",m,n,"","","").done(function(a){D=a});var o={RectangleShape:i};o=JSON.encode(o);var p,n="SmallFilter";h.AddOneSubIntelShape(B,D,"RectangleShape",m,n,"",o,"").done(function(a){p=a}),E.push(p);var o={RectangleShape:l};o=JSON.encode(o);var q,n="BigFilter";h.AddOneSubIntelShape(B,D,"RectangleShape",m,n,"",o,"").done(function(a){q=a}),E.push(q)}else if("SmallFilter"==a){var o={RectangleShape:i};o=JSON.encode(o);var p,n="SmallFilter";h.AddOneSubIntelShape(B,D,"RectangleShape",m,n,"",o,"").done(function(a){p=a}),E[0]=p}else if("BigFilter"==a){var o={RectangleShape:l};o=JSON.encode(o);var q,n="BigFilter";h.AddOneSubIntelShape(B,D,"RectangleShape",m,n,"",o,"").done(function(a){q=a}),E[1]=q}h.SetOneIntelShapeDisplayColor(p,0,0,255,255),h.SetOneIntelShapeDisplayColor(p,1,0,255,255),h.SetOneIntelShapeThickness(p,1),h.SetOneIntelShapeDisplayColor(q,0,0,255,255),h.SetOneIntelShapeDisplayColor(q,1,0,255,255),h.SetOneIntelShapeThickness(q,2),$("ipcIntellentNew_max").checked?(h.SelectOneIntelShape(q,!0),h.SelectOneIntelShape(p,!1)):(h.SelectOneIntelShape(q,!1),h.SelectOneIntelShape(p,!0))},_changeRuleType:function(){0==$("ipcIntellentNew_RegionRuleType").selectedIndex?($("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$$(".InsideRule").setStyle("display","none")):1==$("ipcIntellentNew_RegionRuleType").selectedIndex?($("ipcIntellentNew_ruleDirectionWrap2").setStyle("display","none"),$$(".InsideRule").setStyle("display","")):2==$("ipcIntellentNew_RegionRuleType").selectedIndex&&($("ipcIntellentNew_ruleDirectionWrap2").setStyle("display",""),$$(".InsideRule").setStyle("display",""))},_attachLimitCompare:function(a,b,c,d,e){var f=$(a),g=$(b);f.removeEvents("keyup"),f.removeEvents("blur"),f.addEvents({keyup:function(){limit(this,d)},blur:function(){limit(this,d),limitMin(this,c),e?this.value-0>g.value-0&&(this.value=g.value):this.value-0<g.value-0&&(this.value=g.value)}})}};G.SD={bind:function(){$("ipcIntellentNew_presets").addEvent("change",function(){var a=this.value-0,b=this.getSelected()[0];b&&b.hasClass("fn-color-ivsGreen")?this.addClass("fn-color-ivsGreen"):this.removeClass("fn-color-ivsGreen"),-1!==webApp.DeviceType.indexOf("SD")?e.PTZ.gotoPreset(a).always(function(){G._disabledDraw(!1),G._renderElements(i)}):(G._disabledDraw(!1),G._renderElements(i))})},render:function(){webApp.DeviceType.contains("SD")?this.getPresets(function(){$("ipcIntellentNew_presets").fireEvent("change")}):($$(".sd-line").addClass("fn-hide"),$("ipcIntellentNew_presets_wrap").addClass("fn-hide"),$("ipcIntellentNew_presets").empty(),$("ipcIntellentNew_presets").options.add(new Option(tl("addPresetFirst"),0)),$("ipcIntellentNew_presets").fireEvent("change"))},getPresets:function(a){e.PTZ.getPresets().done(function(b){var c=b||[];if($("ipcIntellentNew_presets").empty(),0==c.length)$("ipcIntellentNew_presets").options.add(new Option(tl("addPresetFirst"),-1)),a&&a();else{var d=$("ipcIntellentNew_presets");if(-1===webApp.DeviceType.indexOf("TPC")){for(var f=[],g=0;g<c.length;g++){var h=new Option(c[g].Name,c[g].Index);$(h).setProperty("title",c[g].Name),1===c[g].Type?($(h).addClass("fn-color-ivsGreen"),d.options.add(h)):($(h).addClass("fn-color-black"),f.push(h))}f.each(function(a){d.options.add(a)})}else{for(var g=0;g<c.length;g++){var h=new Option(c[g].Name,c[g].Index);$(h).setProperty("title",c[g].Name),d.options.add(h),$(h).addClass("fn-color-black")}for(var i in F[A])if(i.contains("Scene")){var j=F[A][i].PtzPresetId;jQuery("#ipcIntellentNew_presets").find('[value="'+j+'"]').removeClass("fn-color-black").addClass("fn-color-ivsGreen")}}e.ConfigManager.getConfig("PtzMovement").done(function(a){"Preset"==a[0].Function&&($("ipcIntellentNew_presets").value=a[0].Index+1),$("ipcIntellentNew_presets").selectedIndex<0&&($("ipcIntellentNew_presets").selectedIndex=0)}).always(function(){a&&a()})}}).fail(function(){$$(".sd-line").addClass("fn-hide"),$("ipcIntellentNew_presets_wrap").addClass("fn-hide"),$("ipcIntellentNew_presets").empty(),$("ipcIntellentNew_presets").options.add(new Option(tl("addPresetFirst"),0)),a&&a()})}}}}(),function(){function a(a){var b=a-0;return 10>a-0?"0"+(b-0):b}var b,c,d={},f={},g=574/86400,k={},l=0,m=null,n=Page.ivsConfig.Tab.Track={Tab:[],init:function(){n.dialog=new Dialog("ipcIntellentNew_setTimeTable",function(){},"ipcIntellentNew_timeConfirm0","ipcIntellentNew_timeCancle0",tl("w_TimeAlarmPeriod")),n.dialog.setPosition(200,3),n.bind(),n._DragInit()},_DragInit:function(){d=new Drag.Move("ivs_track_dayTime_slider",{snap:1,modifiers:{x:"left",y:""},container:$("ivs_track_slider_line"),onSnap:function(){},onDrag:function(a){$("ivs_track_slider_daytime").style.left=a.style.left.toInt()+1+"px";var b=$("ivs_track_nightTime_slider").getStyle("left").toInt()-a.style.left.toInt()-13;0>=b?(a.style.left=$("ivs_track_nightTime_slider").getStyle("left").toInt()-13+"px",$("ivs_track_slider_daytime").style.width="0px"):$("ivs_track_slider_daytime").style.width=b+"px",n._showStartTime(a)},onComplete:function(a){k.start=n._getTime(a.style.left.toInt()),n._setColorEEMode()}}),f=new Drag.Move("ivs_track_nightTime_slider",{snap:1,modifiers:{x:"left",y:""},container:$("ivs_track_slider_line"),onSnap:function(){},onDrag:function(a){var b=a.style.left.toInt()-$("ivs_track_dayTime_slider").getStyle("left").toInt()-13;$("ivs_track_slider_daytime").style.left=$("ivs_track_dayTime_slider").getStyle("left").toInt()+1+"px",0>=b?(a.style.left=$("ivs_track_dayTime_slider").getStyle("left").toInt()+13+"px",$("ivs_track_slider_daytime").style.width="0px"):$("ivs_track_slider_daytime").style.width=b+"px",$("ivs_track_slider_timeTitle").style.left=a.style.left.toInt()-11+"px",n._showEndTime(a)},onComplete:function(a){k.end=n._getTime(a.style.left.toInt()-13),n._setColorEEMode()}}),l=0},render:function(){h.hide(),k={},l=0,$("ipcIntellentNew_timeConfirm0").removeEvents("click").addEvent("click",n._saveTimePeriod),$$("#ipcIntellentNew_setTimeTable a[id^=ipcIntellentNew_tmset]").removeEvents("click").addEvent("click",function(){var a=this.id.replace(/[^\d]/g,"");n._putTimePeriod(a)}),$("ipcIntellentNew_setTimeTable").setStyle("top","-10000px"),$("ipcIntellentNew_chartZone").removeEvents(),n.schedule=new Schedule("ipcIntellentNew_chartZone",{type:"general",onChange:function(){n._putTimePeriod(n.schedule._day)}}),e.ConfigManager.getConfig(["TrackerPolicy","TrackerPolicySchedule"]).done(function(a){b=a[0].params.table,c=a[1].params.table,n._renderElements()})},bind:function(){$("newIntellent_confirm1_track").addEvent("click",n._onConfirmClick),$("newIntellent_refresh1_track").addEvent("click",n._onRefreshClick),$("newIntellent_default1_track").addEvent("click",n._onDefaultClick),$("ivs_track_dayTime_slider").addEvent("mouseover",function(){$("ivs_track_slider_timeTitle").style.display="",n._showStartTime(this)}).addEvent("mouseout",function(){$("ivs_track_slider_timeTitle").style.display="none"}),$("ivs_track_nightTime_slider").addEvent("mouseover",function(){$("ivs_track_slider_timeTitle").style.display="",n._showEndTime(this)}).addEvent("mouseout",function(){$("ivs_track_slider_timeTitle").style.display="none"}),$("ivs_track_setButton").removeEvents("click").addEvent("click",n._onSetupClick),$$("#ipcIntellentNew_setTimeTable a[id^=ipcIntellentNew_tmset]").removeEvents("click").addEvent("click",function(){var a=this.id.replace(/[^\d]/g,"");n._putTimePeriod(a)}),$$("#ivs_track_visible,#ivs_track_thermal,#ivs_track_time").addEvent("click",n._onTrackMode)},leave:function(){},_renderElements:function(){"Visual"==b.TrackMode?($("ivs_track_visible").checked=!0,$("ivs_track_thermal").checked=!1,$("ivs_track_time").checked=!1,$$(".periodAuto").setStyle("display","none")):"Thermography"==b.TrackMode?($("ivs_track_visible").checked=!1,$("ivs_track_thermal").checked=!0,$("ivs_track_time").checked=!1,$$(".periodAuto").setStyle("display","none")):($("ivs_track_visible").checked=!1,$("ivs_track_thermal").checked=!1,$("ivs_track_time").checked=!0,$$(".periodAuto").setStyle("display",""),$("ivs_track_showNor").setStyle("display",""));var d=c.TimeSection[0][0],e=parsrTimeEx(d),f=e[1],h=e[2],i=e[3],j=e[4],l=e[5],m=e[6];k.start=a(e[1])+":"+a(e[2]),k.end=a(e[4])+":"+a(e[5]);var n=((3600*j+60*l+m)*g+13+.499999).round(),o=((3600*f+60*h+i)*g+.499999).round();0==f-0&&0==h-0&&(o=0),n>587&&(n=587),13>=n-o&&(o=n-13),$("ivs_track_nightTime_slider").style.left=n+"px",$("ivs_track_dayTime_slider").style.left=o+"px",$("ivs_track_slider_daytime").style.width=n-o-13+"px",$("ivs_track_slider_daytime").style.left=o+1+"px",$("ivs_track_slider_daytime").set("text",tl(""))},_onNormalMode:function(){$("ivs_track_showNor").setStyle("display",""),n._DragInit()},_onAdvanceMode:function(){$("ivs_track_showNor").setStyle("display","none")},_onTrackMode:function(){this.id.contains("_time")?$$(".periodAuto").setStyle("display",""):$$(".periodAuto").setStyle("display","none")},_onDefaultClick:function(){k={},l=0,e.ConfigManager.getDefault(["TrackerPolicy","TrackerPolicySchedule"]).done(function(a){b=a[0].params.table,c=a[1].params.table,n._renderElements(),remarkDisplay("newIntellent_remark1",tl("Defaultsuccess"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("Defaultfailure"),3e3,1)})},_onRefreshClick:function(){k={},l=0,e.ConfigManager.getConfig(["TrackerPolicy","TrackerPolicySchedule"]).done(function(a){b=a[0].params.table,c=a[1].params.table,n._renderElements(),remarkDisplay("newIntellent_remark1",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("Operateingfailure"),3e3,1)})},_onConfirmClick:function(){if(b.TrackMode=$("ivs_track_visible").checked?"Visual":$("ivs_track_thermal").checked?"Thermography":"TimeSection",$("ivs_track_normal").checked){for(c.Mode="Normal",j=0;j<c.TimeSection[0].length;j++)j>0&&(c.TimeSection[0][j]="0 00:00:00-23:59:59");for(i=0;i<c.TimeSection.length;i++)c.TimeSection[i]=c.TimeSection[0]}else c.Mode="Advanced";$("ivs_track_time").checked?e.ConfigManager.setConfig(["TrackerPolicy","TrackerPolicySchedule"],[b,c]).done(function(){remarkDisplay("newIntellent_remark1",tl("Succeed in saving configure"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("Saving failure"),3e3,1)}):e.ConfigManager.setConfig(["TrackerPolicy"],[b]).done(function(){remarkDisplay("newIntellent_remark1",tl("Succeed in saving configure"),3e3,0)}).fail(function(){remarkDisplay("newIntellent_remark1",tl("Saving failure"),3e3,1)})},_showStartTime:function(a){var b;a=a||this,b=a.style.left.toInt(),$("ivs_track_slider_timeTitle").style.left=b-18+"px",$("ivs_track_slider_timeTitle").set("text",n._getTime(b))},_showEndTime:function(a){var b;a=a||this,b=a.style.left.toInt(),$("ivs_track_slider_timeTitle").style.left=b-11+"px",$("ivs_track_slider_timeTitle").set("text",n._getTime(b-13))},_getTime:function(a){var b={};return a>574&&(a=574),a=a/574*24*60,b.hour=(a/60).toInt(),b.minite=(a%60).toInt(),b.hour<10&&(b.hour="0"+b.hour),b.minite<10&&(b.minite="0"+b.minite),"{hour}:{minite}".substitute(b)},_chkTime:function(){var a=k.start,b=k.end,c=a.split(":")[0]-0,d=a.split(":")[1]-0,e=0,f=b.split(":")[0]-0,g=b.split(":")[1]-0,h=0,i=60*(60*c+d)+e,j=60*(60*f+g)+h;return 24==c&&24==f||c>f?!0:i==j},_setColorEEMode:function(){if(1!=l){c.TimeSection[0][1]="0 00:00:00-23:59:59";var b=k.start,d=k.end,e=b.split(":")[0]-0,f=b.split(":")[1]-0,g=0,h=d.split(":")[0]-0,i=d.split(":")[1]-0,j=0,m=a(h),n=a(i),o=a(j),p=a(e),q=a(f),r=a(g),s=m+":"+n+":"+o,t=p+":"+q+":"+r;c.TimeSection[0][0]="1 "+t+"-"+s,c.TimeSection[0][1]="0 00:00:00-00:00:00"}},_onSetupClick:function(){n._drawTimeChart(),n._putTimePeriod(0),n.dialog.show(),$("ipcIntellentNew_setTimeTable").style.top="50px"},_drawTimeChart:function(){m=Array.clone(c.TimeSection),n.schedule.render(c.TimeSection)},_putTimePeriod:function(b){n.schedule._day=b;for(var d=c.TimeSection[b],e=0;6>e;e++){var f=parsrTimeEx(d[e]);$("ipcIntellentNew_ts"+e).checked=getBitEx(f[0],0)?!0:!1,$("ipcIntellentNew_t"+e+"0").value=a(f[1]),$("ipcIntellentNew_t"+e+"1").value=a(f[2]),$("ipcIntellentNew_t"+e+"2").value=a(f[3]),$("ipcIntellentNew_t"+e+"3").value=a(f[4]),$("ipcIntellentNew_t"+e+"4").value=a(f[5]),$("ipcIntellentNew_t"+e+"5").value=a(f[6])}for(var e=0;7>e;e++)$("ipcIntellentNew_day"+e).checked=!1,$("ipcIntellentNew_day"+e).disabled=!1,$("ipcIntellentNew_titleday"+e).removeClass("fn-color-red");$("ipcIntellentNew_allweek").checked=!1,$("ipcIntellentNew_day"+b).checked=!0,$("ipcIntellentNew_day"+b).disabled=!0,$("ipcIntellentNew_titleday"+b).addClass("fn-color-red")},_onLinkChange:function(){var a=this.value,b=$("ipcIntellentNew_address1"),c=$("ipcIntellentNew_addressInput1"),d=parseInt(c.value);if(d=isNaN(d)?0:d,"None"==a)b.setStyle("display","none"),c.setStyle("display","none");else{switch(b.setStyle("display",""),c.setStyle("display",""),a){case"Preset":attachLimit(c,g_ptzCap.PresetMin,g_ptzCap.PresetMax);break;case"Tour":attachLimit(c,g_ptzCap.TourMin,g_ptzCap.TourMax);break;case"Pattern":attachLimit(c,g_ptzCap.PatternMin,g_ptzCap.PatternMax)}c.fireEvent("blur")}},_saveTimePeriod:function(){var a=c.TimeSection,b=[];for(i=0;i<6;i++)b[i]=$("ipcIntellentNew_ts"+i).checked?"1 "+$("ipcIntellentNew_t"+i+"0").value+":"+$("ipcIntellentNew_t"+i+"1").value+":"+$("ipcIntellentNew_t"+i+"2").value+"-"+$("ipcIntellentNew_t"+i+"3").value+":"+$("ipcIntellentNew_t"+i+"4").value+":"+$("ipcIntellentNew_t"+i+"5").value:"0 "+$("ipcIntellentNew_t"+i+"0").value+":"+$("ipcIntellentNew_t"+i+"1").value+":"+$("ipcIntellentNew_t"+i+"2").value+"-"+$("ipcIntellentNew_t"+i+"3").value+":"+$("ipcIntellentNew_t"+i+"4").value+":"+$("ipcIntellentNew_t"+i+"5").value;for(i=0;i<7;i++)$("ipcIntellentNew_day"+i).checked&&(a[i]=b);n.dialog.obj.style.top="-10000px"}}}()}),define("PtzCmd",function(require,a,b){var c=require("jsCore/rpc"),d=new Class({moreFunc:function(){},initialize:function(a,b,c){this.dom=$(a),"function"==typeof c&&(this.moreFunc=c),this.option=b,this.step=5,this.newProtocol=webApp.IsNewProtocol&&-1!==webApp.DeviceType.indexOf("SD"),this.initDom(),this.bind(),this.dom.translation()},initDom:function(){var a='<div class="fn-left fn-width150"><div class="ui-boat fn-marl10"><div class="ui-boat-current"><div class="ui-boat-box-up boat ptzcontrol" data-hover="up" data-cmd="Up"></div><div class="ui-boat-box-left boat ptzcontrol" data-hover="left" data-cmd="Left"></div><div class="ui-boat-box-center" data-hoverEx="img3" data-cmdEx="Default"></div><div class="ui-boat-box-right boat ptzcontrol" data-hover="right" data-cmd="Right"></div><div class="ui-boat-box-down  boat ptzcontrol" data-hover="down" data-cmd="Down"></div></div></div><div class="ui-form-item" ><label class="ui-label fn-width-auto fn-marr4" t="w_Step"></label><select class="ui-select fn-width60" onmousewheel="javascript:return false"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected="">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div></div><div class="fn-left ptz-adjust"><div class="ui-ptz-adjust-item fn-clear capZoom"><a class="ui-ptz-icon ptzcontrol" data-cmd="ZoomWide"><i class="ui-ptz-icon-less" data-cmd="ZoomWide"></i></a><label class="ui-ptz-adjust-text" t="w_Zoom"></label><a class="ui-ptz-icon ptzcontrol ZoomTele" data-cmd="ZoomTele"><i class="ui-ptz-icon-more" data-cmd="ZoomTele"></i></a></div><div class="ui-ptz-adjust-item fn-clear capFocus"><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusFar"><i class="ui-ptz-icon-less" data-cmd="FocusFar"></i></a><label class="ui-ptz-adjust-text" t="W_focus"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="FocusNear"><i class="ui-ptz-icon-more" data-cmd="FocusNear"></i></a></div><div class="ui-ptz-adjust-item fn-clear capIris"><a class="ui-ptz-icon ptzcontrol"  data-cmd="IrisSmall"><i class="ui-ptz-icon-less" data-cmd="IrisSmall"></i></a><label class="ui-ptz-adjust-text" t="w_Iris"></label><a class="ui-ptz-icon ptzcontrol" data-cmd="IrisLarge"><i class="ui-ptz-icon-more" data-cmd="IrisLarge"></i></a></div></div><div class="fn-left fn-padt10 fn-padl20"><div class="ui-form-item" ><a data-cmd="markSceneMaxZoom" href="javascript:;" class=" fn-marb10 ui-button fn-hide markSceneMaxZoom" t="setTrackDynameter"></a></div><div class="ui-form-item" ><a data-cmd="setPreset" href="javascript:;" class="ui-button fn-hide setPreset" t="savePreset"></a></div></div>';this.dom.set("html",a),this.domHover=this.dom.getElement(".ui-boat-current");var b=this.dom;c.PTZ.getCurrentProtocolCaps().done(function(a){a&&(a.Zoom===!1&&b.getElement(".capZoom").addClass("fn-hide"),a.Focus===!1&&b.getElement(".capFocus").addClass("fn-hide"),a.Iris===!1&&b.getElement(".capIris").addClass("fn-hide"))});var d=this;ability.get("TrackPositionLimit").done(function(a){a&&a.Support&&d.option.markScene===!0&&d.dom.getElements(".markSceneMaxZoom").removeClass("fn-hide")}),this.option.setPreset===!0&&this.dom.getElements(".setPreset").removeClass("fn-hide"),this.dom.setStyles({"float":"left","min-width":"400px","min-height":"130px"})},bind:function(){var a=this;a.dom.getElements(".ptzcontrol").each(function(b){b.addEvents({mousedown:function(b){var d=b.target.getProperty("data-cmd");this.addClass("mouse-down"),null!==d&&c.PTZ.start(d,a.step,0,0,0)},mouseout:function(b){var d=b.target.getProperty("data-cmd");this.hasClass("mouse-down")&&(this.removeClass("mouse-down"),c.PTZ.stop(d,a.step,0,0,0),a.moreFunc())},mouseup:function(b){var d=b.target.getProperty("data-cmd");this.removeClass("mouse-down"),null!==d&&(c.PTZ.stop(d,a.step,0,0,0),a.moreFunc())}})}),a.dom.getElements(".boat").each(function(b){b.addEvents({mouseover:function(){if(this.getProperty){var b=this.getProperty("data-hover");null!=b&&a.domHover.addClass("ui-boat-current-"+b)}},mouseout:function(b){if(b.target.getProperty){var c=(b.target.getProperty("data-cmd"),b.target.getProperty("data-hover"));null!=c&&a.domHover.removeClass("ui-boat-current-"+c)}}})}),a.dom.getElement("select").addEvent("change",function(b){a.step=b.target.value-0}),a.dom.getElements("a").addEvent("click",function(){var a=this.getProperty("data-cmd"),b=$("ivs_global_presets").value-0,d=$("ivs_global_presets").getSelected()[0].text;switch(a){case"markSceneMaxZoom":var e=$("ivs_global_presets").value-0,f=0;if(0>=e)return void remarkDisplay("ivs_global_remark",tl("notIvsPresetNow"),6e3,1);c.PTZ.getStatus().done(function(a){var b=a.Postion[2];c.ConfigManager.getConfig("VideoAnalyseModule").done(function(a){for(var d=a,g=0;g<d[f].length;g++)if(d[f][g].PtzPresetId==e){d[f][g].MaxTrackZoom=b;break}c.ConfigManager.setConfig("VideoAnalyseModule",d).done(function(){remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)})})}).fail(function(){remarkDisplay("ivs_global_remark",tl("ptz.getStatusError"),3e3,1)});break;case"setPreset":c.PTZ.setPreset(b,d).done(function(){remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("ivs_global_remark",tl("Operateingfailure"),3e3,1)})}})}});b.exports={init:function(a,b){new d(a,b)},destory:function(){}}});