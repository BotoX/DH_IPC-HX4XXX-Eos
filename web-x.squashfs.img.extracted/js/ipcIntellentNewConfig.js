define(function(require){var a,b=null,c={},d={},e=require("jsCore/modules/eventHandler"),f=require("jsCore/modules/IntellMutex"),g=require("jsCore/rpc"),h=require("jsCore/modules/timeSection"),i=require("jsCore/rpcLogin"),j=require("jsCore/plugin"),k=require("jsCore/ability"),l={LeftDetection:[6,3600],WanderDetection:[1,600],MoveDetection:[6,300],RioterDetection:[10,300],ParkingDetection:[6,300]},m=[];!function(){var e=Page.ipcIntellentNewConfig={Tab:[],current:null,init:function(){k.get("IVSCaps").done(function(a){if(a){a.SupportedRules.contains("CrossLineDetection")&&($("ipcIntellentNew_CrossLineDetection_tab").setStyle("display",""),c.CrossLineDetection=[]),a.SupportedRules.contains("CrossRegionDetection")&&($("ipcIntellentNew_CrossRegionDetection_tab").setStyle("display",""),c.CrossRegionDetection=[]),a.SupportedRules.contains("LeftDetection")&&($("ipcIntellentNew_LeftDetection_tab").setStyle("display",""),c.LeftDetection=[]),a.SupportedRules.contains("VideoAbnormalDetection")&&($("ipcIntellentNew_VideoAbnormalDetection_tab").setStyle("display",""),c.VideoAbnormalDetection=[]),a.SupportedRules.contains("WanderDetection")&&($("ipcIntellentNew_WanderDetection_tab").setStyle("display",""),c.WanderDetection=[]),a.SupportedRules.contains("RioterDetection")&&($("ipcIntellentNew_RioterDetection_tab").setStyle("display",""),c.RioterDetection=[]),a.SupportedRules.contains("MoveDetection")&&($$("#ipcIntellentNew_MoveDetection_tab").setStyle("display",""),$("ipcIntellentNew_Global_tab").setStyle("display",""),c.MoveDetection=[]),webApp.GongAnDetect&&($$("#ipcIntellentNew_RegionIn_tab").setStyle("display",""),$$("#ipcIntellentNew_RegionOut_tab").setStyle("display",""));var b=a.SupportedScenes.Normal.SupportedRules;$each(b,function(a,b){a.TriggerTrack&&m.push(b)})}Object.keys(c).length>6&&$$(".ipcIntellentNew_tab_title").setStyle("min-width","80px"),e.Tab["public"].init(),e.Tab.Global.init(),e.translate(),e.bind(),e.render()})},translate:function(){$("page_ipcIntellentNewConfig").translation()},render:function(){g.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){a=b,$$(".ipcIntellentNew_tab_title.ui-tab-current").fireEvent("click")});var b="VideoAnalyseRule["+analyseSenceRuleMap.Normal+"]";g.ConfigManager.getDefault(b).done(function(a){e.parseDefaultConfig(a)}).fail(function(){throw new Error("Could not get the default config: "+b)}),!isEnable("is_show_help")&&$("ipcIntellentNew_help").setStyle("display","none")},bind:function(){$("ipcIntellentNew_help").addEvent("click",e._openHelp),$$(".ipcIntellentNew_tab_title").addEvent("click",e._onTabTitleClick)},_onTabTitleClick:function(){var a=this,c=this.getProperty("data-for");b=c,e.current!==e.Tab[c]&&e.current&&e.current.leave&&e.current.leave(),setTimeout(function(){$$(".ipcIntellentNew_tab_title").removeClass("ui-tab-current"),$$(".ipcIntellentNew_tab_con").setStyle("display","none"),a.addClass("ui-tab-current");var b=["CrossLineDetection","CrossRegionDetection","LeftDetection","VideoAbnormalDetection","WanderDetection","RioterDetection","MoveDetection"];if(b.contains(c))var d="public";else var d=c;$("ipcIntellentNew_tab_"+d).setStyle("display","block"),e._hideElement(),e.current=e.Tab[c],e.Tab[c].render()},20)},_hideElement:function(){$("ipcIntellentNew_remark1").setStyle("minWidth","310px"),$("ipcIntellentNew_remark1").setStyle("height","100%"),$("ipcIntellentNew_remark1").setStyle("visibility","hidden"),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-width310"),$$(".ipcIntellentNew_VideoAbnormalDetectionClass").addClass("fn-width90"),$$(".ipcIntellentNew_VideoAbnormalDetectionButton").removeClass("fn-marl140"),$$(".ipcIntellentNew_VideoAbnormalDetection").setStyle("display",""),$("ipcIntellentNew_VideoAbnormalDetection").addClass("fn-left"),$("ipcIntellentNew_minDuration_wrap").setStyle("display","none"),$("ipcIntellentNew_ruleDirectionWrap").setStyle("display","none"),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display","none"),$("ipcIntellentNew_actionWrap").setStyle("display","none"),$("ipcIntellentNew_fieldset").removeClass("intell-abnormal-fieldset")},_openHelp:function(){openHelp("ipcIntellentNewConfig.htm")},parseDefaultConfig:function(a){a.each(function(a){var b=a.Type;d[b]||(d[b]=a)})},leave:function(){j.close(),e.current&&e.current.leave&&e.current.leave(),e.current=null}}}(),function(){var a=null,b=null,c=null,d=null,e=null,f=null,h=[],l=1,m=0,n=Page.ipcIntellentNewConfig.Tab.Global={init:function(){n.translate(),n.bind()},translate:function(){},bind:function(){$("ivs_AddScaleArea").addEvents({click:function(){"hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")?(j.SetCalibrateAndRules("CalibrateArea",0,!0),$("ivs_ScaleAreaShow").setStyle("visibility","visible")):remarkDisplay("ivs_global_remark",tl("w_areaError"),3e3,1)}}),$("ivs_DeleteScaleArea").addEvent("click",function(){$("ivs_ScaleAreaCheck").hasClass("scale_current")&&($("ivs_ScaleAreaShow").setStyle("visibility","hidden"),$("ivs_ScaleAreaCheck").removeClass("scale_current"),j.SetCalibrateAndRules("CalibrateArea",0,!1),c=null,a[0].CalibrateArea[0]=c,b=$unlink(a),$("ivs_ScaleListShow").empty(),h.empty(),n.disableStaffOperation())});var d=$("ivs_scaleContent");$("ivs_AddScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){if("hidden"==$("ivs_ScaleAreaShow").getStyle("visibility")||!c)return void remarkDisplay("ivs_global_remark",tl("w_areadraw"),3e3,1);if(h.contains("Horizontal")&&!$("scaleVertical").checked)return void remarkDisplay("ivs_global_remark",tl("w_horizontalError"),3e3,1);if(3==h.length&&0==$unlink(h).erase("Vertical").length&&$("scaleVertical").checked||4==h.length)return void remarkDisplay("ivs_global_remark",tl("w_verticalError"),3e3,1);if(!c.Staffs&&h.length||c.Staffs&&h.length!=c.Staffs.length)return void remarkDisplay("ivs_global_remark",tl("Please draw shape"),3e3,1);var a=$("scaleVertical").checked?"Vertical":"Horizontal",b=0;h.each(function(c){c==a&&b++}),h.push(a),j.SetCalibrateAndRules(a,0,!0),$("ivs_ScaleListShow").getElements("i.scale_bottom_icon").set("class","scale_main_icon"),d.getElements("a").removeClass("scale_current");var e=new Element("span",{name:a});e.innerHTML='<div class="fn-clear scale-region"><i class="scale_bottom_icon"></i><a href="javascript:;" class="scale_current" data-staffIndex="'+(h.length-1)+'" scale-index="'+b+'" data-type="'+a+'">'+tl("w_"+a)+"</a></div>",e.inject($("ivs_ScaleListShow"))}}),$("ivs_DeleteScale").addEvent("click",function(){if(!this.hasClass("ui-button-disabled")){var a=d.getElement("#ivs_ScaleListShow a.scale_current");if(!a)return void remarkDisplay("ivs_global_remark",tl("pleaseSelectStaff"),3e3,1);var b=a.getProperty("data-type"),e=parseInt(a.getProperty("scale-index"),10),f=parseInt(a.getProperty("data-staffIndex"),10);a.getParent("span").destroy(),h.splice(f,1),c.Staffs.splice(f,1),j.SetCalibrateAndRules(b,e,!1);var g=$$("#ivs_ScaleListShow a"),i=$$("#ivs_ScaleListShow span").getProperty("name"),k=0;h.each(function(a,b){var c=0;"Vertical"==i[b]&&(c=k++),g[b].setProperties({"scale-index":c,"data-staffIndex":b})}),$("ivs_ScaleListShow").getLast()&&$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")}}),$("scaleLength").addEvent("change",function(){var a=$("ivs_ScaleListShow").getElement("a.scale_current"),b=this.value-0,d=this;if(isNaN(b)?(this.value=l,b=l):0>=b?(b=1,this.value=b):b>10&&(b=10,this.value=b),b+""!=this.value){var e=this.getProperty("maxlength");this.value=e?(b+"").substr(0,e-0):b}if(a){var f=(a.getProperty("data-staffindex")-0,a.getProperty("data-type"));c.Staffs.each(function(a){a.Type==f&&(a.Length=d.value-0)})}}).addEvent("keyup",function(){var a=this.value;/[^\d\.]/g.test(a)&&(this.value=a.replace(/[^\d\.]/g,""))}),d.addEvent("click:relay([data-toggle])",function(){var a,b,c,c=this.getProperty("data-toggle"),d=this.getParent().getNext("span");"fold"==c?(a="visible",b="scale_icon_hide",c="unfold"):(a="hidden",b="scale_icon_show",c="fold"),d.setStyle("visibility",a),$("ivs_ScaleIcon").setProperty("class",b),this.setProperty("data-toggle",c)}),d.addEvent("click:relay(a)",function(){var a=this.getProperty("data-type"),b=null,c=this.getProperty("scale-index")||0;c=parseInt(c),d.getElements("a").removeClass("scale_current"),this.addClass("scale_current"),("Horizontal"==a||"Vertical"==a)&&(b=n.getStaff(a,c),$("ivs_global_staffType").getElement("input[value="+a+"]").checked=!0,$("scaleLength").setProperty("disabled",!1).value=b.Length),j.SelectRule(a,c)}),$("ivs_scaleCheck").addEvent("click",function(){return c&&c.Area&&c.Staffs&&4==c.Staffs.length?($$("#ivs_ScaleListShow a").removeClass("scale_current"),scaleCheckNum=$("ivs_scaleValue").value-0,void j.SetCalibrateAndRules("CheckedLength",scaleCheckNum,!0)):void remarkDisplay("ivs_global_remark",tl("w_scaleAll"),3e3,1)}),$("ivs_global_default").addEvent("click",n._onDefaultClick),$("ivs_global_refresh").addEvent("click",n._onRefreshClick),$("ivs_global_confirm").addEvent("click",n._onConfirmClick)},leave:function(){j.addEvent("OutPutStringInfo",null),j.SetIVSConfig("",0),j.hide()},render:function(){j.cover("#ivs_global_video",function(a){j.SetRegionNum(0),j.SetModuleMode(2),i.chkAuthority("Monitor_01")&&j.open(),a&&$("ivs_global_refresh").fireEvent("click")}),j.addEvent("OutPutStringInfo",function(a,b){"OutPutGlobalCalibrateInfo"===a?n.outPutGlobalCalibrateInfo(b):"OutPutCheckedInfo"===a&&n.outPutCheckedInfo(b)}),g.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){a=c,b=$unlink(a),n._renderGlobalElements()}),k.get("IVSCaps").done(function(a){a&&j.SetMaxPntNum(a.MaxPointOfLine,a.MaxPointOfRegion)})},_renderGlobalElements:function(){var b=a[m].CalibrateArea||[];c=b[0]||null,n._renderScale(),$("scaleVertical").checked=!0,function(){n._buildAnalyseGlobal(b),j.SetIVSConfig(d,0),j.SubVideoWndCtrl(12,1)}.delay(50)},_buildAnalyseGlobal:function(a){var b={result:!0,params:{table:[a]}};d=JSON.encode(b)},_renderScale:function(){var b=a[m].CalibrateArea||[],c=b[0];if(h.empty(),$("ivs_ScaleListShow").empty(),!c||!c.Area)return $("ivs_ScaleAreaShow").setStyle("visibility","hidden"),void n.disableStaffOperation();$("ivs_ScaleAreaShow").setStyle("visibility","visible"),n.enableStaffOperation();var d="",g=0;c.Staffs&&c.Staffs.each(function(a,b){var c=0;c="Horizontal"==a.Type?0:g++,d+="<span name="+a.Type+'><div class="fn-clear scale-region"><i class="scale_main_icon"></i><a href="javascript:;" data-staffIndex="'+b+'" scale-index="'+c+'" data-type="'+a.Type+'">'+tl("w_"+a.Type)+"</a></div></span>",h.push(a.Type),"Vertical"==a.Type?($("scaleLength").value=a.Length,e=a.Length):f=a.Length}),$("ivs_ScaleListShow").innerHTML=d,$("ivs_ScaleListShow").getLast().getElements("i").set("class","scale_bottom_icon")},getStaff:function(a,b){var d=c.Staffs,e=d.filter(function(b){return b.Type==a});return e[b]},saveCurrentStaff:function(){var a=$("ivs_ScaleListShow").getElement("a.scale_current");if(a&&c.Staffs){var b=parseInt(a.getProperty("data-staffIndex")),d=parseFloat($("scaleLength").value);c.Staffs[b].Length=isNaN(d)?l:d}},outPutGlobalCalibrateInfo:function(b){c=JSON.decode(b);var d=c.Staffs,e=a[m].CalibrateArea||[];if(d){var f=e[0]||{},g=f.Staffs,h=$("scaleLength").value-0;if(g){if(g.each(function(a,b){d[b]&&(d[b].Length=a.Length)}),g.length<d.length){var i=d[d.length-1].Type;d.each(function(a){a.Type==i&&(a.Length=h)}),$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}}else d[0].Length=h,$("ivs_ScaleListShow").getElements("a").removeClass("scale_current")}else c.Area.length>0&&n.enableStaffOperation();e[0]=c,a[m].CalibrateArea=e},outPutCheckedInfo:function(a){var b=JSON.decode(a),c=b.CheckedLength[0],d=b.CheckedLength[1];if(0==scaleCheckNum)var e="Horizontal";else var e="Vertical";g.DevVideoAnalyse.testCalibrateWithScreenPoints(e,c,d).done(function(a){j.GetLength(a.toFixed(2))})},disableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!0),$("scaleLength").disabled=!0,$("scaleLength").value=1,$("ivs_AddScale").addClass("ui-button-disabled"),$("ivs_DeleteScale").addClass("ui-button-disabled")},enableStaffOperation:function(){$("ivs_global_staffType").getElements("input[name=scaleLine]").setProperty("disabled",!1),$("scaleLength").disabled=!1,$("ivs_AddScale").removeClass("ui-button-disabled"),$("ivs_DeleteScale").removeClass("ui-button-disabled")},_onDefaultClick:function(){g.ConfigManager.getDefault("VideoAnalyseGlobal").done(function(c){a=c,b=$unlink(a),n._renderGlobalElements(0),remarkDisplay("ivs_global_remark",tl("Defaultsuccess"),3e3,0)}).fail(function(){remarkDisplay("ivs_global_remark",tl("Defaultfailure"),3e3,1)})},_saveGlobalScale:function(){c&&n.saveCurrentStaff()},_onRefreshClick:function(){g.ConfigManager.getConfig("VideoAnalyseGlobal").done(function(c){a=c,b=$unlink(a),n._renderGlobalElements(0),remarkDisplay("ivs_global_remark",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("ivs_global_remark",tl("Operateingfailure"),3e3,1)})},_onConfirmClick:function(){var d=c&&c.Area&&c.Staffs&&4==c.Staffs.length;return!d&&c?void remarkDisplay("ivs_global_remark",tl("w_scaleAll"),3e3,1):"visible"==$("ivs_ScaleAreaShow").getStyle("visibility")&&$$("#ivs_ScaleListShow span").length<4?void remarkDisplay("ivs_global_remark",tl("w_areadraw"),3e3,1):(n._saveGlobalScale(),void g.ConfigManager.setConfig("VideoAnalyseGlobal",a).done(function(c){b=$unlink(a),remarkDisplay("ivs_global_remark",tl("Succeed in saving configure"),3e3,0),webApp.isNeedReboot(c)&&webApp.reboot("The configration take effect! The device is restarting now,please reconnect later...")}).fail(function(){remarkDisplay("ivs_global_remark",tl("IvsGlobalSave"),3e3,1)}))}}}(),function(){Page.ipcIntellentNewConfig.Tab.CrossLineDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap").setStyle("display",""),$("ipcIntellentNew_ruleDirection").empty(),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_LeftToRight"),"LeftToRight")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_RightToLeft"),"RightToLeft")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_toBoth"),"Both")),Page.ipcIntellentNewConfig.Tab["public"].render()},leave:function(){Page.ipcIntellentNewConfig.Tab["public"].leave()}}}(),function(){Page.ipcIntellentNewConfig.Tab.CrossRegionDetection={render:function(){$("ipcIntellentNew_ruleDirectionWrap").setStyle("display",""),$("ipcIntellentNew_ruleDirection").empty(),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_Enter"),"Enter")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_Leave"),"Leave")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_Both"),"Both")),Page.ipcIntellentNewConfig.Tab["public"].render(),$("ipcIntellentNew_RegionIn_tab").hasClass("ui-tab-current")?($("ipcIntellentNew_ruleDirection").empty(),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_Enter"),"Enter"))):$("ipcIntellentNew_RegionOut_tab").hasClass("ui-tab-current")&&($("ipcIntellentNew_ruleDirection").empty(),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_Leave"),"Leave"))),$("ipcIntellentNew_actionWrap").setStyle("display","")},leave:function(){Page.ipcIntellentNewConfig.Tab["public"].leave()}}}(),function(){Page.ipcIntellentNewConfig.Tab.LeftDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display",""),$("ipcIntellentNew_ruleDirection").empty(),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_Center"),"Center")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_LeftCenter"),"LeftCenter")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_TopCenter"),"TopCenter")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_RightCenter"),"RightCenter")),$("ipcIntellentNew_ruleDirection").options.add(new Option(tl("w_BottomCenter"),"BottomCenter")),Page.ipcIntellentNewConfig.Tab["public"].render()},leave:function(){Page.ipcIntellentNewConfig.Tab["public"].leave()}}}(),function(){Page.ipcIntellentNewConfig.Tab.VideoAbnormalDetection={render:function(){$("ipcIntellentNew_remark1").setStyle("minWidth","360px"),$$(".ipcIntellentNew_VideoAbnormalDetection").setStyle("display","none"),$("ipcIntellentNew_VideoAbnormalDetection").removeClass("fn-left"),$("ipcIntellentNew_VideoAbnormalDetection").removeClass("fn-width310"),$$(".ipcIntellentNew_VideoAbnormalDetectionClass").removeClass("fn-width90"),$$(".ipcIntellentNew_VideoAbnormalDetectionButton").addClass("fn-marl140"),$("ipcIntellentNew_fieldset").addClass("intell-abnormal-fieldset"),Page.ipcIntellentNewConfig.Tab["public"].render(),$("ipcIntellentNew_left").setStyle("display","none"),$("ipcIntellentNew_VideoAbnormalDetection").getChildren().setStyle("margin-left","0px")},leave:function(){Page.ipcIntellentNewConfig.Tab["public"].leave()}}}(),function(){Page.ipcIntellentNewConfig.Tab.WanderDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),Page.ipcIntellentNewConfig.Tab["public"].render()},leave:function(){Page.ipcIntellentNewConfig.Tab["public"].leave()}}}(),function(){Page.ipcIntellentNewConfig.Tab.RioterDetection={render:function(){$("ipcIntellentNew_minDuration_wrap").setStyle("display",""),$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display",""),Page.ipcIntellentNewConfig.Tab["public"].render(),$("ipcIntellentNew_target_label").set("text",tl("minGatherRegion")),$("ipcIntellentNew_object_filter_ck").setStyle("display","none")},leave:function(){Page.ipcIntellentNewConfig.Tab["public"].leave()}}}(),function(){Page.ipcIntellentNewConfig.Tab.MoveDetection={render:function(){$("ipcIntellentNew_RuleType_wrap").setStyle("display","none"),$("ipcIntellentNew_SensitivityWrap").setStyle("display",""),Page.ipcIntellentNewConfig.Tab["public"].render()},leave:function(){Page.ipcIntellentNewConfig.Tab["public"].leave()}}}(),function(){var n,o,p,q=null,r={MaxRect:[8191,8191],MinRect:[0,0]},s=!1,t=!1,u=0,v={},w=null,x=Page.ipcIntellentNewConfig.Tab["public"]={init:function(){w=$("ipcIntellentNew_ruleManager"),x.translate(),x.bind(),v=new FineSlider("ipcIntellentNew_Sensitivity_slider","ipcIntellentNew_Sensitivity_knob",{range:[1,10],snap:!0},"ipcIntellentNew_Sensitivity_tip","ipcIntellentNew_Sensitivity_add","ipcIntellentNew_Sensitivity_sub"),x.eventHandler=new e("#ipcIntellentNew_eventHandler"),x.intellMutex=new f("ipcIntellentNew_mutex"),k.get("IVSCaps").done(function(a){var b=f.getIntellMutexTip("Normal",a||{});b&&(x.intellMutex.add("intell",b),x.intellMutex.setCtrl("intell",!0)),x.intellMutex.add("tvout",'<span t="IntellMutexTVOut">'+tl("IntellMutexTVOut")+"</span>")})},translate:function(){},render:function(){m.contains(b)?$("ipcIntellentNew_TriggerTrack").setStyle("display","block"):$("ipcIntellentNew_TriggerTrack").setStyle("display","none"),x.intellMutex.hide(),$("ipcIntellentNew_left").setStyle("display","block"),$("ipcIntellentNew_VideoAbnormalDetection").getChildren().setStyle("margin-left","470px"),$("ipcIntellentNew_target_label").set("text",tl("w_aimFiltrate")),$("ipcIntellentNew_object_filter_ck").setStyle("display",""),x.intellMutex.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),x._disabledDraw(!1),"VideoAbnormalDetection"!=b&&(j.cover("#ipcintellentNewVideo",function(a){j.SetRegionNum(0),j.SetModuleMode(2),i.chkAuthority("Monitor_01")&&j.open(),a&&$("ipcIntellentNew_refresh1").fireEvent("click")}),j.addEvent("OutPutStringInfo",function(a,b){"OutPutShapeRect"===a?x.outPutShapeRect(b):"OutPutObjectRect"===a?x.setFilterValue(b):"OutPutRuleRect"===a&&x.outPutRuleRect(b)})),u=0,o=$unlink(a),x._renderElements(o),x.renderMinDuration()},renderMinDuration:function(){var a=l[b]||[1,600];attachLimit("ipcIntellentNew_minDuration",a[0],a[1]),$("ipcIntellentNew_minDurationTip").set("text","("+a[0]+"~"+a[1]+")")},bind:function(){$("ipcIntellentNew_default1").addEvent("click",x._onDefaultClick),$("ipcIntellentNew_refresh1").addEvent("click",x._onRefreshClick),$("ipcIntellentNew_confirm1").addEvent("click",x._onConfirmClick),$("ipcIntellentNew_setButton1").addEvent("click",x._onSetupClick),$("ipcIntellentNew_drawRule").addEvent("click",function(){x._drawRuleType(!1)}),$("ipcIntellentNew_clearRule").addEvent("click",function(){return s?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):("DetectLine"==q?n.Config[q]=[[0,0],[0,0]]:"DetectRegion"==q&&(n.Config[q]=[[0,0],[0,0],[0,0],[0,0]]),x._buildRuleJson(),j.DeleteShape(n.Name),x._drawRuleType(!0),void x._renderRule())}),$("ipcIntellentNew_NumberSelect").addEvent("change",x._changeRule),attachLimit("ipcIntellentNew_minDuration",1,600),$("ipcIntellentNew_ruleInputName").addEvent("blur",function(){return this.value?(j.SetCurShape(n.Name),n.Name=$("ipcIntellentNew_ruleInputName").value,j.SetCurName($("ipcIntellentNew_ruleInputName").value),void j.SetCurShape("save")):(this.value=n.Name,void remarkDisplay("ipcIntellentNew_remark1",tl("w_null_limite"),3e3,2))}),$("ipcIntellentNew_able1").addEvent("click",function(){n.Enable=this.checked,c[b].each(function(a){a.Enable=n.Enable}),this.checked?(x._disabledDraw(!1),x.intellMutex.show()):x.intellMutex.hide(),x._buildRuleJson(),j.SetIVSConfig(p,2),j.SetCurShape(n.Name),x._ruleInitEmpty(),n.Enable&&("RioterDetection"==b||(r.MaxRect=n.Config.SizeFilter&&n.Config.SizeFilter.MaxSize,r.MinRect=n.Config.SizeFilter&&n.Config.SizeFilter.MinSize,j.SetObjectConfig(JSON.encode(r)),j.SetCurPtzID(0))),j.SetCurShape("save");var a=n.Config.SizeFilter;a&&isZeroArray(a.MaxSize)&&($("ipcIntellentNew_min").disabled=!0)}),$("ipcIntellentNew_ruleDirection").addEvent("change",function(){n.Config.Direction=this.value,x._changeDiection()}),$("ipcIntellentNew_drawTarget").addEvent("click",function(){if($("ipcIntellentNew_able1").checked){if(s)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);if("RioterDetection"==b)return void(isEmptyRect(n.Config.MinDetectRect)?(j.AddShape(6,"","RuleRect",-1,0),x._disabledDraw(!0)):(j.DeleteShape("RuleRect"),j.SetObjectConfig(JSON.encode({RuleRect:n.Config.MinDetectRect})),j.SetCurShape("RuleRect")));var a=n.Config.SizeFilter;$("ipcIntellentNew_max").checked?isZeroArray(a.MaxSize)?j.AddShape(5,"","MaxRect",0,-1):j.SetCurShape("MaxRect"):isZeroArray(a.MinSize)?(j.AddShape(5,"","MinRect",0,-1),x._disabledDraw(!0)):j.SetCurShape("MinRect")}}),$("ipcIntellentNew_clearTarget").addEvent("click",function(){return s?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):"RioterDetection"==b?(n.Config.MinDetectRect=[[0,0],[0,0]],void(n.Enable&&j.DeleteShape("RuleRect"))):($("ipcIntellentNew_max").checked?n.Config.SizeFilter.MaxSize=[8191,8191]:n.Config.SizeFilter.MinSize=[0,0],void(n.Enable&&(j.DeleteShape("MaxRect"),j.DeleteShape("MinRect"),r.MaxRect=n.Config.SizeFilter.MaxSize,r.MinRect=n.Config.SizeFilter.MinSize,j.SetObjectConfig(JSON.encode(r)),$("ipcIntellentNew_max").checked?j.AddShape(5,"","MaxRect",0,-1):j.AddShape(5,"","MinRect",0,-1),x._disabledDraw(!0,!0))))}),$("ipcIntellentNew_max").addEvent("click",function(){return $("ipcIntellentNew_able1").checked?s?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):void j.SetCurShape("MaxRect"):void 0}),$("ipcIntellentNew_min").addEvent("click",function(){return $("ipcIntellentNew_able1").checked?s?void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1):void(isZeroArray(n.Config.SizeFilter.MinSize)?(j.AddShape(5,"","MinRect",0,-1),x._disabledDraw(!0)):j.SetCurShape("MinRect")):void 0}),$("ipcIntellentNew_RuleType").addEvent("change",function(){n.Type=this.value,c[b][u]=n}),$("ipcIntellentNew_action").addEvent("change",function(){var a=this.value,b=n.Config,c="none";b.Action=[a],"Appear"==a?b.Direction="":(c="",b.Direction=$("ipcIntellentNew_ruleDirection").value),$("ipcIntellentNew_ruleDirectionWrap").setStyle("display",c),x._changeDiection()}),w.addEvent("click:relay([data-add])",function(){if(!this.hasClass("disabled")){var a=d[b],e=c[b];if(!a)throw new Error("the rule of "+b+" has no default config");var f=Object.clone(a),g=[b];"LeftDetection"==b&&g.push("TakenAwayDetection"),f.Name=x.getUniqueName(f.Name,o,g,e),f.Enable=$("ipcIntellentNew_able1").checked,e.push(f),x._changeRule(e.length-1,!0),x._renderRuleList(e)}}),w.addEvent("click:relay([data-del])",function(){var a,d=this.getProperty("data-del")-0,e=c[b];j.DeleteShape(e[d].Name),e.splice(d,1),a=e.length,u>d&&u--,u=u.limit(0,a-1),x._renderRuleList(e),a>0&&x._changeRule(u,!0)}),w.addEvent("dblclick:relay([data-name])",function(){this.addClass("edit"),this.getElement("input").select()}),w.addEvent("blur:relay(input)",function(){var a,b,c=this.value;a=this.getParent().removeClass("edit").getProperty("data-name")-0,c&&(this.getSiblings("span").set("text",c),b=n.Name,n.Name=c,j.SetCurShape(b),j.SetCurName(c),j.SetCurShape("save"))}),w.addEvent("click:relay(tr[data-index])",function(){this.getSiblings().removeClass("current"),this.addClass("current");var a=this.getProperty("data-index")-0;x._changeRule(a)})},leave:function(){j.addEvent("OutPutStringInfo",null),j.SetIVSConfig("",2),j.hide()},getUniqueName:function(a,b,c,d){var e=0,f=[];for(/[^\d]\d{1}$/g.test(a)&&(a=a.substr(0,a.length-1)),b.each(function(a){a.each(function(a){c.contains(a.Type)||f.push(a.Name)})}),d.each(function(a){a&&f.push(a.Name)});f.contains(a+ ++e););return a+e},_ruleInitEmpty:function(a){if("VideoAbnormalDetection"==b)return!1;x._buildRuleJson();var c=JSON.decode(p).params.table[0][0],d=!1;if(c.Config.DetectLine)0==c.Config.DetectLine[0][0]&&0==c.Config.DetectLine[0][1]&&0==c.Config.DetectLine[1][0]&&0==c.Config.DetectLine[1][1]&&(a||j.DeleteShape(c.Name),d=!0);else if(c.Config.DetectRegion&&"array"==$type(c.Config.DetectRegion)){var e,f=c.Config.DetectRegion,g=!0;for(e=f.length;e--;)if(f[e][0]||f[e][1]){g=!1;break}g&&!a&&j.DeleteShape(c.Name),d=g}else d=!0;return d},_renderElements:function(a,d){var e=a[analyseSenceRuleMap.Normal];for(var f in c)c[f]=[];switch(o[analyseSenceRuleMap.Normal].each(function(a){"TakenAwayDetection"==a.Type?c.LeftDetection&&c.LeftDetection.push(a):c[a.Type]&&c[a.Type].push(a)}),x._disabledDraw(!1),b){case"CrossLineDetection":q="DetectLine";break;case"CrossRegionDetection":q="DetectRegion";break;case"WanderDetection":case"MoveDetection":case"RioterDetection":case"LeftDetection":case"TakenAwayDetection":q="DetectRegion";break;case"VideoAbnormalDetection":q="DetectLine"}if(d){var g=[];e.each(function(a,c){"LeftDetection"==b?("LeftDetection"==a.Type||"TakenAwayDetection"==a.Type)&&g.push(e[c]):a.Type==b&&g.push(e[c])}),c[b]=g}if((0>u||u>c[b].length-1)&&(u=0),n=c[b][u],x._renderRuleList(c[b]),!n)return void j.SetIVSConfig("",2);$("ipcIntellentNew_NumberSelect").innerHTML="";for(var h=c[b].length,i=0;h>i;i++)$("ipcIntellentNew_NumberSelect").options.add(new Option(i+1,i));$("ipcIntellentNew_NumberSelect").selectedIndex=0,$("ipcIntellentNew_RuleType").value=n.Type,x._renderRule();var k=n.Config.SizeFilter;k&&isZeroArray(k.MaxSize)&&($("ipcIntellentNew_min").disabled=!0),setTimeout(function(){n&&(x._buildRuleJson(),j.SetIVSConfig(p,2),j.SetCurShape(n.Name),x._ruleInitEmpty(),n.Enable&&("RioterDetection"==b||(r.MaxRect=k&&k.MaxSize,r.MinRect=k&&k.MinSize,j.SetObjectConfig(JSON.encode(r)),j.SetCurPtzID(0))),j.SetCurShape("save"))},500)},_renderRule:function(){var a=n;if(x._renderSizeFilter(a.Config.SizeFilter),x.eventHandler.set(a.EventHandler),$("ipcIntellentNew_able1").checked=a.Enable,$("ipcTriggerTrack_able").checked=!!a.TrackEnable,a.Name&&($("ipcIntellentNew_ruleInputName").value=a.Name),a.Config.MinDuration&&($("ipcIntellentNew_minDuration").value=a.Config.MinDuration),a.Config.Action){$("ipcIntellentNew_action").value=a.Config.Action[0];var b="none";a.Config.Action.contains("Cross")&&(b=""),$("ipcIntellentNew_ruleDirectionWrap").setStyle("display",b)}a.Config.Direction&&($("ipcIntellentNew_ruleDirection").value=a.Config.Direction),a.Config.Sensitivity&&v.set(a.Config.Sensitivity),"none"!=$("ipcIntellentNew_RuleType_wrap").style.display&&($("ipcIntellentNew_RuleType").value=n.Type)},_renderSizeFilter:function(a){if(a){var b=["MaxSize-0","MaxSize-1","MinSize-0","MinSize-1"];$("ipcIntellentNew_left").getElements("input[type=text]").each(function(c){var d=c.name;if(b.contains(d)){var e=d.split("-"),f=e[0],g=e[1]-0;c.value=a[f][g]}})}},_renderRuleList:function(a){a=a||[];var b=w.getElement("tbody"),c='<tr data-index="{index}">                                <td class="num" width="25">{No}</td>                                <td data-name="{index}">                                    <span>{name}</span>                                    <input value="{name}" maxlength="30"/></td>                                <td><span class="ui-button-icon-clear" data-del="{index}"></span></td>                            </tr>',d=[],e=a.length;b.empty(),a.each(function(a,b){a&&d.push(c.substitute({No:b+1,index:b,name:a.Name}))}),b.set("html",d.join("")),b.getElements("tr[data-index="+u+"]").addClass("current"),w.getElements("[data-add]").toggleClass("disabled",e>=4);var f=$("ipcIntellentNew_tab_public");f.getElements("[data-emptyReules]").toggleClass("fn-hide",!e),f.getElements("[data-emptyDraw]").toggleClass("fn-invisib",!e);var g=$("ipcIntellentNew_able1");e||(g.checked=!1),g.disabled=!e},_buildRuleJson:function(){var a=Object.clone(n);delete a.EventHandler;var b={result:!0,params:{table:[[a]]}};"VideoAbnormalDetection"==a.Type&&(b.params.table[0][0]=null),p=JSON.encode(b)},_drawRuleType:function(a){if($("ipcIntellentNew_able1").checked){if(s)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);var c=$("ipcIntellentNew_ruleInputName").value,d=b,e=$("ipcIntellentNew_ruleDirection").selectedIndex,f=0,g=x._ruleInitEmpty(!0);if(!g)return void(a||j.SelectRule(c,0));switch(j.DeleteShape(c),x._disabledDraw(!0),d){case"CrossRegionDetection":n.Config.Action.contains("Appear")&&(e=-1),j.AddShape(2,d,c,e,f);break;case"CrossLineDetection":j.AddShape(2,d,c,e,f);break;case"CrossFenceDetection":var e=$("slct_direction0").selectedIndex;j.AddShape(2,d,c,e,f);break;default:j.AddShape(2,d,c,-1,f)}}},_changeRule:function(a,d){d!==!0&&(n=x._saveElements(),c[b][u]=n),c[b][a]&&(u=a,x._disabledDraw(!1),n=c[b][u],x._buildRuleJson(),j.SetIVSConfig(p,2),j.SetCurShape(n.Name),x._ruleInitEmpty(),n.Enable&&("RioterDetection"==b||(r.MaxRect=n.Config.SizeFilter&&n.Config.SizeFilter.MaxSize,r.MinRect=n.Config.SizeFilter&&n.Config.SizeFilter.MinSize,j.SetObjectConfig(JSON.encode(r)),j.SetCurPtzID(0))),j.SetCurShape("save"),x._renderRule())},_changeDiection:function(){var a=x._ruleInitEmpty();a||(x._buildRuleJson(),j.SetIVSConfig(p,2),j.SetCurShape(n.Name),n.Enable&&("RioterDetection"==b||(r.MaxRect=n.Config.SizeFilter&&n.Config.SizeFilter.MaxSize,r.MinRect=n.Config.SizeFilter&&n.Config.SizeFilter.MinSize,j.SetObjectConfig(JSON.encode(r)),j.SetCurPtzID(0))),j.SetCurShape("save"))},_disabledDraw:function(a,b){s=a,t=b,$("ipcIntellentNew_max").disabled=a,$("ipcIntellentNew_min").disabled=a,$("ipcIntellentNew_NumberSelect").disabled=a,$("ipcIntellentNew_ruleDirection").disabled=a,$("ipcIntellentNew_ruleInputName").disabled=a,$("ipcIntellentNew_action").disabled=a},_onDefaultClick:function(){g.ConfigManager.getDefault("VideoAnalyseRule").done(function(a){x._renderElements(a,!0),remarkDisplay("ipcIntellentNew_remark1",tl("Defaultsuccess"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Defaultfailure"),3e3,1)})},_onRefreshClick:function(){g.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){a=b,o=$unlink(a),x._renderElements(o),remarkDisplay("ipcIntellentNew_remark1",tl("Operateingsuccess"),3e3,0)}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Operateingfailure"),3e3,1)})},_onConfirmClick:function(){if(t)return void remarkDisplay("ipcIntellentNew_remark1",tl("Please draw shape"),3e3,1);
s&&(s=!1,x._disabledDraw(!1),j.DeleteShape(n.Name)),j.SetCurShape("save"),n=x._saveElements(),n&&u>=0&&(c[b][u]=n),o[analyseSenceRuleMap.Normal]=o[analyseSenceRuleMap.Normal].filter(function(a){return!Object.some(c,function(b,c){return b.length?b.some(function(b){return"LeftDetection"===c?["LeftDetection","TakenAwayDetection"].contains(a.Type):b.Type===a.Type}):"LeftDetection"===c?["LeftDetection","TakenAwayDetection"].contains(a.Type):c===a.Type})});for(var d in c)o[analyseSenceRuleMap.Normal].combine(c[d]);var e=x._ruleRenameTest();e||(a=$unlink(o),g.ConfigManager.setConfig("VideoAnalyseRule",a).done(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Succeed in saving configure"),3e3,0),g.ConfigManager.getConfig("VideoAnalyseRule").done(function(b){a=b,o=$unlink(a)})}).fail(function(){remarkDisplay("ipcIntellentNew_remark1",tl("Saving failure"),3e3,1)}))},_saveElements:function(){var a=n;if(a)return a.Enable=$("ipcIntellentNew_able1").checked,void 0!==a.TrackEnable&&(a.TrackEnable=$("ipcTriggerTrack_able").checked),a.Config.MinDuration&&"MoveDetection"!=b&&(a.Config.MinDuration=$("ipcIntellentNew_minDuration").value-0),a.Config.Direction&&(a.Config.Direction=$("ipcIntellentNew_ruleDirection").value),a.Config.Sensitivity&&(a.Config.Sensitivity=v.slider.step),n.EventHandler=x.eventHandler.get(),n},_ruleRenameTest:function(){var a=[],b=0,c=0,d=null,e=null,f=!1;return o.each(function(d){d.each(function(d){var e=d.Name;if(!f){var g=a.some(function(a){return a.Name==e?(c=a.Type,b=d.Type,f=!0,!0):!1});g||a.include({Name:e,Type:d.Type})}})}),f&&(d=x._stringShow(c),e=x._stringShow(b),remarkDisplay("ipcIntellentNew_remark1",tl(d)+" "+tl("w_and")+" "+tl(e)+" "+tl("w_groupNameSame"),3e3,1)),f},_stringShow:function(a){return"CrossLineDetection"==a?a="w_CrossLineDetection":"CrossRegionDetection"==a?a="w_CrossRegionDetection":("LeftDetection"==a||"TakenAwayDetection"==a)&&(a="w_LeftDetectionDis"),a},_onSetupClick:function(){n&&n.EventHandler&&n.EventHandler.TimeSection&&("VideoAbnormalDetection"!==b&&j.hide(),h.open(n.EventHandler.TimeSection).done(function(a){n.EventHandler.TimeSection=a}).always(function(){"VideoAbnormalDetection"!==b&&j.cover("#ipcintellentNewVideo")}))},outPutShapeRect:function(a){x._disabledDraw(!1);var b=n.Type,c=JSON.decode(a);switch(b){case"CrossLineDetection":c.Config.DetectLine&&(n.Config.DetectLine=c.Config.DetectLine);break;case"CrossFenceDetection":c.Config.UpstairsLine&&(n.Config.UpstairsLine=c.Config.UpstairsLine),c.Config.DownstairsLine&&(n.Config.DownstairsLine=c.Config.DownstairsLine);break;case"CrossRegionDetection":case"LeftDetection":case"TakenAwayDetection":if(c.Config.DetectRegion.length<3){x._disabledDraw(!0);break}c.Config.DetectRegion&&(n.Config.DetectRegion=c.Config.DetectRegion);break;default:c.Config.DetectRegion&&(n.Config.DetectRegion=c.Config.DetectRegion)}},outPutRuleRect:function(a){x._disabledDraw(!1);var b=JSON.decode(a);b.OutPutRuleRect&&(n.Config.MinDetectRect=b.OutPutRuleRect)},setFilterValue:function(a){var b=!1,c=JSON.decode(a),d=n.Config.SizeFilter,e=[1,1];c.MinRect?d.MinSize=c.MinRect:c.MaxRect&&(d.MaxSize=c.MaxRect,e=c.MaxRect),b=isZeroArray(e),x._renderSizeFilter(d),x._disabledDraw(b,b)}}}()});