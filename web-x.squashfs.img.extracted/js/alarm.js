!function(a){define(function(require,b,c){function d(b){for(var c=b.eventList,d=!0,e=0;e<c.length;++e)"Stop"!==c[e].Action&&(a("#alarm_table").table("add",c[e],-1),d&&(!n&&a("#alarm_tip").prop("checked")&&a("#d_alarmtip").show(),window.playAlarmSound(a("#sound_path").val()),d=!1))}function e(a){var b=m[a];h.EventManager.attach(b.events).done(function(a){b.sid=a})}function f(a){var b=m[a];h.EventManager.detach(b.sid,b.events)}function g(){webApp.NotifyVersion?j.devNotify.reconnect():p.$("#alarm_frame").attr("src","/cgi-bin/eventManager.cgi?action=notifyEventStream&sessionId="+h.getSession()),o.each(function(b,c){var d=a(c),f=d.data("event");d.prop("checked")&&e(f)})}var h=require("jsCore/rpc"),i=require("jsCore/ability"),j=require("common/common"),k=require("jsCore/plugin"),l=require("jsCore/pageBase"),m=null,n=!1,o=null,p=null,q=null;c.exports=l.extend({init:function(){p=this,m={videoMotion:{events:["VideoMotion"],sid:-1},storageLowSpace:{events:["StorageLowSpace"],sid:-1},storageFailure:{events:["StorageFailure"],sid:-1},videoBlind:{events:["VideoBlind"],sid:-1},externalAlarm:{events:["AlarmLocal"],sid:-1},illegalAccess:{events:["LoginFailure"],sid:-1},audioDetect:{events:[],sid:-1},ivs:{events:["CrossLineDetection","CrossRegionDetection","LeftDetection","VideoAbnormalDetection","SceneChange","TakenAwayDetection","FaceDetection","RioterDetection","MoveDetection","WanderDetection","CrossFenceDetection","ParkingDetection","NumberStat","RetrogradeDetection","TrafficJunction"],sid:-1},VideoAbnormalDetection:{events:["VideoAbnormalDetection","SceneChange"],sid:-1},HeatImagingTemper:{events:["HeatImagingTemper"],sid:-1},BetweenRulesTemperDiffAlarm:{events:["BetweenRulesTemperDiffAlarm"],sid:-1},HotSpotWarning:{events:["HotSpotWarning"],sid:-1},ColdSpotWarning:{events:["ColdSpotWarning"],sid:-1},FireWarning:{events:["FireWarning","SmokeDetection"],sid:-1},PowerFault:{events:[],sid:-1}},webApp.NotifyVersion?(p.$("#alarm_table_frame").remove(),p.$("#alarm_table").table({pageable:!1,height:454,columns:[{title:tl("w_Numbers"),width:"10%",render:function(a){return a._index+1}},{title:tl("w_Time"),width:"30%",render:function(a){var b="";if(a.Data&&a.Data.Time)b=a.Data.Time;else if(a.Data&&a.Data.LocaleTime)b=a.Data.LocaleTime;else if(a.Data&&a.Data.UTC){var c=new Date;c.setTime(1e3*a.Data.UTC),b+=c.getFullYear()+"-",b+=jQuery.pad(c.getMonth()+1,2)+"-",b+=jQuery.pad(c.getDate(),2)+" ",b+=jQuery.pad(c.getHours(),2)+":",b+=jQuery.pad(c.getMinutes(),2)+":",b+=jQuery.pad(c.getSeconds(),2)}return b}},{title:tl("w_Alarm Type"),width:"30%",render:function(a){var b=tl(a.Code);return a.Data&&a.Data.Type&&(b+="("+tl(a.Data.Type)+")"),b}},{title:tl(webApp.DeviceType.contains("TPC")?"alarmInformartion":"w_Alarm Channel"),width:"30%",render:function(a){var b;return webApp.DeviceType.contains("TPC")?a.Data.Channel?(b=webApp.DeviceType.contains("SD")?a.Data.PresetID+"-":"",b+=a.Data.Channel+1,b+=a.Data.AlarmId?"-"+a.Data.AlarmId:""):b=a.Data.AlarmId?a.Data.AlarmId:a.Index+1:b=a.Index+1,b}}]})):(p.$("#alarm_table").remove(),p.$("#player").remove()),webApp.IsLocalStore||(p.$("input[data-event=storageLowSpace]").closest("label").remove(),p.$("input[data-event=storageFailure]").closest("label").remove()),webApp.ALARM_IN_NUMBER||p.$("input[data-event=externalAlarm]").closest("label").remove(),-1!==webApp.DeviceType.indexOf("TPC")&&(p.$("[btn-for=onAlarmClean]").show(),-1!==webApp.DeviceType.indexOf("-T")&&login.chkAuthority("TemperatureConfig")&&(p.$("input[data-event=HeatImagingTemper]").closest("label").show(),p.$("input[data-event=BetweenRulesTemperDiffAlarm]").closest("label").show(),p.$("input[data-event=HotSpotWarning]").closest("label").show(),p.$("input[data-event=ColdSpotWarning]").closest("label").show()),i.get("FireWarning").done(function(a){a.Support&&p.$("input[data-event=FireWarning]").closest("label").show()}));var b=i.get("VideoDetectCaps").done(function(a){a&&a.UnFocusDetect&&!webApp.DeviceType.contains("TPC")?(m.videoBlind.events.push("VideoUnFocus"),p.$("input[data-event=videoBlind]").next("span").text(tl("w_videoOn"))):(p.$("input[data-event=videoBlind]").next("span").text(tl("w_Video Shelter")),webApp.DeviceType.contains("TPC")&&webApp.CHANNEL_NUMBER<2&&p.$("[data-event=videoBlind]").parent().hide())}),c=i.get("WirelessAlarm").done(function(a){a&&a.Support&&m.externalAlarm.events.push("AlarmExtended")}),k=!1,l=i.get("AudioFileManager").done(function(a){a&&a.Support&&(k=!0,m.audioDetect.events.push("AudioDetect"))}),n=i.get("AudioDetectCaps").done(function(a){a&&a.AnomalyDetect&&(k=!0,m.audioDetect.events.push("AudioAnomaly")),a&&a.MutationDetect&&(k=!0,m.audioDetect.events.push("AudioMutation"))}),q=i.get("VideoDetectCaps").done(function(a){a&&a.SupportMovedDetect?m.ivs&&m.ivs.events.splice(3,1):p.$("input[data-event=VideoAbnormalDetection]").closest("label").remove()}),r=i.is("DSPConflict").done(function(a){(webApp.IsIPCIntel||webApp.IsSDIntel||-1!==webApp.DeviceType.indexOf("TPC")&&webCaps.is_new_IVSUI)&&!a||(p.$("input[data-event=ivs]").closest("label").remove(),delete m.ivs)}),s=a.Deferred();h.ConfigManager.getConfig("CalibratePoints").done(function(a){webApp.DeviceType.contains("-T")&&a.Enable&&m.HeatImagingTemper.events.push("FaceOverHeating"),s.resolve()}).fail(function(){s.resolve()});var t=!1,u=h.FaceBoard.getCaps().done(function(a){a&&a.PowerVoltageDetect&&(t=!0,m.PowerFault.events.push("PowerFault"),p.$("input[data-event=PowerFault]").closest("label").show())});a.when(b,c,l,n,q,r,s,u).done(function(){k||p.$("input[data-event=audioDetect]").closest("label").remove(),p.render()}),o=p.$("input[data-event]").click(function(){var b=a(this),c=b.data("event"),d=b.prop("checked");d?e(c):f(c)}),p.$("#sound_path").click(function(a){p.onSelectFile(a)}),p.disabled("#sound_path",!0),p.disabled("[btn-for=onSelectFile]",!0),p.$("#alarm_sound").click(function(){var b=a(this).prop("checked");if(p.disabled("#sound_path",!b),p.disabled("[btn-for=onSelectFile]",!b),!b&&(p.$("#sound_path").val(""),!webApp.NotifyVersion)){var c="c://notexistfile"+(new Date).getTime()+".mp3";h.send("getvideopath",{videopath:c})}}),webApp.NotifyVersion?j.devNotify.subscribe("client.notifyEventStream",d):p.$("#alarm_frame").attr("src","/cgi-bin/eventManager.cgi?action=notifyEventStream&sessionId="+h.getSession()),app.addEvent("RECONNECTION",g)},render:function(){a("#d_alarmtip").hide(),n=!0,clearInterval(q),webApp.hideIVS===!0?p.$("[data-event=ivs]").parent("label").hide():webApp.hideIVS===!1&&p.$("[data-event=ivs]").parent("label").show()},leave:function(){n=!1,webApp.NotifyVersion||p.$("#alarm_tip").prop("checked")&&p.$("[data-event]:checked").length&&(q=setInterval(function(){h.send("getEventnum").done(function(b){b.params.number>0&&a("#d_alarmtip").show()})},1e3))},destory:function(){a("#d_alarmtip").hide(),webApp.NotifyVersion?j.devNotify.detach("client.notifyEventStream"):p.$("#alarm_frame").attr("src",""),app.removeEvent("RECONNECTION",g),m=null,n=!1,clearInterval(q)},onSelectFile:function(){var b=[{},{description:"All Files",extensions:["*"]}];return a.browser.ie?(b[0].description="Music Files (*.mp3;*.wav;*.mav;*.avi;*.wma;*.wmv)",b[0].extensions=["mp3","wav","mav","avi","wma","wmv"]):a.browser.Platform.mac?(b[0].description="Music Files (*.mp3;*.wav)",b[0].extensions=["mp3","wav"]):(b[0].description="Music Files (*.wav)",b[0].extensions=["wav"]),k.ShowSaveOrOpenDlg("openFile","",b).done(function(a){p.$("#sound_path").val(a[1].replace(/\\/g,"/")),webApp.NotifyVersion||h.send("getvideopath",{videopath:a[1].replace(/\\/g,"/")}),"nacl"===k.type&&k.ConnectAudioPath()}),!1},onAlarmClean:function(){a.confirm(tl("delAllAlarm"),tl("delAllAlarmComfirm"),function(){p.$("#alarm_table").table("dataSource",[])})}}),window.playAlarmSound=function(b){if(b)if(a.browser.ie){var c=a("#player")[0];c.url=b,c.controls.play(),setTimeout(function(){c.controls.stop()},7e3)}else clearTimeout(window.playAlarmSound.timer),window.playAlarmSound.timer=null,k.OpenAudioFile(b),window.playAlarmSound.timer=setTimeout(function(){k.OpenAudioFile("NULL")},7e3)},window.alarmCGIKeepAlive=a.noop})}(jQuery);