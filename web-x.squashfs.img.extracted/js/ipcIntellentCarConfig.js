!function(a){define(function(require,b,c){c.exports=require("jsCore/pageTab"),ability.get("IVSCaps").done(function(b){c.exports.prototype.car_parking=a.inArray("ParkingDetection",b.SupportedRules)>-1,c.exports.prototype.car_retr=a.inArray("RetrogradeDetection",b.SupportedRules)>-1})}),define("car_parking",function(require,b,c){{var d=require("jsCore/modules/eventHandler"),e=require("jsCore/modules/IntellMutex"),f=require("jsCore/ability"),g=require("jsCore/modules/timeSection"),h=require("jsCore/rpcLogin"),i=require("jsCore/plugin"),j=new e("car_parking_mutex"),k=require("jsCore/rpc"),l=require("jsCore/pageBase"),m=null,n=null,o=null,p=null,q={},r={},s={},t={},u={MaxRect:[8191,8191],MinRect:[0,0]},v=require("common/common");v.Check}c.exports=l.extend({init:function(){m=this,s.ParkingDetection=[],f.get("IVSCaps").done(function(a){var b=e.getIntellMutexTip("ParkingDetection",a||{});b&&(j.add("intell",b),j.setCtrl("intell",!0)),j.add("tvout",'<span t="IntellMutexTVOut">'+tl("IntellMutexTVOut")+"</span>")}),m.eventHandler=new d("#car_parking_eventHandler"),o=m.$("#car_parking_max"),p=m.$("#car_parking_ruleManager"),k.ConfigManager.getDefault("VideoAnalyseRule["+analyseSenceRuleMap.Normal+"]").done(function(b){a.each(b,function(a,b){t[b.Type]||(t[b.Type]=b)})}).fail(function(){throw new Error("Could not get the default config: "+defaultConfig+", error: "+text)}),n=m.$("#car_parking_minDuration").numberfield({min:6,max:300,allowNegative:!1,allowDecimal:!1}),m.$("#car_parking_ruleInputName").blur(function(a){var b=m.$(a.target).val();return b?(i.SetCurShape(r.Name),r.Name=b,i.SetCurName(b),void i.SetCurShape("save")):(this.value=r.Name,m.$("#parkingTip").tip("warning",tl("w_null_limite")))}),m.$("input[type=radio]").click(function(){if(!m.$("[chk-for=onEnable]").is(":checked")){if(ipcIvsRuleDrawFinish)return m.$("#parkingTip").tip("warning",tl("Please draw shape"));if(o.is(":checked"))i.SetCurShape("MaxRect");else if(r&&r.Config){var a=r.Config.SizeFilter.MinSize;(a[0]||a[1])&&i.SetCurShape("MinRect")}}}),p.find("[data-add]").click(function(a){if(!m.$(a.target).hasClass("disabled")){var b=t.ParkingDetection,c=s.ParkingDetection;if(!b)throw new Error("the rule of ParkingDetection has no default config");var d=Object.clone(b),e=["ParkingDetection"];d.Name=m._getUniqueName(d.Name,s,e,c),d.Enable=m.$("[chk-for=onEnable]").is(":checked"),c.push(d),m._changeRule(c.length-1,!0),m._renderRuleList(c),m.eventHandler.set(b.EventHandler)}}),m.render()},onEnable:function(b){r.Enable=m.$(b.target).is(":checked"),a.each(s.ParkingDetection,function(a,b){b.Enable=r.Enable}),m._disabledDraw(!m.$(b.target).is(":checked")),m.$(b.target).is(":checked")?j.show():j.hide(),m._buildRuleJson(),i.SetIVSConfig(videoAnalyseRuleJsonOcx,2),i.SetCurShape(r.Name),m._ruleInitEmpty(),r.Enable&&(u.MaxRect=r.Config.SizeFilter&&r.Config.SizeFilter.MaxSize,u.MinRect=r.Config.SizeFilter&&r.Config.SizeFilter.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0)),i.SetCurShape("save");var c=r.Config.SizeFilter;c&&isZeroArray(c.MaxSize)&&m.disabled("#car_parking_min")},drawTarget:function(){if(m.$("[chk-for=onEnable]").is(":checked")){if(ipcIvsRuleDrawFinish)return m.$("#parkingTip").tip("warning",tl("Please draw shape"));var a=r.Config.SizeFilter;o.is(":checked")?isZeroArray(a.MaxSize)?(i.AddShape(5,"","MaxRect",0,-1),m._disabledDraw(!0)):i.SetCurShape("MaxRect"):isZeroArray(a.MinSize)?(i.AddShape(5,"","MinRect",0,-1),m._disabledDraw(!0)):i.SetCurShape("MinRect")}},clearTarget:function(){return ipcIvsRuleDrawFinish?m.$("#parkingTip").tip("warning",tl("Please draw shape")):(o.is(":checked")?r.Config.SizeFilter.MaxSize=[8191,8191]:r.Config.SizeFilter.MinSize=[0,0],void(r.Enable&&(i.SetCurPtzID(0),i.DeleteShape("MaxRect"),i.DeleteShape("MinRect"),u.MaxRect=r.Config.SizeFilter.MaxSize,u.MinRect=r.Config.SizeFilter.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0),i.AddShape(5,"",o.is(":checked")?"MaxRect":"MinRect",0,-1),m._disabledDraw(!0,!0))))},render:function(){i.cover("#car_parkingVideo",function(a){i.SetRegionNum(0),i.SetModuleMode(2),h.chkAuthority("Monitor_01")&&i.open(),a&&m.$("#ipcIntellentCar_refresh1").fireEvent("click")}),i.addEvent("OutPutStringInfo",function(a,b){"OutPutShapeRect"===a?m.outPutShapeRect(b):"OutPutObjectRect"===a&&m.setFilterValue(b)}),ruleNum=0,j.hide(),k.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){q=a,m._renderElements()})},_renderElements:function(){j.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),m._disabledDraw(!1);for(var b in s)s[b]=[];return a.each(q[analyseSenceRuleMap.Normal],function(a,b){s[b.Type]&&s[b.Type].push(b)}),(ruleNum<0||ruleNum>s.ParkingDetection.length-1)&&(ruleNum=0),r=s.ParkingDetection[ruleNum],m._renderRuleList(s.ParkingDetection),r?(setTimeout(function(){if(m._buildRuleJson(),i.SetIVSConfig(videoAnalyseRuleJsonOcx,2),i.SetCurShape(r.Name),m._ruleInitEmpty(),r.Enable){var a=r.Config.SizeFilter;u.MaxRect=a&&a.MaxSize,u.MinRect=a&&a.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0)}i.SetCurShape("save")},500),m._renderRule(),void(r.Config.SizeFilter&&isZeroArray(r.Config.SizeFilter.MaxSize)&&m.disabled("#car_parking_min"))):i.SetIVSConfig("",2)},leave:function(){i.addEvent("OutPutStringInfo",null),i.SetIVSConfig("",2),i.hide()},_getUniqueName:function(b,c,d,e){var f=0,g=[];for(/[^\d]\d{1}$/g.test(b)&&(b=b.substr(0,b.length-1)),a.each(c,function(b,c){a.each(c,function(a,b){"ParkingDetection"===b.Type&&g.push(b.Name)})}),a.each(e,function(a,b){b&&g.push(b.Name)});a.inArray(b+ ++f,g)>=0;);return b+f},_ruleInitEmpty:function(b){m._buildRuleJson();var c=JSON.decode(videoAnalyseRuleJsonOcx).params.table[0][0],d=!1;if(c.Config.DetectLine&&isEmptyRect(c.Config.DetectLine))!b&&i.DeleteShape(c.Name),d=!0;else if(c.Config.DetectRegion&&"array"===a.type(c.Config.DetectRegion)){{c.Config.DetectRegion}d=!d,a.each(c.Config.DetectRegion,function(a,b){(b[0]||b[1])&&(d=!1)}),d&&!b&&i.DeleteShape(c.Name)}return d},_disabledDraw:function(a,b){ipcIvsRuleDrawFinish=a,ipcIvsRuleTargetDrawFinish=b||!1,m.disabled("#car_parking_max, #car_parking_min, #car_parking_ruleInputName",a)},_renderRule:function(){var a=r;m._renderSizeFilter(a.Config.SizeFilter),a.EventHandler&&m.eventHandler.set(a.EventHandler),m.$("[chk-for=onEnable]").attr("checked",a.Enable),a.Config.MinDuration&&n.numberfield("value",a.Config.MinDuration)},_renderSizeFilter:function(b){if(b){a.each(m.$("[data-emptyDraw]").find("input[type=text]"),function(a,c){var d=m.$(c).attr("name").split("-"),e=d[0],f=d[1]-0;m.$(c).val(b[e][f])})}},_renderRuleList:function(b){b=b||[];var c=p.find("tbody"),d='<tr data-index="{index}">                                <td class="num" width="25">{No}</td>                                <td data-name="{index}">                                    <span>{name}</span>                                    <input value="{name}" maxlength="30"/></td>                                <td><span class="ui-button-icon-clear" data-del="{index}"></span></td>                            </tr>',e=[],f=b.length;c.empty(),a.each(b,function(a,b){b&&e.push(d.replace(/{index}/g,a).replace(/{No}/g,a+1).replace(/{name}/g,b.Name))}),c.html(e.join("")),c.find("tr[data-index="+ruleNum+"]").addClass("current"),p.find("[data-add]").toggleClass("disabled",b.length>=4),m.$("[data-emptyDraw]").toggleClass("fn-invisib",!b.length),m.$("[data-emptyReules]").toggleClass("fn-hide",!b.length),m.disabled("[chk-for=onEnable]",f>0?!1:!0),p.find("[data-del]").click(function(a){var b=m.$(a.target).attr("data-del")-0,c=s.ParkingDetection;i.DeleteShape(c[b].Name),c.splice(b,1);var d=c.length;b<ruleNum&&ruleNum--,ruleNum>d-1&&(ruleNum=d-1),ruleNum<0&&(ruleNum=0),s.ParkingDetection=c,m._renderRuleList(c),d>0&&m._changeRule(ruleNum,!0)}),p.find("[data-name]").dblclick(function(){a(this).addClass("edit"),this.getElement("input").select()}),p.find("input").blur(function(b){var c=m.$(b.target).val();if(m.$(b.target).parent().removeClass("edit"),c){a(this).siblings("span").text(c);var d=r.Name;r.Name=c,i.SetCurShape(d),i.SetCurName(c),i.SetCurShape("save")}}),p.find("tr[data-index]").click(function(a){p.find("tr[data-index]").removeClass("current"),m.$(a.target).parents("tr[data-index]").addClass("current");var b=this.getProperty("data-index")-0;m._changeRule(b)})},_buildRuleJson:function(){var a={result:!0,params:{table:[[r]]}};"VideoAbnormalDetection"==r.Type&&(a.params.table[0][0]=null),videoAnalyseRuleJsonOcx=JSON.encode(a)},drawRule:function(){if(m.$("[chk-for=onEnable]").is(":checked")){if(ipcIvsRuleDrawFinish)return m.$("#parkingTip").tip("warning",tl("Please draw shape"));var a=r.Name,b=-1,c=0;if(!m._ruleInitEmpty(!0))return i.SetCurShape(a),void i.SelectRule(a,-1);i.SetCurShape(a),m._disabledDraw(!0),i.AddShape(2,"ParkingDetection",a,b,c)}},clearRule:function(){if(ipcIvsRuleDrawFinish)return m.$("#parkingTip").tip("warning",tl("Please draw shape"));if(r.Config.DetectRegion=[[0,0],[0,0],[0,0],[0,0]],m._buildRuleJson(),i.DeleteShape(r.Name),m.$("[chk-for=onEnable]").is(":checked")){var a=r.Name,b=-1,c=0;m._renderRule(),m._ruleInitEmpty(!0)&&(i.SetCurShape(a),m._disabledDraw(!0),i.AddShape(2,"ParkingDetection",a,b,c))}},_changeRule:function(a,b){b!==!0&&(r=m._saveElements(),s.ParkingDetection[ruleNum]=r),s.ParkingDetection[a]&&(ruleNum=a,m._disabledDraw(!1),r=s.ParkingDetection[ruleNum],m._buildRuleJson(),i.SetIVSConfig(videoAnalyseRuleJsonOcx,2),i.SetCurShape(r.Name),m._ruleInitEmpty(),r.Enable&&(u.MaxRect=r.Config.SizeFilter.MaxSize,u.MinRect=r.Config.SizeFilter.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0)),i.SetCurShape("save"),m._renderRule())},_saveElements:function(){var a=r;if(!a)return a;a.EventHandler;return a.Enable=m.$("[chk-for=onEnable]").is(":checked"),a.Config.MinDuration&&(a.Config.MinDuration=n.numberfield("value")),r.EventHandler=m.eventHandler.get(),r},_ruleRenameTest:function(){var b=[],c=0,d=0,e=null,f=null,g=!1;return a.each(q[analyseSenceRuleMap.Normal],function(e,f){if(!g&&f){var h=f.Name;return a.inArray({Name:h,Type:f.Type},b)>=0?(a.each(b,function(a,b){b.Name==h&&(d=b.Type)}),c=f.Type,g=!0,!0):void b.push({Name:h,Type:f.Type})}}),g&&(e=m._stringShow(d),f=m._stringShow(c),m.$("#parkingTip").tip("warning",tl(e)+" "+tl("w_and")+" "+tl(f)+" "+tl("w_groupNameSame"))),g},_stringShow:function(a){return"CrossLineDetection"==a?a="w_CrossLineDetection":"CrossRegionDetection"==a?a="w_CrossRegionDetection":("LeftDetection"==a||"TakenAwayDetection"==a)&&(a="w_LeftDetectionDis"),a},onSet:function(){r&&r.EventHandler&&r.EventHandler.TimeSection&&(i.hide(),g.open(r.EventHandler.TimeSection).done(function(a){r.EventHandler.TimeSection=a}).always(function(){i.cover("#car_parkingVideo")}))},onDefault:function(){k.ConfigManager.getDefault("VideoAnalyseRule").done(function(a){q=a,m._renderElements(),m.$("#parkingTip").tip("success",tl("Defaultsuccess"))}).fail(function(){m.$("#parkingTip").tip("error",tl("Defaultfailure"))})},onRefresh:function(){k.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){q=a;m._renderElements(),m.$("#parkingTip").tip("success",tl("Operateingsuccess"))}).fail(function(){m.$("#parkingTip").tip("error",tl("Operateingfailure"))})},onConfirm:function(){return ipcIvsRuleTargetDrawFinish?m.$("#parkingTip").tip("warning",tl("Please draw shape")):(ipcIvsRuleDrawFinish&&(ipcIvsRuleDrawFinish=!1,m._disabledDraw(!1)),i.SetCurShape("save"),r=m._saveElements(),r&&ruleNum>=0&&(s.ParkingDetection[ruleNum]=r),a.each(s.ParkingDetection,function(b,c){var d=c,e=!1;a.each(q[analyseSenceRuleMap.Normal],function(a,b){b.Name===d.Name&&(q[analyseSenceRuleMap.Normal][a]=d,e=!0)}),e||q[analyseSenceRuleMap.Normal].push(c)}),a.each(q[analyseSenceRuleMap.Normal],function(b,c){c&&"ParkingDetection"===c.Type&&a.inArray(c,s.ParkingDetection)<0&&q[analyseSenceRuleMap.Normal].splice(b,1)}),void(m._ruleRenameTest()||k.ConfigManager.setConfig("VideoAnalyseRule",q).done(function(){m.$("#parkingTip").tip("success",tl("Succeed in saving configure")),k.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){q=a})}).fail(function(){m.$("#parkingTip").tip("error",tl("Saving failure"))})))},outPutShapeRect:function(a){m._disabledDraw(!1);var b=r.Type,c=JSON.decode(a);"CrossLineDetection"===b?r.Config.DetectLine=c.Config.DetectLine:("RetrogradeDetection"===b&&c.Config.Direction&&(r.Config.Direction=c.Config.Direction),c.Config.DetectRegion.length<3?m._disabledDraw(!0):r.Config.DetectRegion=c.Config.DetectRegion)},setFilterValue:function(a){var b=!1,c=JSON.decode(a),d=r.Config.SizeFilter,e=[1,1];c.MinRect?d.MinSize=c.MinRect:c.MaxRect&&(d.MaxSize=c.MaxRect,e=c.MaxRect),b=isZeroArray(e),m._disabledDraw(b,b)}})}),define("car_retr",function(require,b,c){var d=require("jsCore/modules/eventHandler"),e=require("jsCore/modules/IntellMutex"),f=require("jsCore/ability"),g=require("jsCore/modules/timeSection"),h=require("jsCore/rpcLogin"),i=require("jsCore/plugin"),j=new e("car_retr_mutex");require("widget/js/dui.slider");{var k=require("jsCore/rpc"),l=require("jsCore/pageBase"),m=null,n=null,o=null,p=null,q={},r={},s={},t={},u={MaxRect:[8191,8191],MinRect:[0,0]},v=require("common/common");v.Check}c.exports=l.extend({init:function(){m=this,s.RetrogradeDetection=[],f.get("IVSCaps").done(function(a){var b=e.getIntellMutexTip("ParkingDetection",a||{});b&&(j.add("intell",b),j.setCtrl("intell",!0)),j.add("tvout",'<span t="IntellMutexTVOut">'+tl("IntellMutexTVOut")+"</span>")}),p=m.$("[key=Sensitivity]").slider({min:0,max:100}),m.eventHandler=new d("#car_retr_eventHandler"),n=m.$("#car_retr_ruleManager"),o=m.$("#car_retr_max"),k.ConfigManager.getDefault("VideoAnalyseRule["+analyseSenceRuleMap.Normal+"]").done(function(b){a.each(b,function(a,b){t[b.Type]||(t[b.Type]=b)})}).fail(function(){throw new Error("Could not get the default config: "+defaultConfig+", error: "+text)}),i.cover("#car_retrVideo",function(a){i.SetRegionNum(0),i.SetModuleMode(2),h.chkAuthority("Monitor_01")&&i.open(),a&&m.$("#ipcIntellentCar_refresh1").fireEvent("click")}),i.addEvent("OutPutStringInfo",function(a,b){"OutPutShapeRect"===a?m.outPutShapeRect(b):"OutPutObjectRect"===a&&m.setFilterValue(b)}),m.$("#car_retr_ruleInputName").blur(function(a){var b=m.$(a.target).val();return b?(i.SetCurShape(r.Name),r.Name=b,i.SetCurName(b),void i.SetCurShape("save")):(this.value=r.Name,m.$("#retrTip").tip("warning",tl("w_null_limite")))}),m.$("input[type=radio]").click(function(){if(!m.$("[chk-for=onEnable]").is(":checked")){if(ipcIvsRuleDrawFinish)return m.$("#retrTip").tip("warning",tl("Please draw shape"));if(o.is(":checked"))i.SetCurShape("MaxRect");else if(r&&r.Config){var a=r.Config.SizeFilter.MinSize;(a[0]||a[1])&&i.SetCurShape("MinRect")}}}),n.find("[data-add]").click(function(a){if(!m.$(a.target).hasClass("disabled")){var b=t.RetrogradeDetection,c=s.RetrogradeDetection;if(!b)throw new Error("the rule of RetrogradeDetection has no default config");var d=Object.clone(b),e=["RetrogradeDetection"];d.Name=m._getUniqueName(d.Name,s,e,c),d.Enable=m.$("[chk-for=onEnable]").is(":checked"),c.push(d),m._changeRule(c.length-1,!0),m._renderRuleList(c),m.eventHandler.set(b.EventHandler)}}),m.render()},render:function(){ruleNum=0,k.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){q=a,m._renderElements()})},onEnable:function(b){r.Enable=m.$(b.target).is(":checked"),a.each(s.RetrogradeDetection,function(a,b){b.Enable=r.Enable}),m._disabledDraw(!m.$(b.target).is(":checked")),m.$(b.target).is(":checked")?j.show():j.hide(),m._buildRuleJson(),i.SetIVSConfig(videoAnalyseRuleJsonOcx,2),i.SetCurShape(r.Name),m._ruleInitEmpty(),r.Enable&&(u.MaxRect=r.Config.SizeFilter&&r.Config.SizeFilter.MaxSize,u.MinRect=r.Config.SizeFilter&&r.Config.SizeFilter.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0)),i.SetCurShape("save");var c=r.Config.SizeFilter;c&&isZeroArray(c.MaxSize)&&m.disabled("#car_retr_min")},drawTarget:function(){if(m.$("[chk-for=onEnable]").is(":checked")){if(ipcIvsRuleDrawFinish)return m.$("#retrTip").tip("warning",tl("Please draw shape"));var a=r.Config.SizeFilter;o.is(":checked")?isZeroArray(a.MaxSize)?(i.AddShape(5,"","MaxRect",0,-1),m._disabledDraw(!0)):i.SetCurShape("MaxRect"):isZeroArray(a.MinSize)?(i.AddShape(5,"","MinRect",0,-1),m._disabledDraw(!0)):i.SetCurShape("MinRect")}},clearTarget:function(){return ipcIvsRuleDrawFinish?m.$("#retrTip").tip("warning",tl("Please draw shape")):(o.is(":checked")?r.Config.SizeFilter.MaxSize=[8191,8191]:r.Config.SizeFilter.MinSize=[0,0],void(r.Enable&&(i.SetCurPtzID(0),i.DeleteShape("MaxRect"),i.DeleteShape("MinRect"),u.MaxRect=r.Config.SizeFilter.MaxSize,u.MinRect=r.Config.SizeFilter.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0),i.AddShape(5,"",o.is(":checked")?"MaxRect":"MinRect",0,-1),m._disabledDraw(!0,!0))))},_renderElements:function(){j.hide(),j.setCtrl("tvout",g_videoInConflict.DSP.hasConflict()),m._disabledDraw(!1);for(var b in s)s[b]=[];return a.each(q[analyseSenceRuleMap.Normal],function(a,b){s[b.Type]&&s[b.Type].push(b)}),(ruleNum<0||ruleNum>s.RetrogradeDetection.length-1)&&(ruleNum=0),r=s.RetrogradeDetection[ruleNum],m._renderRuleList(s.RetrogradeDetection),r?(setTimeout(function(){if(m._buildRuleJson(),i.SetIVSConfig(videoAnalyseRuleJsonOcx,2),i.SetCurShape(r.Name),m._ruleInitEmpty(),i.SetCurShape(r.Name+"_dir"),r.Enable){var a=r.Config.SizeFilter;u.MaxRect=a&&a.MaxSize,u.MinRect=a&&a.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0)}i.SetCurShape("save")},500),m._renderRule(),void(r.Config.SizeFilter&&isZeroArray(r.Config.SizeFilter.MaxSize)&&m.disabled("#car_retr_min"))):i.SetIVSConfig("",2)},leave:function(){i.addEvent("OutPutStringInfo",null),i.SetIVSConfig("",2),i.hide()},_getUniqueName:function(b,c,d,e){var f=0,g=[];for(/[^\d]\d{1}$/g.test(b)&&(b=b.substr(0,b.length-1)),a.each(c,function(a,b){"RetrogradeDetection"===b.Type&&g.push(b.Name)}),a.each(e,function(a,b){b&&g.push(b.Name)});a.inArray(b+ ++f,g)>=0;);return b+f},_ruleInitEmpty:function(b){m._buildRuleJson();var c=JSON.decode(videoAnalyseRuleJsonOcx).params.table[0][0],d=!1;if(c.Config.DetectLine&&isEmptyRect(c.Config.DetectLine))b||i.DeleteShape(c.Name),d=!0;else if(c.Config.DetectRegion&&"array"===a.type(c.Config.DetectRegion)){{c.Config.DetectRegion}d=!d,a.each(c.Config.DetectRegion,function(a,b){(b[0]||b[1])&&(d=!1)}),d&&!b&&i.DeleteShape(c.Name)}return d},_disabledDraw:function(a,b){ipcIvsRuleDrawFinish=a,ipcIvsRuleTargetDrawFinish=b||!1,m.disabled("#car_retr_max, #car_retr_min, #car_retr_ruleInputName",a)},_renderRule:function(){var a=r;a.EventHandler&&m.eventHandler.set(a.EventHandler),m.$("[chk-for=onEnable]").attr("checked",a.Enable),a.Config.Sensitivity&&p.slider("value",a.Config.Sensitivity)},_renderRuleList:function(b){b=b||[];var c=n.find("tbody"),d='<tr data-index="{index}">                                <td class="num" width="25">{No}</td>                                <td data-name="{index}">                                    <span>{name}</span>                                    <input value="{name}" maxlength="30"/></td>                                <td><span class="ui-button-icon-clear" data-del="{index}"></span></td>                            </tr>',e=[],f=b.length;c.empty(),a.each(b,function(a,b){b&&e.push(d.replace(/{index}/g,a).replace(/{No}/g,a+1).replace(/{name}/g,b.Name))}),c.html(e.join("")),c.find("tr[data-index="+ruleNum+"]").addClass("current"),n.find("[data-add]").toggleClass("disabled",b.length>=4),m.$("[data-emptyDraw]").toggleClass("fn-invisib",!b.length),m.$("[data-emptyReules]").toggleClass("fn-hide",!b.length),m.disabled("[chk-for=onEnable]",f>0?!1:!0),n.find("[data-del]").click(function(a){var b=m.$(a.target).attr("data-del")-0,c=s.RetrogradeDetection;i.DeleteShape(c[b].Name),c.splice(b,1);var d=c.length;b<ruleNum&&ruleNum--,ruleNum>d-1&&(ruleNum=d-1),ruleNum<0&&(ruleNum=0),m._renderRuleList(c),d>0&&m._changeRule(ruleNum,!0)}),n.find("[data-name]").dblclick(function(a){m.$(a.target).addClass("edit"),this.getElement("input").select()}),n.find("input").blur(function(a){var b=m.$(a.target).val();m.$(a.target).getParent().removeClass("edit"),b&&(this.siblings("span").text(b),r.Name=b,i.SetCurShape(r.Name),i.SetCurName(b),i.SetCurShape("save"))}),n.find("tr[data-index]").click(function(a){n.find("tr[data-index]").removeClass("current"),m.$(a.target).parents("tr[data-index]").addClass("current");this.getProperty("data-index")-0;m._changeRule(m.$(a.target).attr("data-index")-0)})},_buildRuleJson:function(){delete r.EventHandler;var a={result:!0,params:{table:[[r]]}};"VideoAbnormalDetection"==r.Type&&(a.params.table[0][0]=null),videoAnalyseRuleJsonOcx=JSON.encode(a)},drawRule:function(){if(m.$("[chk-for=onEnable]").is(":checked")){if(ipcIvsRuleDrawFinish)return m.$("#retrTip").tip("warning",tl("Please draw shape"));var a=r.Name,b=-1,c=0;if(!m._ruleInitEmpty(!0))return i.SetCurShape(a),void i.SelectRule(a,-1);i.SetCurShape(a),m._disabledDraw(!0),i.AddShape(2,"RetrogradeDetection",a,b,c)}},drawDirection:function(){if(m.$("[chk-for=onEnable]").is(":checked")){if(r.Config&&r.Config.Direction)return i.SetCurShape(r.Name+"_dir"),void i.SelectRule(r.Name+"_dir",-1);var a=r.Name+"_dir",b=(ipcIntellent_ruleType,-1),c=0;i.SetCurShape(a),i.AddShape(2,"RetrogradeDetection",a,b,c)}},clearRule:function(){if(ipcIvsRuleDrawFinish)return m.$("#retrTip").tip("warning",tl("Please draw shape"));if(r.Config.DetectRegion=[[0,0],[0,0],[0,0],[0,0]],m._buildRuleJson(),i.DeleteShape(r.Name),m.$("[chk-for=onEnable]").is(":checked")){var a=r.Name,b=-1,c=0;m._renderRule(),m._ruleInitEmpty(!0)&&(i.SetCurShape(a),m._disabledDraw(!0),i.AddShape(2,"RetrogradeDetection",a,b,c))}},clearDirection:function(){return ipcIvsRuleDrawFinish?m.$("#retrTip").tip("warning",tl("Please draw shape")):(r.Config[ipcIvsRuleType]=[[0,0],[0,0],[0,0],[0,0]],m._buildRuleJson(),i.DeleteShape(r.Name),m._drawRuleType(!0),void m._renderRule())},_changeRule:function(a,b){b!==!0&&(r=m._saveElements(),s.RetrogradeDetection[ruleNum]=r),s.RetrogradeDetection[a]&&(ruleNum=a,m._disabledDraw(!1),r=s.RetrogradeDetection[ruleNum],m._buildRuleJson(),i.SetIVSConfig(videoAnalyseRuleJsonOcx,2),i.SetCurShape(r.Name),m._ruleInitEmpty(),r.Enable&&(u.MaxRect=r.Config.SizeFilter.MaxSize,u.MinRect=r.Config.SizeFilter.MinSize,i.SetObjectConfig(JSON.encode(u)),i.SetCurPtzID(0)),i.SetCurShape("save"),m._renderRule())},_saveElements:function(){var a=r;return a?(a.Enable=m.$("[chk-for=onEnable]").is(":checked"),a.Config.Sensitivity&&(a.Config.Sensitivity=p.slider("value")),r.EventHandler=m.eventHandler.get(),r):a},_ruleRenameTest:function(){var b=[],c=0,d=0,e=null,f=null,g=!1;return a.each(q[analyseSenceRuleMap.Normal],function(e,f){if(!g&&f){var h=f.Name;return a.inArray({Name:h,Type:f.Type},b)>=0?(a.each(b,function(a,b){b.Name==h&&(d=b.Type)}),c=f.Type,g=!0,!0):void b.push({Name:h,Type:f.Type})}}),g&&(e=m._stringShow(d),f=m._stringShow(c),m.$("#retrTip").tip("warning",tl(e)+" "+tl("w_and")+" "+tl(f)+" "+tl("w_groupNameSame"))),g},_stringShow:function(a){return"CrossLineDetection"==a?a="w_CrossLineDetection":"CrossRegionDetection"==a?a="w_CrossRegionDetection":("LeftDetection"==a||"TakenAwayDetection"==a)&&(a="w_LeftDetectionDis"),a},onSet:function(){r&&r.EventHandler&&r.EventHandler.TimeSection&&g.open(r.EventHandler.TimeSection).done(function(a){r.EventHandler.TimeSection=a}).always(function(){i.cover("#car_retrVideo")})},onDefault:function(){k.ConfigManager.getDefault("VideoAnalyseRule").done(function(a){q=a,m._renderElements(),m.$("#retrTip").tip("success",tl("Defaultsuccess"))}).fail(function(){m.$("#retrTip").tip("error",tl("Defaultfailure"))})},onRefresh:function(){k.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){q=a,m._renderElements(),m.$("#retrTip").tip("success",tl("Operateingsuccess"))}).fail(function(){m.$("#retrTip").tip("error",tl("Operateingfailure"))})},onConfirm:function(){return ipcIvsRuleTargetDrawFinish?m.$("#retrTip").tip("warning",tl("Please draw shape")):(ipcIvsRuleDrawFinish&&(ipcIvsRuleDrawFinish=!1,m._disabledDraw(!1)),i.SetCurShape("save"),r=m._saveElements(),r&&ruleNum>=0&&(s.RetrogradeDetection[ruleNum]=r),a.each(s.RetrogradeDetection,function(b,c){var d=c,e=!1;a.each(q[analyseSenceRuleMap.Normal],function(a,b){b.Name===d.Name&&(q[analyseSenceRuleMap.Normal][a]=d,e=!0)}),e||q[analyseSenceRuleMap.Normal].push(c)}),a.each(q[analyseSenceRuleMap.Normal],function(b,c){c&&"RetrogradeDetection"===c.Type&&a.inArray(c,s.RetrogradeDetection)<0&&q[analyseSenceRuleMap.Normal].splice(b,1)}),void(m._ruleRenameTest()||k.ConfigManager.setConfig("VideoAnalyseRule",q).done(function(){m.$("#retrTip").tip("success",tl("Succeed in saving configure")),k.ConfigManager.getConfig("VideoAnalyseRule").done(function(a){q=a})}).fail(function(){m.$("#retrTip").tip("error",tl("Saving failure"))})))},outPutShapeRect:function(a){m._disabledDraw(!1);var b=r.Type,c=JSON.decode(a);"CrossLineDetection"===b?r.Config.DetectLine=c.Config.DetectLine:("RetrogradeDetection"===b&&c.Config.Direction&&(r.Config.Direction=c.Config.Direction),c.Config.DetectRegion.length<3?m._disabledDraw(!0):r.Config.DetectRegion=c.Config.DetectRegion)},setFilterValue:function(a){var b=!1,c=JSON.decode(a),d=r.Config.SizeFilter,e=[1,1];c.MinRect?d.MinSize=c.MinRect:c.MaxRect&&(d.MaxSize=c.MaxRect,e=c.MaxRect),b=isZeroArray(e),m._disabledDraw(b,b)}})})}(jQuery);