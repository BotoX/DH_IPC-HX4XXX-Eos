!function(){function a(a){for(var f=Array.clone(a),g=f.length-1;g>0;g--)for(var h=b(f[g]),i=0;g>i;i++)if(0!=h.type){var j=b(f[i]),k=h.type&j.type;h.type==j.type&&h.startTime<j.endTime&&h.endTime>j.startTime?(f[i]=j.type+" "+d(h.startTime,j.startTime)+"-"+e(h.endTime,j.endTime),f[g]="0 00:00:00-23:59:59"):k==h.type&&j.startTime<=h.startTime&&j.endTime>=h.endTime?f[g]="0 00:00:00-23:59:59":k==j.type&&j.startTime>=h.startTime&&j.endTime<=h.endTime&&(f[i]=f[g],f[g]="0 00:00:00-23:59:59")}return f.sort(c)}function b(a){var b=a.match(g),c=null;return c=b?{type:7&b[1].toInt(),startTime:b[2],endTime:b[3]}:{type:0,startTime:"00:00:00",endTime:"23:59:59"}}function c(a,c){var d=b(a),e=b(c);return d.type>e.type?-1:d.type<e.type?1:d.startTime+d.endTime>e.startTime+e.endTime?1:-1}function d(a,b){return b>a?a:b}function e(a,b){return a>b?a:b}function f(a){return 10>a?"0"+a:a}{var g=/(\d+) (\d\d:\d\d:\d\d)-(\d\d:\d\d:\d\d)/,h=86399;this.Schedule=new Class({Implements:[Events,Options],options:{holiday:!1,type:["general","motion","alarm"],displayMode:["general","motion","alarm"],width:527,height:210},initialize:function(a,b){this.setOptions(b||{}),this.options.holiday&&(this.options.height=240),this.setType(this.options.type),this.element=$(a),this.element.addClass("ui-schedule"),this._addEvent()},render:function(a){if(a){var b=this;b.element.empty(),b.timeSchedules=a,b._fixTimeSchedules(),b.timeSchedules.each(function(a,c){a.each(function(a){var d=a.split(" ")[0],e=a.split(" ")[1];1&d&&b.options.displayMode.contains("general")&&b._addElement("general",e,30*c+1),2&d&&b.options.displayMode.contains("motion")&&b._addElement("motion",e,30*c+11),4&d&&b.options.displayMode.contains("alarm")&&b._addElement("alarm",e,30*c+21)})})}},setType:function(a){var b=0;a.contains("general")&&(b+=1),a.contains("motion")&&(b+=2),a.contains("alarm")&&(b+=4),this.type=b},getTimeSchedules:function(){return this.timeSchedules},setTimeSchedules:function(a){this.timeSchedules=a,this.render(a)},_addEvent:function(){this.element.addEvent("mousedown",this._onMouseDown.bind(this)),document.addEvents({mouseup:this._onMouseUp.bind(this),mousemove:this._onMouseMove.bind(this),contextmenu:this._onContextMenu.bind(this)})},_onMouseDown:function(a){if(!this.mousedown_position){var b=this.element._position||this.element.getPosition(),c=a.page;this.mousedown_position={x:Math.max(c.x-b.x).limit(1,this.options.width+1),y:Math.max(c.y-b.y).limit(1,this.options.height)},this.mousedown_mode=a.target==this.element?"add":"delete",this.mousedown_ele=new Element("div",{"class":"ui-schedule-rect",styles:{background:"add"==this.mousedown_mode?"#444":"#fff"}}),this.element.appendChild(this.mousedown_ele),this.element._position=b,this._preventSelect()}},_onMouseUp:function(a){if(this.mousedown_position){var b=this.element._position,c=a.page,d={x:(c.x-b.x).limit(1,this.options.width+1),y:(c.y-b.y).limit(1,this.options.height)},e=this.mousedown_position,f={left:Math.min(d.x,e.x),top:Math.min(d.y,e.y),width:Math.abs(d.x-e.x),height:Math.abs(d.y-e.y)};this.mousedown_position=null,this.element.removeChild(this.mousedown_ele),this._afterDraw(f),this._releaseSelect()}},_onMouseMove:function(a){if(this.mousedown_position){var b=this.element._position,c=a.page,d={x:(c.x-b.x).limit(1,this.options.width+1),y:(c.y-b.y).limit(1,this.options.height)},e=this.mousedown_position,f={left:Math.min(d.x,e.x),top:Math.min(d.y,e.y),width:Math.abs(d.x-e.x),height:Math.abs(d.y-e.y)};this.mousedown_ele&&this.mousedown_ele.setStyles(f),a.stop()}},_onContextMenu:function(a){var b=a.target.className;return"string"==typeOf(b)&&b.contains("ui-schedule")?!1:void 0},_afterDraw:function(a){"add"==this.mousedown_mode?a.width&&this._addTimeSection(a):this._removeTimeSection(a)},_addTimeSection:function(a){var c=this,d=this._rectToTimeObj(a);c.timeSchedules.each(function(e,f){if(a.top<30*(f+1)&&a.top+a.height>30*f){for(var g=0,h=e.length;h>g;g++){var i=b(e[g]);if((7&i.type)==c.type&&i.endTime>d.startTime&&i.startTime<d.endTime)return void(e[g]=i.type+" "+(d.startTime<i.startTime?d.startTime:i.startTime)+"-"+(d.endTime>i.endTime?d.endTime:i.endTime));if(i.type&&(c.type&i.type)==i.type&&i.startTime>=d.startTime&&i.endTime<=d.endTime)return void(e[g]=c.type+" "+d.startTime+"-"+d.endTime)}for(var g=0,h=e.length;h>g;g++){var j=e[g].split(" ")[0].toInt();if(!(7&j))return void(e[g]=(j|c.type)+" "+d.startTime+"-"+d.endTime)}}}),this.render(this.timeSchedules),this.fireEvent("change",Object.clone(this.timeSchedules))},_removeTimeSection:function(a){var c=this,d=this._rectToTimeObj(a);c.timeSchedules.each(function(e,f){a.top<30*(f+1)&&a.top+a.height>30*f&&e.each(function(a,f){var g=b(a);if(g.endTime>d.startTime&&g.startTime<d.endTime){var h=b(e[f]);1&c.type&&(h.type=65534&h.type),2&c.type&&(h.type=65533&h.type),4&c.type&&(h.type=65531&h.type),e[f]=7&h.type?h.type+" "+h.startTime+"-"+h.endTime:"0 00:00:00-23:59:59"}})}),this.render(this.timeSchedules),this.fireEvent("change",Object.clone(this.timeSchedules))},_addElement:function(a,b,c){var d=this._timeToRect(b),e=new Element("div",{"class":"ui-schedule-"+a,styles:{left:d.left,width:d.width,top:c}});this.element.appendChild(e)},_timeToRect:function(a){var b=a.split("-")[0],c=a.split("-")[1],d=this._timeToPoint(b),e=this._timeToPoint(c)-d;return{left:d,width:e}},_rectToTimeObj:function(a){return{startTime:this._pointToTime(a.left),endTime:this._pointToTime(a.left+a.width)}},_timeToPoint:function(a){var b=a.split(":").map(function(a){return a.toInt()});return(3600*b[0]+60*b[1]+b[2])/h*this.options.width+1},_pointToTime:function(a){var b=(a-1)/this.options.width*h,c=(b/3600).toInt(),d=((b-3600*c)/60).toInt(),e=(b%60).toInt();return f(c)+":"+f(d)+":"+f(e)},_fixTimeSchedules:function(){var b=this;b.timeSchedules.each(function(c,d){b.timeSchedules[d]=a(c)})},_preventSelect:function(){if(document.selection&&document.selection.empty)try{document.selection.empty()}catch(a){}window.getSelection&&window.getSelection().removeAllRanges(),Browser.ie&&Browser.version>8?$(document.body).addClass("fn-unselectable"):($(document.body).setAttribute("onselectstart","javascript:return false;"),$(document.body).setAttribute("unselectable","on"),$(document.body).addClass("fn-unselectable"))},_releaseSelect:function(){$(document.body).removeAttribute("onselectstart"),$(document.body).removeAttribute("unselectable"),$(document.body).removeClass("fn-unselectable")}})}}();