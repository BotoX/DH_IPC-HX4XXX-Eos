!function(a){define(function(require,b,c){function d(b,c){var d=this;d.options=a.extend({},j,c),d.e=a(b).empty().append(i).translation(),d.init()}function e(){var b=0;return a.when(g.get("LensControl"),g.get("LensControlMix"),g.get("smallPtz"),g.get("VideoInFocusMode")).then(function(a,c,d,e){return b=a&&a.Support?2:d&&d.Support?4:c&&c.Support?3:webApp.CHANNEL_NUMBER>1&&-1===webApp.DeviceType.indexOf("SD")?1:webApp.CHANNEL_NUMBER>1&&-1!==webApp.DeviceType.indexOf("SD")?5:1===webApp.CHANNEL_NUMBER&&-1!==webApp.DeviceType.indexOf("SD")?6:e&&e.Support&&-1!==webApp.DeviceType.indexOf("TPC-AEBF5X00")?7:0})}var f=require("../plugin"),g=require("../ability"),h=require("../rpc"),i=require("./ptzControl.html");require("widget/js/dui.drag");var j={ptzJoystick:!0,autoFocus:!1,isLaserDistMeasure:!1,isPtzLocate:!0,channel:0,showDirction:!0,showStep:!0,showAdjust:!0,title:!1};a.fn.ptzControl=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],e=this;return this.each(function(){var f=a(this),g=f.data("ptzControl");if(g||f.data("ptzControl",g=new d(f,b)),"string"===a.type(b)&&a.isFunction(g[b])){var h=g[b].apply(g,c);if(void 0!==h)return e=h,!1}}),e},d.prototype.init=function(){function b(b){var c=b?k.pop():k.shift();c&&(j=c,h.PTZ.start(c.dir,c.step,-1!==a.inArray(c.dir,d)?c.step:0,0))}var c=this,d=["LeftUp","RightUp","LeftDown","RightDown"],i=null,j=null,k=[];c.options.ptzJoystick||c.$("[data-for=ptz_joystick]").remove(),c.options.isPtzLocate?c.$("#ptz_locate").on("click",function(){f.activePTZLocate(c.$("#ptz_locate"))}):(c.$("#ptz_locate").attr("title",""),c.$("#ptz_locate").find("i").removeClass("ui-ptz-icon-center").addClass("ui-ptz-icon-null"),c.$("#ptz_locate").addClass("ptzLocateDisabled")),c.options.showDirction||c.$("#ptz_control_direction").remove(),c.options.showStep||c.$("#ptz_control_step").remove(),c.options.showAdjust||c.$("#ptz_control_adjust").remove(),c.options.title&&c.$('[data-for="ptz_control"]').text(tl("w_zoomFocus")),e().done(function(a){c.type=a}),c.$(".u-tab").tab({click:function(a,b){-1!==webApp.DeviceType.indexOf("TPC")&&"ptz_joystick"===b.name?c.$("#ptzControlStep").hide():c.$("#ptzControlStep").show()}}),c.drager=c.$(".vR-area").drag({position:"center",dragElements:".vR-control",distance:35,autoReset:!0,start:function(){i=setInterval(b,500)},drag:function(b,d){a.browser.ie7?(c.$(".vR-control").css("cursor","move"),c.drager.css("cursor","pointer")):(c.$(".vR-control").css("cursor","none"),c.drager.css("cursor","none"));var e=d.position.x-d.firstPosition.x,f=d.firstPosition.y-d.position.y,g=Math.round(4*Math.atan2(f,e)/Math.PI)+3,h=["LeftDown","Down","RightDown","Right","RightUp","Up","LeftUp","Left"],i=parseInt(Math.round(Math.sqrt(Math.pow(Math.abs(e),2)+Math.pow(Math.abs(f),2)))/5)+1;-1===g&&(g=7);var j=h[g],l=k[k.length-1];l&&l.dir===j&&l.step===i||k.push({dir:j,step:i})},stop:function(){if(c.$(".vR-control").css("cursor","pointer"),c.drager.css("cursor","auto"),null===j&&k.length&&b(!0),j){var e=j.dir,f=j.step;setTimeout(function(){h.PTZ.stop(e,f,-1!==a.inArray(e,d)?f:0,0)},450)}clearInterval(i),i=null,j=null,k.length=0}}),c.$(".vR-control").on("mousewheel",function(a,b){var d=b>0?"ZoomTele":"ZoomWide",e=c.$("#ptz_step").val()-0;h.PTZ.start(d,e,0,0),setTimeout(function(){h.PTZ.stop(d,e,0,0)},450)}),c.$("a[cmd]").on("mousedown",function(b){var d=c.$(b.currentTarget),e=c.$("#ptz_step").val()-0,g=0,i=d.attr("cmd"),j=!0,k=0,l=0,m=!1,n=a("#main ul").find('[data-for="preview"]').hasClass("current")&&(1===c.type||7===c.type);if(-1!==a.inArray(i,["LeftUp","RightUp","LeftDown","RightDown"])&&(g=e),-1===a.inArray(i,["ZoomWide","ZoomTele","FocusFar","FocusNear"])||!n&&2!==c.type&&(3!==c.type&&4!==c.type||1!==f.windowId))if(-1!==a.inArray(i,["IrisSmall","IrisLarge"])&&n){var o=-1;"IrisLarge"===i&&(o=1);var p=h.DevVideoInput.adjustIris(o,f.windowId)}else var p=h.PTZ.start(i,e,g,0);else{switch(j=!1,m=!1,i){case"ZoomWide":l=-1,k=-.5;break;case"ZoomTele":l=-1,k=.5;break;case"FocusFar":l=-.5,k=-1;break;case"FocusNear":l=.5,k=-1;break;default:l=-1,k=-1}if(4===c.type||n)var p=h.DevVideoInput.adjustFocusContinuously(l,k,f.windowId);else setTimeout(function(){if(j){var a=h.DevVideoInput.adjustFocus(l,k,f.windowId);a.done(function(){var a=-1===l?-1:0,b=-1===k?-1:0;h.DevVideoInput.adjustFocus(a,b,f.windowId)}),m=!0}else{var a=h.DevVideoInput.adjustFocusContinuously(l,k,f.windowId);m=!0}},200)}d.on("mouseup mouseout",function(){if(j=!0,d.off("mouseup mouseout"),-1!==a.inArray(i,["ZoomWide","ZoomTele","FocusFar","FocusNear"])&&(n||2===c.type||(3===c.type||4===c.type)&&1===f.windowId)){var b=-1===l?-1:0,o=-1===k?-1:0;return void(4===c.type||n?h.DevVideoInput.adjustFocusContinuously(b,o,f.windowId):m&&h.DevVideoInput.adjustFocusContinuously(b,o,f.windowId))}return-1!==a.inArray(i,["IrisSmall","IrisLarge"])&&n?void h.DevVideoInput.adjustIris(0,f.windowId):void p.done(function(){h.PTZ.stop(i,e,g,0)})})}),g.get("PTZCaps").done(function(a){a&&(a.Zoom===!1&&c.$("#ptz_zoom_wrap").remove(),a.Focus===!1&&c.$("#ptz_focus_wrap").remove(),a.Iris===!1&&c.$("#ptz_iris_wrap").remove(),1===c.type&&f.windowId?c.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_iris_wrap").hide():c.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_iris_wrap").show())}),7===c.type&&c.$("#ptz_zoom_wrap, #ptz_iris_wrap").remove(),c.options.autoFocus?(3===c.type||4===c.type)&&f.windowId||2===c.type||7===c.type?c.$("#ptz_autofocus_wrap").show():c.$("#ptz_autofocus_wrap").hide():c.$("#ptz_autofocus_wrap").remove(),c.$("#ptz_autofocus_wrap a").on("click",function(){h.DevVideoInput.autoFocus(f.windowId)})},d.prototype.$=function(a){return this.e.find(a)},d.prototype.changeChannel=function(a){var b=this;1!==b.type&&5!==b.type||!a?b.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_iris_wrap").show():b.$("#ptz_zoom_wrap, #ptz_focus_wrap, #ptz_iris_wrap").hide(),(3===b.type||4===b.type)&&a||2===b.type||7===b.type?b.$("#ptz_autofocus_wrap").show():b.$("#ptz_autofocus_wrap").hide()},c.exports=d})}(jQuery);