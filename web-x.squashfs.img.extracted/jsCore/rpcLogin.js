!function(a){define(function(require,b,c){function d(){return f.Global.keepAlive().done(function(){m=0}).fail(function(){5===++m?(alert(tl("The connection is Overtime.")),plugin.Reload()):i.login(l.username,l.password,l.logintype).done(function(){app.fireEvent("RECONNECTION")})})}function e(){var a=null;return a="LDAP"===l.logintype||"ActiveDirectory"===l.logintype?f.UserManager.getAuthorityList().done(function(a){k.AuthorityList=a}):f.UserManager.getUserInfo(l.username).done(function(a){a&&(k=a)}),a.fail(function(){throw new Error("Could not get the user info!")})}var f=require("jsCore/rpc"),g=require("jsCore/ability"),h=require("common/common"),i=(h.Cookie,c.exports={}),j=null,k={},l={},m=0,n=null;i.login=function(b,c,g){return l.logintype=g||"Direct",l.username=b,l.password=c,a.Deferred(function(g){f.Global.firstLogin(b,{loginType:l.logintype}).always(function(h){j=h.params,h&&h.error&&(268632079===h.error.code||401===h.error.code)?("WatchNet"===j.encryption&&(l.logintype="WatchNet"),f.Global.secondLogin(b,i.getAuth(b,c),{loginType:l.logintype,authorityType:j.encryption}).done(function(){a.when(webApp.getGlobalConfigs(),e()).done(g.resolve),clearInterval(n),n=setInterval(d,6e4)}).fail(function(a){if(!(a&&a.params&&a.params.error)&&a&&a.error&&a.error.code)g.reject(a&&a.error&&a.error.code);else{var b=a&&a.params&&a.params.error;"UserNotValidt"===b?g.reject(268632070):"PasswordNotValid"===b?g.reject(268632071):"InBlackList"===b?g.reject(268632073):"HasBeedUsed"===b?g.reject(268632074):"HasBeenLocked"===b?g.reject(268632081):g.reject()}})):h&&h.error&&400===h.error.code?g.reject(268632070):h&&h.error&&486===h.error.code?g.reject(268632075):g.reject()})}).promise()},i.logout=function(){return clearInterval(n),n=null,g.clear(),f.Global.logout(!!(a.browser.ie&&a.browser.version<=7))},i.getAuth=function(a,b,c){switch(c=c||j.encryption){case"Basic":return Base64.encode(a+":"+b);case"Default":return hex_md5(a+":"+j.random+":"+hex_md5(a+":"+j.realm+":"+b));default:return b}},i.chkAuthority=function(b){return a.isArray(k.AuthorityList)?-1!==a.inArray(b,k.AuthorityList):!1},i.getAuthority=function(){return k.AuthorityList},i.needModifyPsw=function(){return"1970-1-1 00:00:00"===k.PasswordModifiedTime},i.getLoginInfo=function(){return l}})}(jQuery);